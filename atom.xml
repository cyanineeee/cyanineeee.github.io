<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <id>http://localhost:4000</id>
    <title>cyanine</title>
    <updated>2024-08-14T10:47:05.037Z</updated>
    <generator>https://github.com/jpmonette/feed</generator>
    <link rel="alternate" href="http://localhost:4000"/>
    <link rel="self" href="http://localhost:4000/atom.xml"/>
    <subtitle>my personal blog</subtitle>
    <logo>http://localhost:4000/images/avatar.png</logo>
    <icon>http://localhost:4000/favicon.ico</icon>
    <rights>All rights reserved 2024, cyanine</rights>
    <entry>
        <title type="html"><![CDATA[uwsgi - djangoéƒ¨ç½²]]></title>
        <id>http://localhost:4000/post/uwsgi-django-bu-shu/</id>
        <link href="http://localhost:4000/post/uwsgi-django-bu-shu/">
        </link>
        <updated>2023-07-04T11:18:13.000Z</updated>
        <content type="html"><![CDATA[<h2 id="ä»¥ä¸€ä¸ªæœ€åŸºç¡€çš„åˆå§‹django-é¡¹ç›®ä¸ºä¾‹ä¸æ¶‰åŠæ•°æ®åº“">ä»¥ä¸€ä¸ªæœ€åŸºç¡€çš„åˆå§‹django é¡¹ç›®ä¸ºä¾‹ï¼ˆä¸æ¶‰åŠæ•°æ®åº“ï¼‰</h2>
<ol>
<li>å°†djangoé¡¹ç›®çš„ç¯å¢ƒæ‰“åŒ…æˆrequirements.txt</li>
<li>è´­ä¹°ä¸€ä¸ªæœåŠ¡å™¨</li>
<li>å°†æœåŠ¡å™¨å®‰å…¨ç»„è®¾ç½® è®¾ç½®å…¥ç«™è§„åˆ™å…¨å¼€</li>
<li>é…ç½®pythonç¯å¢ƒ
<ul>
<li>æœ¬äººä½¿ç”¨çš„æ˜¯ubuntu 20.04 è‡ªå¸¦python 3.8</li>
<li>é¦–å…ˆå®‰è£…pip - æ³¨ï¼šå¦‚æœ<code>E: Package 'python3.10-venv' has no installation candidate</code>è¯´æ˜ä½ åº”è¯¥æ›´æ–°ä¸€ä¸‹ç³»ç»Ÿçš„å¯å®‰è£…è½¯ä»¶åˆ—è¡¨<code>apt-get update</code></li>
<li>ç„¶åå®‰è£…virtualenv</li>
<li>ç„¶åcdåˆ°æƒ³è¦çš„ç›®å½•ä¸‹ åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ</li>
<li>cdåˆ°åˆšåˆ›å»ºçš„è™šæ‹Ÿç¯å¢ƒç›®å½•ä¸‹çš„binæ–‡ä»¶å¤¹å†… source activateå¯åŠ¨ç¯å¢ƒ</li>
</ul>
</li>
<li>é…ç½®é¡¹ç›®ç¯å¢ƒ
<ul>
<li>cdåˆ°é¡¹ç›®æ ¹ç›®å½• æ‰§è¡Œpip install -r requirements.txt ï¼ˆä¸€å®šè¦åœ¨ä¸Šä¸€æ­¥å¯åŠ¨è™šæ‹Ÿç¯å¢ƒä¹‹ååœ¨è¿›è¡Œç¯å¢ƒé…ç½®ï¼‰</li>
<li>è¿è¡Œç»“æŸå³å¯</li>
</ul>
</li>
<li>å®‰è£…uwsgi
<ul>
<li>pip install uwsgiå³å¯</li>
</ul>
</li>
<li>é…ç½®uwsgi.iniæ–‡ä»¶ - åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸­çš„åŒåç›®å½•ä¸‹ï¼ˆå°±æ˜¯ä¸ªé»˜è®¤wsgi.pyæ–‡ä»¶åŒä¸€ä¸ªæ–‡ä»¶å¤¹ä¸‹ï¼‰</li>
</ol>
<pre><code class="language-ini">[uwsgi]
http=0.0.0.0:8000 #è®¾ç½®ä¸º0.0.0.0è¡¨ç¤ºå¤–ç½‘å¯ä»¥è®¿é—® 127.0.0.1è¡¨ç¤ºæœ¬æœºè®¿é—®
chdir=/my/mysite  #é¡¹ç›®æ ¹ç›®å½•
wsgi-file=mysite/wsgi.py   #é¡¹ç›®æ ¹ç›®å½•é‡Œé¢çš„åŒåæ–‡ä»¶å†…çš„wsgi.pyæ–‡ä»¶
process=2 #å¯åŠ¨è¿›ç¨‹æ•° è·ŸæœåŠ¡å™¨cpuæœ‰å…³
threads=2 #çº¿ç¨‹æ•° 
pidfile=uwsgi.pid  #å‚¨å­˜è¿›ç¨‹çš„pid ä»¥ä¾¿äºåé¢åœæ­¢è¿è¡Œ
daemonize=uwsgi.log #æ—¥å¿—æ–‡ä»¶
master=true  #ä¸»è¿›ç¨‹å¯åŠ¨
</code></pre>
<ol start="8">
<li>ç„¶åcdè¿›å…¥åˆ°uwsgi.iniåŒçº§å†…
<ul>
<li>æ‰§è¡Œuwsgi --ini uwsgi.ini å¯åŠ¨</li>
<li>æ­¤æ—¶å°±èƒ½é€šè¿‡å…¬ç½‘ip+ç«¯å£è®¿é—®åˆ°djanoæœåŠ¡äº†</li>
</ul>
</li>
<li>åœæ­¢æœåŠ¡
<ul>
<li>uwsgi --stop uwsgi.pidè¿›å…¥åˆ°uwsgi.iniåŒçº§æ–‡ä»¶å¤¹è¿è¡Œå³å¯<br>
PS. ä½¿ç”¨å‘½ä»¤ ps aux|grep 'uwsgi'å¯ä»¥æŸ¥çœ‹æœåŠ¡æ˜¯å¦å¯åŠ¨ï¼Œå‡ºç°å¦‚ä¸‹è¡¨ç¤ºæ­£å¸¸ï¼š</li>
</ul>
</li>
</ol>
<pre><code>root       84204  1.0  3.8  47520 36724 ?        S    11:07   0:00 uwsgi --ini uwsgi.ini
root       84206  0.0  3.0 121252 29816 ?        Sl   11:07   0:00 uwsgi --ini uwsgi.ini
root       84207  0.0  2.7  47520 26280 ?        S    11:07   0:00 uwsgi --ini uwsgi.ini
root       84250  0.0  0.0   6432   720 pts/0    S+   11:08   0:00 grep --color=auto uwsgi
</code></pre>
<h3 id="10-å½»åº•å…³é—­uwsgiè¿›ç¨‹">10. å½»åº•å…³é—­uwsgiè¿›ç¨‹</h3>
<p>å¦‚æœæ²¡æœ‰è®¾ç½®åœæ­¢çš„pidæˆ–è€…å¯åŠ¨å¤±è´¥å¯¼è‡´pidç”Ÿæˆå¤±è´¥ï¼Œè¿™æ ·å°±ä¼šå¯¼è‡´æœ‰uwgsiè¿›ç¨‹æŒ‚åœ¨åå°ï¼Œå› æ­¤éœ€è¦å½»åº•å…³é—­ï¼š<code>pkill -f uwsgi -9</code></p>
<p>PS.</p>
<ul>
<li>å¦‚æœuwsgiæ—¥å¿—æŠ¥é”™ï¼š<code>uwsgi invalid request block size: 4937 (max 4096)...skip</code><br>
ä»£è¡¨è¯·æ±‚è¿‡å¤§ï¼ˆè¶…è¿‡é»˜è®¤4kï¼‰å› æ­¤è·³è¿‡<br>
å› æ­¤åªè¦å°†è¯·æ±‚æ¥æ”¶çš„å€¼æ–¹æ³•å³å¯ï¼šåœ¨uwsgi.iniæ–‡ä»¶æ·»åŠ <code>buffer-size = 65536</code> å³å¯ã€‚</li>
<li>è¿™æ ·éƒ¨ç½²ä¹‹åï¼Œç½‘ç«™æ˜¯è¯·æ±‚ä¸åˆ°é™æ€æ–‡ä»¶çš„ï¼ˆcss,js,å›¾ç‰‡ç­‰ï¼‰æ‰€ä»¥éœ€è¦å†æ­é…nginxè¿›è¡Œé™æ€æ–‡ä»¶è¯·æ±‚çš„å¤„ç†ã€‚</li>
</ul>
<h2 id="uwsgiå¸¸è§æŠ¥é”™">uwsgiå¸¸è§æŠ¥é”™</h2>
<ul>
<li>
<p>1.å¯åŠ¨å¤±è´¥ï¼š ç«¯å£è¢«å ç”¨<br>
è§£å†³æ–¹æ³•ï¼š æ›´æ¢ç«¯å£/åœæ­¢å ç”¨ç«¯å£çš„è¿›ç¨‹<br>
<code>sudo lsof -i:ç«¯å£å·</code> - æŸ¥çœ‹ç«¯å£  <code>kill -9 ç«¯å£å·</code> - åœæ­¢ç«¯å£è¿›ç¨‹</p>
</li>
<li>
<p>2.åœæ­¢å¤±è´¥ stopæ— æ³•å…³é—­uwsgi<br>
åŸå› ï¼š é‡å¤å¯åŠ¨uwsgiå¯¼è‡´uwsgi.pidä¸­è¿›ç¨‹å·å¤±æ•ˆ<br>
è§£å†³æ–¹æ³• ï¼š ps å‡ºuwsgiè¿›ç¨‹ï¼Œæ‰‹åŠ¨kill</p>
</li>
<li>
<ol start="3">
<li>å¯åŠ¨å¤±è´¥ æ‰¾ä¸åˆ°é…ç½®æ–‡ä»¶<br>
å¤§æ¦‚ç‡uwsgi.iniä¸­çš„chdirå’Œwsgiä¸¤ä¸ªå‚æ•°çš„åœ°å€é…ç½®é”™è¯¯<br>
è§£å†³æ–¹æ³•ï¼šä¿®å¤å³å¯ï¼Œæ³¨æ„chdiræ˜¯é¡¹ç›®ç»å¯¹è·¯å¾„ï¼Œwsgiæ˜¯<code>wsgi.py</code>æ–‡ä»¶çš„ç›¸å¯¹äºé¡¹ç›®æ ¹ç›®å½•çš„è·¯å¾„</li>
</ol>
</li>
<li>
<p>å®‰è£…uwsgiæŠ¥é”™<code>ERROR: Failed building wheel for uwsgi</code><br>
æœç´¢è§£å†³æ–¹æ³•ï¼šæ›´æ–°pipå³å¯ -  æ›´æ–°ç³»ç»Ÿä¾èµ– - å®‰è£…psycopg2-binary -<br>
éƒ½æ²¡æœ‰ç”¨<br>
æœ€åï¼š<code>apt-get install build-essential python3-dev</code>ç„¶åpipå³å¯<br>
<a href="https://stackoverflow.com/questions/44037637/error-installing-uwsgi-in-virtualenv">stackoverflow</a></p>
</li>
<li>
<ol start="4">
<li>ä¿®æ”¹é¡¹ç›®åå†ä½¿ç”¨uwsgiå¯åŠ¨æŠ¥é”™</li>
</ol>
</li>
</ul>
<pre><code class="language-python">    raise ImproperlyConfigured(
django.core.exceptions.ImproperlyConfigured: The app module &lt;module 'cyanine' (namespace)&gt; has multiple filesystem locations (['/my/imsys/./cyanine', '/my/imsys/cyanine']); you must configure this app with an AppConfig subclass with a 'path' class attribute.
</code></pre>
<p>åŸå› ï¼šæ²¡æœ‰æ­£ç¡®è®¾ç½®appï¼Œå› ä¸ºæƒ³è¦æ·»åŠ ä¸€ä¸ªå±•ç¤ºé¡µé¢ä½œä¸ºé¡¹ç›®çš„indexï¼Œæ‰€ä»¥å°±ç›´æ¥å°†è¿™ä¸ªhtmlæ–‡ä»¶ä»¥åŠé™„å¸¦çš„é™æ€æ–‡ä»¶ä¸€è‚¡è„‘åœ°æ”¾åœ¨ä¸€ä¸ªæ–‡ä»¶å¤¹é‡Œé¢ç„¶åæ·»åŠ åˆ°é¡¹ç›®ä¸­ï¼Œè¿˜åœ¨settingä¸­æ³¨å†Œäº†appåå­—ï¼Œä½†æ˜¯å®é™…ä¸Šè¿™ä¸ªappé‡Œé¢ç¼ºå°‘å¯¹åº”çš„é…ç½®æ–‡ä»¶ï¼Œè¿™å°±å¼€å‘æ¨¡å¼ä¸‹èƒ½å¤Ÿå‡­å€Ÿæ–‡ä»¶è·¯å¾„è¿è¡Œæ­£ç¡®ï¼Œä½†ç”Ÿäº§æ¨¡å¼éƒ¨ç½²çš„æ—¶å€™å°±å¯¼è‡´uwgisè¿è¡Œçš„æ—¶å€™æ‰¾ä¸åˆ°æ–‡ä»¶è·¯å¾„æŠ¥é”™ã€‚<br>
å› æ­¤ï¼Œå¯¹äºdjangoçš„appæ¥è¯´ï¼Œéœ€è¦æœ‰ä¸¤ä¸ªæ–‡ä»¶ï¼š<code>__init.py__</code>å’Œ<code>apps.py</code>æ–‡ä»¶ï¼Œå…¶ä¸­<code>apps.py</code>ä¸­å†…å®¹ä¸º</p>
<pre><code class="language-python">from django.apps import AppConfig
class PollsConfig(AppConfig):
    default_auto_field = &quot;django.db.models.BigAutoField&quot;
    name = &quot;ä½ æ³¨å†Œåœ¨settingä¸­çš„appåå­—&quot;
</code></pre>
<h3 id=""></h3>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[nginx -- å­¦ä¹  -- + uwsgiéƒ¨ç½²djangoé¡¹ç›®]]></title>
        <id>http://localhost:4000/post/nginx-xue-xi/</id>
        <link href="http://localhost:4000/post/nginx-xue-xi/">
        </link>
        <updated>2023-07-04T09:36:46.000Z</updated>
        <content type="html"><![CDATA[<ul>
<li><a href="https://www.bilibili.com/video/BV1F5411J7vK/?spm_id_from=333.337.search-card.all.click&amp;vd_source=c66937bc5207a56bafe7811cb2b0c4da">æ•™ç¨‹-8.04å¼€å§‹</a></li>
</ul>
<h3 id="1-ä»€ä¹ˆæ˜¯nginx">1. ä»€ä¹ˆæ˜¯nginx</h3>
<ul>
<li>è½»é‡çº§çš„é«˜æ€§èƒ½3webæœåŠ¡å™¨ï¼Œæä¾›äº†httpä»£ç†å’Œåå‘ä»£ç†ã€è´Ÿè½½å‡è¡¡ï¼Œä½¿ç”¨cè¯­è¨€ç¼–å†™ï¼Œæ•ˆç‡æé«˜ã€‚</li>
<li>ä¸€èˆ¬ä½¿ç”¨uwsgiåè®®è®©nginxè½¬å‘æ¥æ”¶åˆ°çš„httpåè®®ç»™uWSGIï¼ˆuwsgiåè®®æ˜¯äºŒè¿›åˆ¶ï¼Œæ•ˆç‡æ›´é«˜ï¼‰</li>
</ul>
<h3 id="2-å®‰è£…nginx">2. å®‰è£…nginx</h3>
<p><code>sudo apt install nginx</code><br>
å®‰è£…æˆåŠŸä¹‹åè¾“å…¥<code>nginx -v</code>æŸ¥çœ‹ç‰ˆæœ¬ã€‚<br>
PS. nginxå®‰è£…ä¹‹åä¼šé»˜è®¤å ç”¨80ç«¯å£</p>
<h3 id="3-é…ç½®nginx">3. é…ç½®nginx</h3>
<p><code>/etc/nginx/site-enabled/default</code>æ˜¯nginxçš„é…ç½®æ–‡ä»¶<br>
æ ¸å¿ƒå‚æ•°</p>
<ul>
<li>location / æœ‰ç‚¹åƒè·¯ç”± è¡¨ç¤ºæ‰€æœ‰è¿™ä¸ªè·¯ç”±çš„è¯·æ±‚éƒ½ç”±ä¸‹é¢çš„å‚æ•°ä»£è¡¨çš„æœåŠ¡å¤„ç†</li>
<li>uwsgi_pass å°†æœåŠ¡ä»¥uwsgiä¼ é€’ç»™***åœ°å€ï¼ˆä¾‹å¦‚127.0.0.1:8000ï¼‰</li>
<li>include é…ç½®å‚æ•° å¦‚æœéœ€è¦ä½¿ç”¨uwsgiåè®®éœ€è¦å†™ <code>/etc/nginx/uwsgi_params</code></li>
</ul>
<h3 id="4-å¯åŠ¨åœæ­¢nginx">4. å¯åŠ¨/åœæ­¢nginx</h3>
<p><code>sudo /etc/init.d/nginx start|stop|restart|status</code> åˆ†åˆ«ä»£è¡¨å¯åŠ¨|åœæ­¢|é‡å¯|æŸ¥çœ‹çŠ¶æ€<br>
PS. nginxåªè¦ä¿®æ”¹å°±éœ€è¦é‡å¯ï¼Œå¦åˆ™é…ç½®ä¸ç”Ÿæ•ˆ</p>
<h3 id="5-ä¿®æ”¹uwsgié…ç½®æ–‡ä»¶é€‚é…nginxä¿®æ”¹nginxé€‚é…uwsgiå¯åŠ¨">5. ä¿®æ”¹uwsgié…ç½®æ–‡ä»¶ï¼Œé€‚é…nginxï¼Œä¿®æ”¹nginxï¼Œé€‚é…uwsgiå¯åŠ¨</h3>
<p>å…·ä½“å¦‚ä¸‹ï¼š</p>
<pre><code class="language-vim">#defaultæ–‡ä»¶
                # try_files $uri $uri/ =404; #æ³¨é‡Šæ‰è¿™ä¸€å¥
                uwsgi_pass 127.0.0.1:8000;  #æ·»åŠ è¿™ä¸¤å¥
                include /etc/nginx/uwsgi_params;
</code></pre>
<pre><code>#uwsgi.ini
#å»æ‰http ä¿®æ”¹ä¸º socket
socket = 127.0.0.1:8000 #è¿™ä¸ªç«¯å£å·è¦å’Œnginxçš„ä¸€è‡´

</code></pre>
<p>PS. <code>sudo nginx -t</code>å¯ä»¥å¿«é€Ÿæ–¹ä¾¿çš„å‘Šè¯‰ä½ é…ç½®æ–‡ä»¶æ˜¯å¦æœ‰è¯­æ³•é”™è¯¯</p>
<h3 id="6-æ’é”™">6. æ’é”™</h3>
<ul>
<li>çœ‹æ—¥å¿—æ–‡ä»¶ï¼ è®¿é—®æ—¥å¿—ï¼š<code>/var/log/nginx/error.log</code> é”™è¯¯æ—¥å¿—ï¼š<code>/var/log/nginx/access.log</code>  å¯¹åº”uwsgiæ—¥å¿— - å’Œ<code>uwsgi.ini</code>åŒçº§ä¸‹çš„<code>uwsgi.log</code></li>
<li>502 ä»£è¡¨nginxåå‘ä»£ç†æˆåŠŸï¼Œä½†æ˜¯å¯¹åº”çš„uwsgiæœªå¯åŠ¨ï¼›è¿˜æœ‰ä¸€ç§å°±æ˜¯uwsgiè®¾ç½®æ¥å—è¯·æ±‚è¿‡å°ï¼Œåœ¨uwsgi.iniä¸­æ·»åŠ <code>buffer-size = 65536</code>  -  ä¸»è¦è¿˜æ˜¯å¾—çœ‹æ—¥å¿—</li>
<li>404ï¼ˆåˆ†ä¸¤ç§ï¼šdjangoæŠ¥é”™/nginxæŠ¥é”™ï¼‰  ä¸€å¯èƒ½æ˜¯è·¯ç”±ä¸åœ¨djangoé¡¹ç›®ï¼›äºŒå¯èƒ½æ˜¯æ²¡æœ‰ç¦æ­¢æ‰nginxé…ç½®æ–‡ä»¶é‡Œçš„<code>try_files</code></li>
</ul>
<h3 id="7-nginxé™æ€æ–‡ä»¶é…ç½®">7. nginxé™æ€æ–‡ä»¶é…ç½®</h3>
<ul>
<li>åˆ›å»ºæ–°æ–‡ä»¶å¤¹ - å­˜æ”¾æ‰€æœ‰çš„djangoé™æ€æ–‡ä»¶ -- ä¾‹å¦‚<code>/home/mysite_static/</code></li>
<li>åœ¨django setting.pyä¸­æ·»åŠ é…ç½® <code>STATIC_ROOT</code>ä»£è¡¨é™æ€æ–‡ä»¶è·¯å¾„  -- ä¾‹å¦‚<code>/home/mysite_static/static/</code></li>
<li>è¿›å…¥djangoé¡¹ç›®ï¼Œæ‰§è¡Œ<code>python3 mange.py collectstatic</code> - æ”¶é›†é¡¹ç›®æ‰€æœ‰çš„é™æ€æ–‡ä»¶</li>
<li>nginxé…ç½®æ–‡ä»¶æ–°å¢åŠ </li>
</ul>
<pre><code class="language-vim">location /static {
root /é™æ€æ–‡ä»¶å¤¹;  
}
</code></pre>
<p>ç‰¹åˆ«è¦æ³¨æ„è·¯å¾„ï¼Œè¿™ä¸ªâ€˜é™æ€æ–‡ä»¶å¤¹â€™ä¸‹é¢è¿˜æœ‰ä¸€ä¸ªstaticçš„æ–‡ä»¶å¤¹ï¼Œé‡Œé¢æ‰æ˜¯çœŸæ­£å­˜æ”¾äº†æ‰€æœ‰çš„é™æ€æ–‡ä»¶</p>
<h3 id="8-404500-è‡ªå®šä¹‰æŠ¥é”™é¡µé¢">8. 404/500 è‡ªå®šä¹‰æŠ¥é”™é¡µé¢</h3>
<ul>
<li>åœ¨djangoçš„æ¨¡æ¿æ–‡ä»¶å¤¹å†…æ·»åŠ <code>404.html</code>æ–‡ä»¶ï¼Œå½“è§†å›¾è§¦å‘http404çš„æ—¶å€™è‡ªåŠ¨æ˜¾ç¤ºè¯¥é¡µé¢ï¼ˆåœ¨debug=falseçš„æ—¶å€™å½©èµ·ä½œç”¨ï¼‰ -- æ·»åŠ å®Œä¹‹åè®°å¾—é‡å¯nginxã€uwsgiç­‰æœåŠ¡</li>
</ul>
<h3 id="9-ç»™åŸæ¥çš„é™æ€æ–‡ä»¶å¤¹ä¸‹æ–°å¢æ–‡ä»¶å¤¹ç»“æœ404">9. ç»™åŸæ¥çš„é™æ€æ–‡ä»¶å¤¹ä¸‹æ–°å¢æ–‡ä»¶å¤¹ï¼Œç»“æœ404</h3>
<p>å¤§æ¦‚æ˜¯å› ä¸ºé¡¹ç›®ä¸­çš„é™æ€æ–‡ä»¶è·¯å¾„å’Œnginxçš„æœ‰æ‰€åŒºåˆ«ï¼Œ<br>
éœ€è¦æ³¨æ„aliaså’Œrootçš„åŒºåˆ«ï¼Œ<br>
nginxä¼šæ ¹æ®è¯·æ±‚çš„è·¯å¾„ï¼Œå»è¯·æ±‚é™æ€æ–‡ä»¶å¤¹ä¸­å¯èƒ½å­˜åœ¨çš„ï¼Œæ–‡ä»¶å¤¹ä¸­çš„é™æ€æ–‡ä»¶ã€‚ç®€è€Œè¨€ä¹‹ï¼Œnginxæ˜¯å¯ä»¥åµŒå¥—çš„ï¼Œä½†æ˜¯å‰ææ˜¯è¯·æ±‚çš„è·¯å¾„éœ€è¦å¯¹åº”çš„ä¸Šã€‚</p>
<h3 id="10-aliasä¸rootçš„åŒºåˆ«">10. aliasä¸rootçš„åŒºåˆ«</h3>
<p><a href="https://blog.csdn.net/m0_58709145/article/details/127754115">csdnå‚è€ƒ</a></p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[djangoå­¦ä¹  -- å‰åç«¯ä¸åˆ†ç¦»çš„ -- part.2]]></title>
        <id>http://localhost:4000/post/django-xue-xi-qian-hou-duan-bu-fen-chi-de-part2/</id>
        <link href="http://localhost:4000/post/django-xue-xi-qian-hou-duan-bu-fen-chi-de-part2/">
        </link>
        <updated>2023-06-30T12:36:08.000Z</updated>
        <content type="html"><![CDATA[<h3 id="35æ—¶é—´é€‰æ‹©æ’ä»¶">35.æ—¶é—´é€‰æ‹©æ’ä»¶</h3>
<p><a href="https://www.bootcss.com/p/bootstrap-datetimepicker/index.htm">download_link</a><br>
<a href="https://bootstrap-datepicker.readthedocs.io/en/latest/options.html">office_link</a><br>
<a href="https://blog.csdn.net/qq_28633249/article/details/77142352">usage</a></p>
<ul>
<li>ä½¿ç”¨æå…¶ç®€å•ï¼šåªéœ€è¦é€‰æ‹©domç„¶åç»‘å®šå³å¯ï¼Œåœ¨ä½¿ç”¨æ–¹æ³•é‡Œå¯ä»¥è®¾ç½®å„ç§å‚æ•°</li>
</ul>
<pre><code class="language-js">$('#id_presettime').datetimepicker({
   format: 'yyyy-mm-dd hh:ii'
});   
</code></pre>
<h3 id="36modelfieldå®šä¹‰æˆæˆè¡¨å•çš„å±æ€§æ ·å¼">36.modelfieldå®šä¹‰æˆæˆè¡¨å•çš„å±æ€§æ ·å¼</h3>
<pre><code class="language-python">class orderForm(ModelForm):
    class Meta():
        model = Orderform
        fields = &quot;__all__&quot;

    #æ–¹æ³•ä¸€ åŸç”Ÿçš„å±æ€§
    widgets = {
        #ä¸ºhtmlè¡¨å•ä¸­nameç±»å‹çš„inputæ ‡ç­¾æ·»åŠ &quot;class=form-control&quot;
        'name' : forms.TextInput(attrs = {&quot;class&quot; : &quot;form-control&quot;})
        #ä¸ºhtmlè¡¨å•ä¸­passwordç±»å‹çš„inputæ ‡ç­¾æ·»åŠ &quot;class=form-control&quot;
        'password' : formsPasswordInput( attrs = {&quot;class&quot; : &quot;form-control&quot;})
        ...
    }

    #æ–¹æ³•äºŒ æ‰©å†™çˆ¶ç±»å‡½æ•°çš„å±æ€§
        def __init__(self,*arg,**kwargs):
            super().__init__(*arg,**kwargs)
            for name, field in self.fields.items():
                # print(name,field) #è¿™ä¸ªæ˜¯å±•ç¤º self.fields.items()å¯ä»¥ç›´æ¥æ‹¿åˆ°å®šä¹‰åœ¨Metaä¸­çš„fieldså­—æ®µ
                field.widget.attrs = {'class' : 'form-control'} #ä¸ºç”Ÿæˆçš„è¡¨å•inputèµ‹äºˆcsså±æ€§ 
</code></pre>
<ul>
<li>æ‰©å…… è¿™ä¸ªå±æ€§å¯ä»¥ç»§æ‰¿ ä¸è¿‡æš‚æ—¶å¯¹æˆ‘æ²¡ä»€ä¹ˆç”¨å¤„ å› æ­¤passè¿‡</li>
</ul>
<h3 id="37ä¿®æ”¹dajngoçš„modelformç±»çš„inputçš„typeç±»å‹ä¸ºdatetime-local">37.ä¿®æ”¹dajngoçš„modelformç±»çš„<code>input</code>çš„<code>type</code>ç±»å‹ä¸º<code>datetime-local</code></h3>
<ul>
<li>ç¬¬ä¸€ç§æ˜¯é€šè¿‡å‰ç«¯jså®ç°ï¼Œä¸€å…±ä¸‰æ­¥ï¼šç¬¬ä¸€æ‹¿åˆ°åŸå§‹çš„æ—¶é—´æ•°æ®ï¼Œç¬¬äºŒé€‰æ‹©inputæ¡†ç„¶åä¿®æ”¹typeï¼Œç¬¬ä¸‰è®²åŸå§‹çš„æ—¶é—´æ•°æ®ä¿®æ”¹æ ¼å¼ä¹‹ååœ¨èµ‹äºˆç»™inputæ¡†ï¼š</li>
</ul>
<pre><code class="language-js">function changeDatetimeInput(id){
    var time = $(`#${id}`).val().replaceAll('/','-');
    $(`#${id}`).attr('type','datetime-local');
    $(`#${id}`).val(time)
}
changeDatetimeInput('id_presettime');
changeDatetimeInput('id_endtime');
</code></pre>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåç«¯djangoä¼ æ¥çš„ä¹‹é—´ç±»å‹æ˜¯<code>yyyy/mm/dd hh:ii</code>ï¼Œä½†æ˜¯htmlå†…ç½®çš„æ—¶é—´é€‰æ‹©inputæ¡†çš„æ—¶é—´å­—ç¬¦ä¸²æ ¼å¼è¦æ±‚æ˜¯<code>yyyy-mm-ddThh:ii</code>ï¼Œå› æ­¤éœ€è¦å°†åŸæ¥çš„æ–œæ ï¼ˆ/ï¼‰æ›¿æ¢æˆçŸ­æ¨ªï¼ˆ-ï¼‰ï¼Œä¸­é—´Â·çš„<code>T</code>æ˜¯ä¸€ä¸ªæ—¶é—´å­—ç¬¦è¡¨ç¤ºï¼Œå¯ä»¥ç”¨å¤§å†™å­—ç¬¦Tè¡¨ç¤ºï¼Œä½†æœ€ç»ˆè§£æçš„æ—¶å€™ç©ºæ ¼ä¹Ÿå¯ä»¥ï¼Œ<a href="https://blog.csdn.net/jim_LoveQ/article/details/107457771">å…·ä½“å‚è€ƒ</a></p>
<ul>
<li>ç¬¬äºŒç§å°±æ˜¯ä¿®æ”¹djangoçš„<code>DateTimeInput</code><br>
è¿™ç§çœ‹ä¸æ‡‚åŸå› ï¼Œä½†æ˜¯å¦‚æœåªæ˜¯ä»…ä»…ä¿®æ”¹input_typeçš„è¯æ˜¯è§£æä¸äº†çš„ï¼Œå›ç­”ç»™å‡ºçš„åŸå› æ˜¯åç«¯ä¼šå› ä¸ºè¾“å…¥åˆæ³•åˆ¤æ–­å’Œä¸é€šè¿‡ï¼Œ<a href="https://stackoverflow.com/questions/50214773/type-datetime-local-in-django-form">detail_link_and_solution</a></li>
</ul>
<pre><code class="language-python">from django import forms
class DateTimeLocalInput(forms.DateTimeInput):
    input_type = &quot;datetime-local&quot;

class DateTimeLocalField(forms.DateTimeField):
    # Set DATETIME_INPUT_FORMATS here because, if USE_L10N 
    # is True, the locale-dictated format will be applied 
    # instead of settings.DATETIME_INPUT_FORMATS.
    # See also: 
    # https://developer.mozilla.org/en-US/docs/Web/HTML/Date_and_time_formats
    input_formats = [
        &quot;%Y-%m-%dT%H:%M:%S&quot;, 
        &quot;%Y-%m-%dT%H:%M:%S.%f&quot;, 
        &quot;%Y-%m-%dT%H:%M&quot;
    ]
    widget = DateTimeLocalInput(format=&quot;%Y-%m-%dT%H:%M&quot;)
</code></pre>
<p>ç„¶åå†è‡ªå·±çš„modelformä¸­å°†æƒ³è¦ä¿®æ”¹inputçš„typç±»å‹ä¸ºdatetime-localçš„å­—æ®µè®¾ç½®ä¸º<code>DateTimeLocalField</code>å³å¯ï¼š</p>
<pre><code class="language-python">#ç”¨æ³•
class orderEditForm(ModelForm):
    presettime = DateTimeLocalField() #åœ¨è¿™é‡Œå°†æƒ³è¦çš„å­—æ®µè®¾ç½®å³å¯
    class Meta():
        model = Orderform
        fields = &quot;__all__&quot;
</code></pre>
<pre><code class="language-html">&lt;!-- {{field}}ç”Ÿæˆçš„å…·ä½“æ ·å¼  --&gt;
&lt;input type=&quot;text&quot; name=&quot;endtime&quot; value=&quot;1899/12/31 00:00&quot; class=&quot;form-control&quot; id=&quot;id_endtime&quot;&gt;
</code></pre>
<h3 id="38é€šè¿‡validationerroræ¥ä¸ºé’©å­æ–¹æ³•è®¾ç½®éæ³•è¾“å…¥æç¤ºä¿¡æ¯">38.é€šè¿‡validationErroræ¥ä¸ºé’©å­æ–¹æ³•è®¾ç½®éæ³•è¾“å…¥æç¤ºä¿¡æ¯</h3>
<p><code>raise ValidationError</code></p>
<h3 id="39å¯†ç åŠ å¯†-é€šè¿‡é’©å­æ–¹æ³•å®šä¹‰">39.å¯†ç åŠ å¯† é€šè¿‡é’©å­æ–¹æ³•å®šä¹‰</h3>
<ul>
<li>é’©å­æ–¹æ³•è¿”å›çš„å°±æ˜¯å‚¨å­˜åˆ°æ•°æ®åº“ä¸­</li>
<li>md5åŠ å¯† åŠ å¯†éœ€è¦â€œç›â€ï¼Œä¸ºäº†æ–¹ä¾¿å’Œæ•ˆæœ ä½¿ç”¨djangoåœ¨è®¾ç½®ä¸­ç”Ÿæˆçš„secret_keyæ¥å½“ä½œâ€œç›â€</li>
</ul>
<pre><code class="language-python">from django.conf import settings
import hashlib

def md5(data_string):
    obj = hashlib.md5(settings.SECRET_KEY.encode('utf-8'))
    obj.update(data_string.encode('utf-8'))
    return obj.hexdigest()
</code></pre>
<h3 id="40å¯¹äºdjanfoçš„ormå¦‚æœæœç´¢ä¸åˆ°">40.å¯¹äºdjanfoçš„ORMï¼Œå¦‚æœæœç´¢ä¸åˆ°</h3>
<p>æœç´¢ä¸åˆ°å°±è¿”å›Noneï¼Œå¯ä»¥ç”¨æ¥åˆ¤æ–­æ˜¯å¦æ˜¯åˆæ³•è¯·æ±‚</p>
<h3 id="41å¯¹äºè¡¨å•éªŒè¯">41.å¯¹äºè¡¨å•éªŒè¯</h3>
<p>æ‰€æœ‰éªŒè¯é€šè¿‡çš„ä¿¡æ¯éƒ½å‚¨å­˜åœ¨å¯¹åº”çš„<code>cleaned_data</code>ä¸­</p>
<h3 id="42djangoæŠ¥é”™">42.djangoæŠ¥é”™</h3>
<p><code>'Manager' object is not callable</code><br>
åŸå› æ˜¯<code>objects</code>æ˜¯ä¸€ä¸ªå±æ€§è€Œä¸æ˜¯ä¸€ä¸ªæ–¹æ³•ï¼Œå†™æˆ<code>objects()</code>ä¼šæŠ¥è¿™ä¸ªé”™</p>
<h3 id="43ç”¨æˆ·ç™»å½•">43.ç”¨æˆ·ç™»å½•</h3>
<ul>
<li>cookies å’Œ session<br>
æ— çŠ¶æ€çŸ­é“¾æ¥<br>
é€šè¿‡cookiesç»™ç”¨æˆ·å‘æ”¾ä¸€ä¸ªâ€œå‡­è¯â€ï¼Œ ä¿å­˜åœ¨æµè§ˆå™¨ä¸­çš„é”®å€¼å¯¹ï¼Œå‘é€è¯·æ±‚çš„æ—¶å€™è‡ªåŠ¨æºå¸¦<br>
session djangoé»˜è®¤å‚¨å­˜åœ¨mysqlä¸­</li>
</ul>
<p>ä¸šåŠ¡è¿‡ç¨‹ï¼šæ”¶åˆ°ç”¨æˆ·çš„æäº¤ -&gt; æ ¡éªŒï¼ˆåœ¨æ•°æ®åº“æ¯”è¾ƒï¼‰ -&gt; æˆåŠŸ ç”Ÿæˆéšæœºå­—ç¬¦ä¸²å†™å…¥åˆ°ç”¨æˆ·æµè§ˆå™¨çš„cookiesä»¥åŠæ•°æ®åº“ä¸­ï¼ˆè¿™é‡Œåªéœ€è¦è°ƒç”¨<code>request.session()</code>æ–¹æ³•å³å¯ djangoä¼šè‡ªåŠ¨å¤„ç†ä¸¤ä¸ªäº‹ä»¶ï¼‰ï¼Œå¹¶ä¸”ä¼šå°†ä¼ å…¥çš„å­—ç¬¦ç»è¿‡å¤„ç†ä¹‹åï¼Œä»¥<code>{session_key:session_data}</code>é”®å€¼å¯¹çš„å½¢å¼ä¿å­˜åœ¨æ•°æ®åº“ä¸­ï¼Œå…¶ä¸­session_keyå°±æ˜¯ä¼ é€’ç»™æµè§ˆå™¨çš„cookiesï¼Œè€Œsession_dataå°±æ˜¯åœ¨ä¸‹é¢ä»£ç ä¸­å®šä¹‰çš„å­—å…¸ï¼ˆç»è¿‡å­—ç¬¦è½¬æ¢ï¼Œéœ€è¦ä½¿ç”¨çš„æ—¶å€™djangoä¼šè§£ç ï¼‰</p>
<pre><code class="language-python">        else: #ç™»é™†æˆåŠŸ
            request.session['info'] = { #å†™å…¥session
                'id':login_object.id,
                'name' : login_object.name,
            }
</code></pre>
<ul>
<li>
<p style="color:red;font-size:large;">PS. ç‰¹åˆ«éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨åé¢çš„è°ƒç”¨request.sessionä¸­çš„å±æ€§çš„åå­—éƒ½æ˜¯æ¥è‡ªäºæ­¤ï¼</p>
</li>
</ul>
<p>å› æ­¤éœ€è¦åœ¨ç”¨æˆ·è®¿é—®çš„æ—¶å€™åˆ¤æ–­ç”¨æˆ·æ˜¯å¦ç™»å½• -&gt; å·²ç™»å½•ç»§ç»­è®¿é—® æœªç™»å½•è·³è½¬å›ç™»é™†é¡µé¢ï¼š<br>
ç”¨æˆ·è¯·æ±‚-&gt; æ‹¿åˆ°ç”¨æˆ·cookieså¹¶åˆ¤æ–­ï¼š</p>
<pre><code class="language-python">#ç¬¬ä¸€ç§æ–¹æ³• åœ¨æ¯ä¸ªè¯·æ±‚å‰éƒ½åŠ ä¸Šå¯¹äºcookiesçš„åˆ¤æ–­
    if not request.session.get('info'):
        return redirect('/login/')
</code></pre>
<p>å¤ªlowğŸ˜<br>
åº”è¯¥ä½¿ç”¨djangoçš„ä¸­é—´ä»¶é«˜æ•ˆçš„å¤„ç†</p>
<h3 id="44djangoä¸­é—´ä»¶">44.djangoä¸­é—´ä»¶</h3>
<p><a href="https://docs.djangoproject.com/zh-hans/4.1/topics/http/middleware/">å®˜æ–¹æ–‡æ¡£</a></p>
<ul>
<li>å¯¹äºdjangoï¼Œæ¯ä¸€ä¸ªè¯·æ±‚éƒ½éœ€è¦ç»è¿‡å¾ˆå¤šä¸­é—´ä»¶ä¹‹åæ‰èƒ½è®¿é—®åˆ°è§†å›¾å‡½æ•°ï¼›åŒæ ·çš„ï¼Œæ‰€æœ‰çš„è§†å›¾å‡½æ•°è¿”å›å€¼éƒ½éœ€è¦ç»è¿‡å¾ˆå¤šä¸­é—´ä»¶çš„å¤„ç†æ‰ä¼šè¿”å›ç»™ç”¨æˆ·ã€‚</li>
<li>djangoçš„ä¸­é—´ä»¶éƒ½æ˜¯ç±»ï¼Œé€šè¿‡<code>process_request</code>æ–¹æ³•å¯¹ä¼ å…¥çš„è¯·æ±‚è¿›è¡Œå¤„ç†ï¼Œé€šè¿‡<code>process_response</code>å¯¹è§†å›¾å‡½æ•°çš„returnè¿›è¡ŒåŒ…è£…ã€‚å¦‚æœæŸä¸ªè¯·æ±‚ä¸èƒ½é€šè¿‡ä¸€ä¸ªä¸­é—´ä»¶ï¼Œé‚£ä¹ˆå°±ä¼šç›´æ¥è¿”å›ç»™ç”¨æˆ·ï¼Œè€Œä¸ä¼šåˆ°è¾¾è§†å›¾å‡½æ•°ã€‚</li>
<li>ä¸­é—´ä»¶å†™å¥½ä¹‹åéœ€è¦åœ¨setting.pyæ–‡ä»¶ä¸­çš„MIDDLEWAREä¸­æ³¨å†Œï¼ˆå…·ä½“åˆ°ç±»åï¼‰ï¼Œå“ªä¸ªåœ¨å‰é¢é‚£ä¸ªå…ˆæ‰§è¡Œã€‚</li>
<li>ä¸­é—´çš„<code>process_request</code>æ–¹æ³•å¦‚æœè¿”å›ä¸ºNoneï¼Œé‚£ä¹ˆç»§ç»­å‘åæ‰§è¡Œï¼›å¦‚æœéœ€è¦è¿”å›ï¼Œé‚£ä¹ˆè¿”å›çš„ç±»å‹ä¸è§†å›¾å‡½æ•°çš„è¿”å›ç±»ä¼¼ï¼ˆä¾‹å¦‚render,redirect,HttpResponseç­‰ï¼‰ï¼Œå¹¶ä¸”ä¸åœ¨å‘åæ‰§è¡Œã€‚</li>
<li>åº”ç”¨ä¸­é—´ä»¶ï¼š
<ul>
<li>1.æ³¨å†Œä¸­é—´ä»¶</li>
<li>2.ä¸­é—´ä»¶ä¸­è¿”å›å€¼</li>
<li>3.é€šè¿‡ä¸­é—´ä»¶å®ç°ç™»å½•æ ¡éªŒ<br>
ä»£ç å®ç°</li>
</ul>
</li>
</ul>
<pre><code class="language-python">#middleware.pyæ–‡ä»¶
from django.utils.deprecation import MiddlewareMixin
from django.shortcuts import render,redirect
from django.http import HttpResponse

class SessionChectMiddleware(MiddlewareMixin):
    def process_request(self,request):
        #æ’é™¤ä¸éœ€è¦ç™»é™†çš„é¡µé¢
        allow_url = ['/login/','/register/']
        if request.path_info in allow_url:
            return
        #è¯»å–session
        info = request.session.get('info')
        if info:
            return
        else: 
            return redirect('/login/')
</code></pre>
<pre><code class="language-python">#åœ¨setting.pyæ–‡ä»¶ä¸­æ³¨å†Œ
MIDDLEWARE = [
    &quot;django.middleware.security.SecurityMiddleware&quot;,
...... ,
    &quot;cake.middleware.SessionChectMiddleware&quot;,
]
</code></pre>
<p>PS. request.path_infoå¯ä»¥è·å–åˆ°è¯·æ±‚çš„urlè·¯å¾„ã€‚</p>
<h3 id="45æ³¨é”€æ“ä½œ-ç”¨æˆ·é€€å‡ºç™»å½•">45.æ³¨é”€æ“ä½œ - ç”¨æˆ·é€€å‡ºç™»å½•</h3>
<p>ä¹Ÿå°±æ˜¯å°†æµè§ˆå™¨çš„cookieså’Œsessionåˆ é™¤<br>
åŒæ ·ä½¿ç”¨request.sessionä¸­çš„æ–¹æ³•å³å¯</p>
<h3 id="46é€šè¿‡sessionè·å–ç”¨æˆ·ç™»å½•ä¿¡æ¯æ˜¾ç¤ºåœ¨å¯¼èˆªæ ">46.é€šè¿‡sessionè·å–ç”¨æˆ·ç™»å½•ä¿¡æ¯æ˜¾ç¤ºåœ¨å¯¼èˆªæ </h3>
<p>æ¯æ¬¡è§†å›¾å‡½æ•°çš„ä¸­ä¼ é€’çš„requestä¸­éƒ½åŒ…å«sessionå‚æ•°ï¼Œå› æ­¤å¯ä»¥ç›´æ¥åœ¨æ¨¡æ¿ä¸­è°ƒç”¨<code>{{request.session.info.å±æ€§}}</code>æ¥è·å–å¯¹åº”çš„ä¿¡æ¯ï¼ˆå› ä¸ºrequestæ˜¯é»˜è®¤ä¼ é€’çš„ï¼‰ï¼Œä¸ç”¨åˆ»æ„é€šè¿‡åˆ«çš„æ¨¡æ¿å‚æ•°æ¥æ¸²æŸ“ã€‚</p>
<pre><code class="language-python">    &lt;button class=&quot;btn btn-secondary dropdown-toggle btn-sm&quot; type=&quot;button&quot; id=&quot;dropdownMenuButton2&quot; data-bs-toggle=&quot;dropdown&quot; aria-expanded=&quot;false&quot;&gt;
                        {{ request.session.info.name}}
&lt;/button&gt;
</code></pre>
<h3 id="47formå’Œmodelform">47.formå’Œmodelform</h3>
<ul>
<li>formå¯ä»¥è‡ªå®šä¹‰å­—æ®µ<br>
modeformæ—¢å¯ä»¥è‡ªå®šä¹‰ è¿˜å¯ä»¥åœ¨æ•°æ®åº“ä¸­æ‹¿å–å­—æ®µ</li>
<li>formæ²¡æœ‰saveæ–¹æ³•å¯ä»¥ç›´æ¥å­˜å…¥åˆ°æ•°æ®åº“ ä½†æ˜¯modelformæœ‰</li>
</ul>
<h3 id="48å›¾ç‰‡éªŒè¯ç ">48.å›¾ç‰‡éªŒè¯ç </h3>
<p>-&gt; pythonä¸­å¦‚ä½•åŠ¨æ€ç”Ÿæˆå›¾ç‰‡å¹¶å†™å…¥å€¼ (ä¸åšè¿‡å¤šäº†è§£ ä»…ä»…å½“æˆé»‘ç›’ä½¿ç”¨)<br>
<a href="https://www.cnblogs.com/crischou/p/7152974.html">å‚è€ƒæ–‡çŒ®</a></p>
<ul>
<li>éœ€è¦pillowåº“</li>
</ul>
<pre><code class="language-python">import random
from PIL import Image,ImageFont,ImageDraw,ImageFilter
#éœ€è¦æ³¨æ„ï¼ï¼ è¿™é‡Œçš„å­—ä½“æ–‡ä»¶font_fileè·¯å¾„ç»„åˆæ˜¯åŸºäºè¿è¡Œçš„æ ¹ç›®å½•å†³å®šçš„ éœ€è¦æ ¹æ®ç›¸å¯¹ä½ç½®çš„ä¸åŒè¿›è¡Œè°ƒæ•´ï¼è¿™é‡Œæˆ‘å°†ä»–æ”¾åœ¨æ ¹ç›®å½•ä¸‹é¢çš„static/æ–‡ä»¶å¤¹å†…
def check_code(width=120, height=30, char_length=5, font_file='./static/kumo.ttf', font_size=28):
    # font = ImageFont.load_default() #ä½¿ç”¨é»˜è®¤å­—ä½“
    code = []
    img = Image.new(mode='RGB', size=(width, height), color=(255, 255, 255))
    draw = ImageDraw.Draw(img, mode='RGB')
    def rndChar():
        &quot;&quot;&quot;
        ç”Ÿæˆéšæœºå­—æ¯   
        :return:
        &quot;&quot;&quot;
        return chr(random.randint(65, 90))
    def rndColor():
        &quot;&quot;&quot;
        ç”Ÿæˆéšæœºé¢œè‰²
        :return:
        &quot;&quot;&quot;
        return (random.randint(0, 255), random.randint(10, 255), random.randint(64, 255))
    # å†™æ–‡å­—
    font = ImageFont.truetype(font_file, font_size)
    for i in range(char_length):
        char = rndChar()
        code.append(char)
        h = random.randint(0, 4)
        draw.text([i * width / char_length, h], char, font=font, fill=rndColor())
    # å†™å¹²æ‰°ç‚¹
    for i in range(40):
        draw.point([random.randint(0, width), random.randint(0, height)], fill=rndColor())
    # å†™å¹²æ‰°åœ†åœˆ
    for i in range(40):
        draw.point([random.randint(0, width), random.randint(0, height)], fill=rndColor())
        x = random.randint(0, width)
        y = random.randint(0, height)
        draw.arc((x, y, x + 4, y + 4), 0, 90, fill=rndColor())
    # ç”»å¹²æ‰°çº¿
    for i in range(5):
        x1 = random.randint(0, width)
        y1 = random.randint(0, height)
        x2 = random.randint(0, width)
        y2 = random.randint(0, height)

        draw.line((x1, y1, x2, y2), fill=rndColor())

    img = img.filter(ImageFilter.EDGE_ENHANCE_MORE)
    return img,''.join(code)
 
if __name__ == '__main__':
    # 1. ç›´æ¥æ‰“å¼€
    # img,code = check_code()
    # img.show()
 
    # 2. å†™å…¥æ–‡ä»¶
    img,code = check_code()
    with open('code.png','wb') as f:
        img.save(f,format='png')
 
    # 3. å†™å…¥å†…å­˜(Python3)
    # from io import BytesIO
    # stream = BytesIO()
    # img.save(stream, 'png')
    # stream.getvalue()
 
    # 4. å†™å…¥å†…å­˜ï¼ˆPython2ï¼‰
    # import StringIO
    # stream = StringIO.StringIO()
    # img.save(stream, 'png')
    # stream.getvalue()

    pass
</code></pre>
<p style='color:red'>éœ€è¦æ³¨æ„ï¼ï¼`check_code()`çš„å­—ä½“æ–‡ä»¶`font_file`è·¯å¾„ç»„åˆæ˜¯åŸºäºè¿è¡Œçš„æ ¹ç›®å½•å†³å®šçš„ éœ€è¦æ ¹æ®ç›¸å¯¹ä½ç½®çš„ä¸åŒè¿›è¡Œè°ƒæ•´ï¼è¿™é‡Œæˆ‘å°†ä»–æ”¾åœ¨æ ¹ç›®å½•ä¸‹é¢çš„`static/`æ–‡ä»¶å¤¹å†…</p>
+ ç„¶åå°±æ˜¯éƒ¨ç½²åˆ°djangä¸­ï¼šä¸»è¦æ˜¯å°†å‰ç«¯è¯·æ±‚å›¾ç‰‡çš„urlæ›¿æ¢ä¸ºåŠ¨æ€çš„ï¼Œç„¶åç”ŸæˆéªŒè¯ç çš„è§†å›¾å‡½æ•°è¿”å›å¯¹åº”çš„éªŒè¯ç å›¾ç‰‡ã€‚
```python
from .function.checkcode import check_code #è¿™ä¸ªå°±æ˜¯åˆšæ‰çš„ç”ŸæˆéªŒè¯ç å›¾ç‰‡çš„å‡½æ•°
from io import BytesIO #å°†å›¾ç‰‡å‚¨å­˜åˆ°å†…å­˜ä¸­éœ€è¦ç”¨çš„åº“
<p>def image_code(request):<br>
'''ç”ŸæˆéªŒè¯ç '''<br>
img,str = check_code()<br>
print(str)<br>
stream = BytesIO()<br>
img.save(stream, 'png')</p>
<pre><code>return HttpResponse(stream.getvalue()) #ä»å†…å­˜ä¸­è¯»å–åˆ°å›¾ç‰‡ç„¶åä»¥http responseçš„å½¢å¼ä¼ å›ç»™å‰ç«¯ å‰ç«¯çš„imgæ ‡ç­¾è§£æä¹‹åå°±æ˜¯ä¸€ä¸ªå›¾ç‰‡
</code></pre>
<pre><code>```html
&lt;img src=&quot;/image/code/&quot;&gt; 
&lt;!-- åªè¦è°ƒç”¨å¯¹åº”çš„urlå°±å¯ä»¥ --&gt;

</code></pre>
<p>PS. éœ€è¦æ³¨æ„çš„æ˜¯ï¼šåŒä¸€ä¸ªæ–‡ä»¶ä¸­ä¸è¦å‡ºç°åå­—ç›¸åŒçš„å‡½æ•°ï¼Œä¸ç®¡æ˜¯å¼•ç”¨çš„è¿˜æ˜¯æœ¬æ–‡ä»¶çš„ï¼Œä¼šå¯¼è‡´è°ƒç”¨å‡ºé”™</p>
<h3 id="49å¦‚ä½•éªŒè¯éªŒè¯ç å‘¢">49.å¦‚ä½•éªŒè¯éªŒè¯ç å‘¢ï¼Ÿ</h3>
<p>é€šè¿‡sessionï¼ - è¿™æ ·æ¯ä¸ªç”¨æˆ·åœ¨ç™»é™†çš„æ—¶å€™å¯¹äºéªŒè¯ç çš„éªŒè¯å°±ä¸ä¼šå—åˆ°å¹²æ‰°ï¼Œå¹¶ä¸”é‡å¤åˆ·æ–°ä¹Ÿä¼šæ›´æ–°sessionä¸­å¯¹åº”çš„éªŒè¯ç ã€‚<br>
è¿™é‡Œæœ‰å¾ˆå¤šéœ€è¦æ³¨æ„çš„ç‚¹ï¼</p>
<ul>
<li><code>add_errors()</code>å¯ä»¥å‘formsä¸­æŒ‡å®šå­—æ®µæ·»åŠ é”™è¯¯æç¤ºä¿¡æ¯ï¼Œç„¶åèƒ½åœ¨å‰ç«¯çš„<code>{{fields.å±æ€§å­—æ®µ.errors.0}}</code>ä¸­å–åˆ°ã€‚</li>
<li>ç”±äºéªŒè¯ç çš„å­—æ®µæ˜¯æ²¡æœ‰åœ¨ç”¨æˆ·model/æ•°æ®åº“è¡¨ä¸­å­˜åœ¨çš„ï¼Œå› æ­¤å¦‚æœç›´æ¥ä¼ å…¥<code>request.POST</code>ä½œä¸ºdataå‚æ•°ä¼šæŠ¥é”™ã€‚å› æ­¤åº”è¯¥å°†éªŒè¯ç å­—æ®µå•ç‹¬å‰”é™¤ã€‚</li>
<li>éªŒè¯ç éªŒè¯éœ€è¦è°ƒç”¨ä¹‹å‰åˆ›å»ºéªŒè¯ç æ—¶å­˜å…¥sessionçš„å­—æ®µï¼Œå°†ä¸¤ä¸ªå­—æ®µç›¸æ¯”è¾ƒåˆ¤æ–­æ˜¯å¦æ­£ç¡®ã€‚</li>
<li>ç™»å½•æˆåŠŸä¹‹åéœ€è¦é‡æ–°è®¾ç½®sessionçš„è¿‡æœŸæ—¶é—´ ï¼Œå› ä¸ºä¸ºäº†éªŒè¯ç çš„ç™»å½•æ—¶æ•ˆï¼Œåœ¨ç”ŸæˆéªŒè¯ç çš„æ—¶å€™ä¼šè®¾ç½®ä¿å­˜éªŒè¯ç å¯¹æ¯”å­—æ®µçš„sessionä¿¡æ¯æ—¶æ•ˆæ¯”è¾ƒçŸ­ï¼Œå› æ­¤ç™»å½•æˆåŠŸä¹‹åéœ€è¦é‡æ–°è®¾ç½®ã€‚<br>
æœ€ç»ˆçš„ç™»å½•é€»è¾‘</li>
</ul>
<pre><code class="language-python">from .models import UserInfo #modelä¸­çš„ç±» æ˜¯æœ€åŸæœ¬çš„ç”¨æˆ·ä¿¡æ¯ç±» åŒ…æ‹¬è´¦æˆ·åå’Œå¯†ç ä»¥åŠè‡ªåŠ¨ç”Ÿæˆçš„id
from io import BytesIO #ç”Ÿæˆå›¾ç‰‡å‚¨å­˜åœ¨å†…å­˜
from .encrypt import md5 #åŠ å¯†

class loginForm(forms.Form):
    name = forms.CharField(label='ç”¨æˆ·å',widget=forms.TextInput(
        attrs = {
            'class' :&quot;my-input-item&quot;
        }
    ))
    password = forms.CharField(label='å¯†ç ',widget=forms.PasswordInput(
        attrs = {
            'class' :&quot;my-input-item&quot;
        }
    ))
    code = forms.CharField(label='éªŒè¯ç ',widget=forms.TextInput(
        attrs={
            'class':&quot;my-input-item&quot; ,
            'style':&quot;margin-top:0;&quot; ,
            'placeholder':&quot;éªŒè¯ç &quot;
        }
    ),required=True)

    def cleaned_password(self):
        return md5(self.changed_data.get('password')) #md5åŠ å¯†

#ç™»å½•é¡µé¢ 
def login(request):
    if request.method == 'GET':
        form = loginForm()
        return render(request,'login.html',{
            'form':form
        })

    login_form = loginForm(data=request.POST)
    if login_form.is_valid():
        user_input_code = login_form.cleaned_data.pop('code') 
        #éªŒè¯ç çš„æ ¡éªŒ
        code = request.session.get('image_code','') #è¿™ä¸ªæ˜¯åœ¨ç”ŸæˆéªŒè¯ç çš„æ—¶å€™å­˜å…¥sessionä¸­çš„ï¼Œå¦‚æœè¿‡æ—¶æˆ–è€…è·å–ä¸åˆ°é»˜è®¤ä¸ºç©º
        if code.upper() != user_input_code.upper(): #ä¸è€ƒè™‘å¤§å°å†™ 
            #å¦‚æœéªŒè¯ç ä¸ç›¸ç­‰
            login_form.add_error('code','éªŒè¯ç é”™è¯¯')
            return render(request,'login.html',{
                'form' : login_form,
            })

        login_object = UserInfo.objects.filter(**login_form.cleaned_data).first() #æ ¡éªŒç”¨æˆ·å¯†ç 
        if not login_object:
            login_form.add_error('name','ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯')
            return render(request,'login.html',{
                'form' : login_form,
            })
        else: #ç™»é™†æˆåŠŸ
            request.session['info'] = { #å†™å…¥session
                'id':login_object.id,
                'name' : login_object.name,
            }
            request.session.set_expiry(60 * 60 * 24 * 7) #å†é‡æ–°è®¾ç½®session ä¿å­˜7å¤©
            return redirect('/login/manage/')
    else: #è¡¨å•éªŒè¯æœªé€šè¿‡
        return render(request,'login.html',{
                'form' : login_form,
            }) 

#ç”ŸæˆéªŒè¯ç 
def image_code(request):
    '''ç”ŸæˆéªŒè¯ç '''
    img,str = check_code()
    request.session['image_code'] = str
    request.session.set_expiry(60) #è®¾ç½®éªŒè¯ç session 60sè¿‡æ—¶
    stream = BytesIO()
    img.save(stream, 'png')
    return HttpResponse(stream.getvalue())
</code></pre>
<p>PS. UserInfoæ˜¯åœ¨model.pyæ–‡ä»¶ä¸­çš„ORMç±»ï¼Œå¯¹åº”ç€å‚¨å­˜ç™»å½•ç”¨æˆ·å¸å·å¯†ç çš„æ•°æ®åº“è¡¨ã€‚</p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[mysql -- nullå’Œç©ºçš„åŒºåˆ«]]></title>
        <id>http://localhost:4000/post/mysql-null-he-kong-de-qu-bie/</id>
        <link href="http://localhost:4000/post/mysql-null-he-kong-de-qu-bie/">
        </link>
        <updated>2023-06-29T14:14:27.000Z</updated>
        <content type="html"><![CDATA[<blockquote>
<p>ç©ºå€¼æ—¶ä¸å ç”¨ç©ºé—´çš„ï¼› 2ã€nullå…¶å®æ˜¯å ç”¨ç©ºé—´çš„ï¼› æ‰“ä¸ªæ¯”æ–¹æ¥è¯´ï¼Œä½ æœ‰ä¸€ä¸ªæ¯å­ï¼Œç©ºå€¼ä»£è¡¨æ¯å­æ˜¯çœŸç©ºçš„ï¼ŒNULLä»£è¡¨æ¯å­ä¸­è£…æ»¡äº†ç©ºæ°”ï¼Œè™½ç„¶æ¯å­çœ‹èµ·æ¥éƒ½æ˜¯ç©ºçš„ï¼Œä½†æ˜¯åŒºåˆ«æ˜¯å¾ˆå¤§çš„ã€‚ NULL å…¶å®å¹¶ä¸æ˜¯ç©ºå€¼ï¼Œè€Œæ˜¯è¦å ç”¨ç©ºé—´ï¼Œæ‰€ä»¥mysqlåœ¨è¿›è¡Œæ¯”è¾ƒçš„æ—¶å€™ï¼ŒNULL ä¼šå‚ä¸å­—æ®µæ¯”è¾ƒï¼Œæ‰€ä»¥å¯¹æ•ˆç‡æœ‰ä¸€éƒ¨åˆ†å½±å“</p>
</blockquote>
<ul>
<li><a href="https://blog.51cto.com/u_3303362/3795308">nullå’Œç©ºçš„åŒºåˆ«</a></li>
</ul>
<p>é‚£ä»€ä¹ˆæ—¶å€™ç”¨nullä»€ä¹ˆæ—¶å€™ç”¨ç©ºå€¼å‘¢ï¼Ÿ</p>
<blockquote>
<p>æ›´æ¨èä½¿ç”¨ç©ºå€¼ã€‚ä¸¤è€…çš„å«ä¹‰ä¸ä¸€æ ·ï¼Œå‰è€…ä»£è¡¨ä¸æ¸…æ¥šï¼Œåè€…ä»£è¡¨ç¼ºå¤±å€¼ã€‚ä½†å®é™…ä½¿ç”¨ä¸Šnullä¼šåœ¨æ•°æ®åº“æ“ä½œæ–¹é¢é€ æˆå¾ˆå¤šçš„éº»çƒ¦ï¼Œå› æ­¤æ›´æ¨èè®¾ç½®ä¸ºç©ºå€¼ï¼Œå¹¶ä¸”å­—æ®µè®¾ç½®ä¸º<code>NOT NULL</code></p>
</blockquote>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[djangoå­¦ä¹  -- å¯ä»¥æ„Ÿå—åˆ°æœ€åŸå§‹çš„djangoæ¡†æ¶æ˜¯å‰åç«¯ä¸åˆ†ç¦»çš„ -- part.1]]></title>
        <id>http://localhost:4000/post/lin-shi-ji-lu/</id>
        <link href="http://localhost:4000/post/lin-shi-ji-lu/">
        </link>
        <updated>2023-06-26T16:21:01.000Z</updated>
        <content type="html"><![CDATA[<ul>
<li>
<h2 id="å­¦ä¹ è§†é¢‘"><strong><a href="https://www.bilibili.com/video/BV1NL41157ph/?p=45&amp;spm_id_from=pageDriver&amp;vd_source=c66937bc5207a56bafe7811cb2b0c4da">å­¦ä¹ è§†é¢‘</a></strong></h2>
</li>
</ul>
<h3 id="1è¯·æ±‚å’Œå“åº”">1.è¯·æ±‚å’Œå“åº”</h3>
<ul>
<li>get post redirect</li>
</ul>
<h3 id="2æ•°æ®åº“æ“ä½œ">2.æ•°æ®åº“æ“ä½œ</h3>
<ul>
<li>mysql+pymsql</li>
<li>ORMæ¡†æ¶ -&gt; å¸®åŠ©æˆ‘ä»¬å¤„ç†sqlè¯­å¥ =&gt; pip install mysqlclient<br>
åˆ›å»ºä¿®æ”¹åˆ é™¤æ•°æ®ä¸­çš„è¡¨ï¼ˆä¸ç”¨å†™sqlè¯­å¥ï¼‰<br>
æ“ä½œè¡¨ä¸­çš„æ•°æ®<br>
=&gt; åˆ›å»ºæ•°æ®åº“ djangoè¿æ¥æ•°æ®<br>
PS. éœ€è¦åœ¨setting.pyè¿›è¡Œè®¾ç½®</li>
</ul>
<h3 id="3è®©djangoå¸®åŠ©åˆ›å»ºæ•°æ®åº“è¡¨">3.è®©djangoå¸®åŠ©åˆ›å»ºæ•°æ®åº“è¡¨</h3>
<ul>
<li>djangoä¼šé€šè¿‡modelä¸­çš„ç±»å¸®åŠ©ç”Ÿæˆsqlåˆ›å»ºè¡¨å’Œå­—æ®µ<br>
ç±»åä»£è¡¨è¡¨æ˜ å±æ€§ä»£è¡¨åˆ—å</li>
</ul>
<pre><code class="language-python">class UserInfo(models.Model):
    name = models.CharField(max_length=32)
    password = models.CharField(max_length=64)
</code></pre>
<h3 id="4æ‰§è¡Œå‘½ä»¤">4.æ‰§è¡Œå‘½ä»¤</h3>
<ul>
<li>éœ€è¦æå‰æ³¨å†Œapp -&gt; åœ¨setting.pyä¸­æ³¨å†Œ<br>
python manage.py makemigrations<br>
python manage.py migrate</li>
</ul>
<h3 id="5éœ€è¦æ³¨æ„">5.éœ€è¦æ³¨æ„</h3>
<ul>
<li>åœ¨å·²ç»æœ‰çš„modelç±»ä¸­æ·»åŠ å±æ€§ å¯èƒ½ä¼šå¯¼è‡´åŸæ¥å·²ç»æœ‰çš„æ•°æ®ç¼ºå¤±æ–°å¢åŠ çš„åˆ—çš„æ•°æ®<br>
djangoç»™å‡ºäº†ä¸¤ä¸ªé€‰æ‹©ï¼Œä¸€æ˜¯åœ¨å‘½ä»¤è¡Œä¸­é»˜è®¤æ·»åŠ è¾“å…¥ï¼ŒäºŒæ˜¯åœ¨æ–°å¢åŠ çš„å±æ€§å­—æ®µä¸­å¢åŠ  <code>default=</code>å­—æ®µï¼Œä»£è¡¨ç»™åŸæ¥æ²¡æœ‰çš„ç¼ºå¤±å€¼èµ‹å€¼ã€‚ä¾‹å¦‚ï¼š<br>
<code>age = models.CharField(defalut=18)</code><br>
æˆ–è€…è®¾ç½®å¯ä»¥ä¸ºç©º<br>
<code>age = models.CharField(null=True,blank=True)</code></li>
</ul>
<h3 id="6é€šè¿‡djangoå‘è¡¨ä¸­æ’å…¥æ•°æ®">6.é€šè¿‡djangoå‘è¡¨ä¸­æ’å…¥æ•°æ®</h3>
<ul>
<li>
<p><code>UserInfo.objects.create(name='cyanine',password=&quot;123456&quot;)</code> æ’å…¥æ•°æ® éœ€è¦ç±»ä¸­çš„å±æ€§å¯¹åº”<br>
<code>a = UserInfo.objects.all()</code>è·å–æ‰€æœ‰æ•°æ® ä»¥åˆ—è¡¨è¿”å›ï¼Œå…¶ä¸­æ¯ä¸€ä¸ªå…ƒç´ éƒ½æ˜¯ä¸€ä¸ªå¯¹è±¡ é€šè¿‡<code>.å±æ€§</code>è·å–å…·ä½“çš„æ•°æ®<code>a.name</code>ï¼Œç»“åˆ<code>.filter()</code>å¯ä»¥è¿›è¡Œç­›é€‰æŸ¥è¯¢<br>
<code>.first()</code>è·å–è·å–åˆ°çš„ç¬¬ä¸€ä¸ªå¯¹è±¡</p>
</li>
<li>
<p>åˆ é™¤æ•°æ®<br>
<code>.delete()</code><br>
å¯ä»¥æ·»åŠ <code>filter</code>è¿›è¡Œç­›é€‰ ä¾‹å¦‚<code>UserInfo.objects.filter(name='cyanine').delete()</code> åˆ é™¤æ‰€æœ‰nameä¸ºcyanineçš„æ•°æ®<br>
ä½¿ç”¨<code>.all()</code>é€‰æ‹©å…¨éƒ¨<code>UserInfo.objects.all().delete()</code>åˆ é™¤è¿™å¼ è¡¨ä¸­çš„æ‰€æœ‰æ•°æ®</p>
</li>
<li>
<p>æ›´æ–°æ•°æ®<br>
<code>UserInfo.objects.all().updata(password=123456)</code>æ›´æ–°æ‰€æœ‰çš„passwordä¸º123456<br>
è¿˜å¯ä»¥ç»“åˆ<code>.filter()</code>è¿›è¡Œç­›é€‰</p>
</li>
</ul>
<h3 id="7djangoè¡¨å•å¦‚æœä¸å†™action-é‚£ä¹ˆé»˜è®¤æäº¤å°±æ˜¯å‘å½“å‰é¡µé¢å‘é€ä¸€ä¸ªpostè¯·æ±‚">7.djangoè¡¨å•å¦‚æœä¸å†™action é‚£ä¹ˆé»˜è®¤æäº¤å°±æ˜¯å‘å½“å‰é¡µé¢å‘é€ä¸€ä¸ªpostè¯·æ±‚</h3>
<h3 id="8djangoä¸­çš„urlå‘½åèƒ½é¿å…å¯¹urlçš„ç¡¬ç¼–ç ">8.djangoä¸­çš„urlå‘½åèƒ½é¿å…å¯¹urlçš„ç¡¬ç¼–ç ï¼Œ</h3>
<ul>
<li>ä¾‹å¦‚ä¿®æ”¹ä¸€ä¸ªurl çš„è·¯å¾„å¦‚æœä»¥å‰åœ¨htmlé‡‡ç”¨çš„æ˜¯ç¡¬ç¼–ç ï¼Œç›´æ¥å†™å¯¹åº”çš„ä¼šå¯¼è‡´åé¢ä¿®æ”¹ç»´æŠ¤æä¸ºå›°éš¾ã€‚<br>
ä½†æ˜¯å¦‚æœé‡‡ç”¨urlå‘½åç©ºé—´ï¼Œé‚£ä¹ˆä¿®æ”¹çš„urlå¹¶ä¸ä¼šç›´æ¥å½±å“åˆ°ï¼Œdjangoä¼šé€šè¿‡urlçš„å‘½åè®¿é—®åˆ°ï¼Œè€Œä¸æ˜¯ç¡¬ç¼–ç ã€‚<code>{% url 'url_name' other_param%}</code>  è¿™ä¸ªurl_name å°±æ˜¯åœ¨urls.pyæ–‡ä»¶ä¸­çš„<code>path('url/example', views.function,name = url_name)</code>çš„nameä¸ºurlä»çš„é‡å‘½åï¼Œè¿™æ ·ä¿®æ”¹pathå¯¹åº”çš„urlï¼Œå°±ä¸ç”¨åœ¨ç»´æŠ¤å‰ç«¯çš„é¡µé¢äº†ã€‚</li>
</ul>
<h3 id="9modelæ·»åŠ çº¦æŸ-æ•°æ®åº“çš„çº¦æŸ">9.modelæ·»åŠ çº¦æŸ (æ•°æ®åº“çš„çº¦æŸ)</h3>
<ul>
<li>ä¾‹å¦‚å‘˜å·¥è¡¨å’Œéƒ¨é—¨è¡¨ä¹‹é—´çš„å…³ç³»ï¼Œè®©å‘˜å·¥è¡¨å’Œéƒ¨é—¨è¡¨å…³è”ï¼Œé€šè¿‡<code>ForeignKry</code>æ–¹æ³•ä¸­çš„<code>to</code>å’Œ<code>to_field</code>å‚æ•°åœ¨djangoä¸­è®¾ç½®ã€‚ç”¨é€”æ˜¯å¯ä»¥æ–¹ä¾¿å¯¹è¾“å…¥æ•°æ®çš„åˆæ³•æ€§åˆ¤æ–­ï¼Œä¾‹å¦‚å‘˜å·¥ä¸èƒ½å±äºä¸€ä¸ªä¸å­˜åœ¨çš„éƒ¨é—¨ï¼Œå°±å¯ä»¥å¾ˆæ–¹ä¾¿çš„è¿›è¡Œåˆ¤æ–­ã€‚</li>
<li>åœ¨å‘˜å·¥è¡¨ä¸­<br>
<code>department = models.ForeignKey(to = 'Department', to_field = 'id')</code><br>
è¿™å°±å°†å‘˜å·¥è¡¨å’Œéƒ¨é—¨è¡¨è¿›è¡Œäº†å…³è”ï¼Œå‘˜å·¥çš„éƒ¨é—¨åªèƒ½å±äºDepatmentä¸­çš„ä¸€ä¸ªï¼›<code>to</code>è¡¨ç¤ºå…³è”çš„è¡¨åï¼Œ<code>to_field</code>è¡¨æ˜å…³è”çš„è¡¨çš„ä¸€ä¸ªåˆ—åå­—æ®µã€‚è¦æ³¨æ„çš„æ˜¯ï¼Œdjangoåœ¨å‚¨å­˜è¿™æ ·çš„å­—æ®µæ—¶é»˜è®¤å‘½åæ–¹å¼æ˜¯<code>å…³è”è¡¨å_id</code>ï¼ˆä¾‹å¦‚è¿™ä¸ªå°±æ˜¯<code>depaetment_id</code>ï¼‰ã€‚<br>
äºæ­¤å¯¹åº”ï¼Œåœ¨è·å–çš„æ—¶å€™ï¼Œå¦‚æœç›´æ¥é€šè¿‡å­—æ®µ/å±æ€§è·å–çš„è¯ï¼Œä¾‹å¦‚<code>obj.è”è¡¨å_id</code>ï¼Œè·å–åˆ°çš„æ—¶å‚¨å­˜åœ¨è¿™å¼ è¡¨ä¸­çš„å¯¹åº”å…³è”è¡¨çš„æ•°å­—ï¼Œè€Œä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„å…·ä½“æŒ‡ä»£ï¼Œå› æ­¤djangoè§„å®šäº†å¦‚æœç›´æ¥<code>.è”è¡¨å</code>å°±å¯ä»¥è·å–åˆ°å…³è”è¡¨å¯¹åº”çš„é‚£ä¸€è¡Œæ•°æ®ï¼ˆå°è£…ä¸ºä¸€ä¸ªqueryobjå¯¹è±¡ï¼‰ï¼Œç„¶åå°±å¯ä»¥ç»§ç»­é€šè¿‡å…³è”è¡¨å†…çš„å±æ€§è¿›è¡ŒæŸ¥æ‰¾ã€‚ä¾‹å¦‚ï¼Œéƒ¨é—¨è¡¨ä¸­ä¸€å…±æœ‰ä¸¤ä¸ªéƒ¨é—¨ï¼Œå­—æ®µä¸ºï¼ˆid,éƒ¨é—¨åï¼‰ï¼Œå†…å®¹ä¸ºï¼ˆ1ï¼Œä¸»ç®¡éƒ¨ï¼‰ï¼ˆ2ï¼Œè¿è¡Œéƒ¨ï¼‰ï¼Œå‘˜å·¥è¡¨å…³è”</li>
<li>çº§è”åˆ é™¤ ç½®ç©ºnull<br>
ç°åœ¨è®¾æƒ³ä¸€ç§æƒ…å†µï¼Œå¦‚æœéƒ¨é—¨è¡¨ä¸­çš„ä¸€ä¸ªéƒ¨é—¨å–æ¶ˆæ‰ï¼Œé‚£ä¹ˆä¸ä¹‹å…³è”çš„å‘˜å·¥åº”è¯¥å¦‚ä½•å¤„ç†å‘¢ï¼Ÿå¸¸ç”¨çš„å°±æ˜¯ä¸¤ç§æ“ä½œï¼šå°†ä»–ä»¬ä¸€å¹¶åˆ é™¤ï¼ˆè¿™å°±æ˜¯çº§è”åˆ é™¤ï¼‰ï¼›è¿˜æœ‰ä¸€ç§å°±æ˜¯å°†ä»–ä»¬è®¾ç½®ä¸ºnullã€‚å¯¹åº”çš„è¿™ä¸¤ç§æ–¹å¼åœ¨djangoä¸­éœ€è¦è¿™æ ·è®¾ç½®ï¼š<br>
<code>department = models.ForeignKey(to = 'Department', to_field = 'id',on_delete=models.CASCADE)</code> çº§è”åˆ é™¤<br>
<code>department = models.ForeignKey(to = 'Department', to_field = 'id',null=True,blank=True,on_delete=models.SET_NULL)</code> ç½®ç©º  éœ€è¦æ³¨æ„çš„æ˜¯ ç½®ç©ºçš„å‰æå°±æ˜¯è¿™ä¸ªå­—æ®µå¯ä»¥ä¸ºç©º<code>null = True</code> è¿™äº›éƒ½æ˜¯djangoä¸­çš„æ“ä½œã€‚</li>
</ul>
<h3 id="10æ€§åˆ«å­˜å‚¨">10.æ€§åˆ«å­˜å‚¨</h3>
<ul>
<li>modelçš„choice ä¸æ•°æ®åº“æ— å…³ æ˜¯djangoçš„ç‰¹æ€§ å¯ä»¥æ–¹ä¾¿çš„è¿›è¡Œå›ºå®šçš„é€‰æ‹©å‚¨å­˜ã€‚ä¾‹å¦‚ç”·å¥³ï¼Œå•ç‹¬ä¸ºç”·å¥³æ·»åŠ ä¸€ä¸ªcharå­—æ®µä¼šè¾ƒä¸ºæµªè´¹ç©ºé—´ï¼Œå› æ­¤ä½¿ç”¨1/2è¿™æ ·çš„æ•°å­—ä»£æ›¿ï¼Œä½†æ˜¯æ•°å­—ä¸æ˜“è¯»ï¼Œå› æ­¤djangoè®¾è®¡å‡ºäº†<code>choice</code>å‚æ•°ã€‚</li>
</ul>
<pre><code class="language-python">gender_choice = (
    (1,'ç”·'),
    (2,'å¥³'),
) #æ³¨æ„æ˜¯å…ƒç»„å¥—å…ƒç»„
gender = models.SmallIntegerField(verbose_name='æ€§åˆ«',choices = gender_choice) #verbose_nameå°±æ˜¯å¯¹åˆ—åï¼ˆå±æ€§ï¼‰çš„æ³¨è§£ å¯å†™å¯ä¸å†™ å†™ä¸Šä¸ºå¥½
#SmallIntegerFieldæ˜¯å°æ•´æ•°å­—æ®µ
</code></pre>
<ul>
<li>è¿™æ ·å­—æ®µçš„è·å–ï¼šå¦‚æœç›´æ¥<code>obj.gender</code>è·å–çš„å°±æ˜¯æ•°æ®åº“ä¸­å¯¹åº”çš„æ•°å­—ï¼Œä½†æ˜¯djangoå°è£…äº†ä¸€ä¸ªåˆ¤æ–­æ–¹æ³•ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿çš„å¸®æˆ‘ä»¬åˆ¤æ–­ï¼Œç„¶åè¿”å›çš„æ˜¯æˆ‘ä»¬å¸Œæœ›ç°å®çš„å­—æ®µï¼š<code>obj.get_gender_display()</code>ã€‚å…¶ä¸­å‡½æ•°åå­—ç»„æˆæ–¹å¼ä¸º<code>get_å±æ€§åå­—/å­—æ®µåå­—_display()</code></li>
</ul>
<h3 id="11formå’Œmodelform">11.Formå’ŒModelForm</h3>
<ul>
<li>11.1 formç±» è‡ªåŠ¨ç”Ÿæˆè¡¨å•</li>
</ul>
<pre><code class="language-python">#views.py
class MyForm(Form):
    user = forms.CharField(widget=forms.Input)
    password = forms.CharField(widget=forms.Input)
    email = forms.CharField(widget=forms.Input)
def user_add(request):
    form = MyForm() #å®åŠ›åŒ–ä¸€ä¸ªformè¡¨å•ç±»
    return renderï¼ˆrequest,'user_add.html',{'form':form}
</code></pre>
<pre><code class="language-html">&lt;!-- user_add.html --&gt;
&lt;form method='post'&gt;
{% for i in form %}
{{ i }}
{% endfor %}
&lt;!-- æˆ–è€…ä¹Ÿå¯ä»¥ä¸€ä¸ªä¸€ä¸ªè‡ªå·±å†™å‡ºæ¥ æ¯”å¦‚{{form.user}} {{form.password}} --&gt;
&lt;/form&gt;
</code></pre>
<ul>
<li>11.2 ModelFormç»„ä»¶
<ul>
<li>å®ç°æ•°æ®åº“è¡¨å•å­—æ®µå’Œå‰ç«¯formè¡¨å•å­—æ®µçš„è‡ªåŠ¨ç”Ÿæˆ</li>
</ul>
<ul>
<li>å¯¹è¿æ¥è¡¨/å¤–é”®é™åˆ¶è‡ªåŠ¨ç”Ÿæˆé€‰æ‹©æ¡†</li>
<li>å®šä¹‰modelsç±»ä¸­çš„<code>__str__</code>æ–¹æ³•å®ç°å¯¹è¿æ¥è¡¨å±æ€§çš„ç›´æ¥å±•ç¤º</li>
<li>å®šä¹‰ç”Ÿæˆè¡¨å•æ ·å¼çš„å±æ€§</li>
<li><code>{{ obj.label }}</code>å¯ä»¥éå†å‡ºåœ¨modelformå®šä¹‰å­—æ®µä¸­çš„<code>label</code>å‚æ•°<br>
æ¥ä¸‹æ¥æ˜¯å…·ä½“çš„ä»£ç å±•ç¤º æœ‰ç‚¹å¤ªå¤šäº†...<br>
è®°å¾—æ·»åŠ äº†è·¯ç”±ï¼ï¼ï¼ï¼ˆè¿™ä¸ªå°±ä¸å±•ç¤ºåœ¨ä»£ç ä¸­äº†ï¼Œï¼‰</li>
</ul>
</li>
</ul>
<pre><code class="language-python">#views.py
#æ ¹æ®staffè¡¨å•ç”Ÿæˆmodelformç±»
class staffMdoelForm(ModelForm):
    class Meta:
        model = Staff
        fields = ['name','age','gender','phonenumber','create_time']

#æ·»åŠ å‘˜å·¥
def staff_add(request):
    form = staffMdoelForm() #å®ä¾‹åŒ–modelformç±» 
    return render(request,'staff_add.html',{
        'form':form
        })
</code></pre>
<pre><code class="language-html">&lt;div style=&quot;width:50%;margin-left: 25%;margin-top: 25px;&quot;&gt;
    &lt;div class=&quot;container&quot; &gt;
        &lt;form method=&quot;post&quot;&gt;
            &lt;h2&gt;æ·»åŠ æ–°çš„å‘˜å·¥ä¿¡æ¯&lt;/h2&gt;
            {% csrf_token %}
            {% for field in form %}
            &lt;div class=&quot;mb-3&quot;&gt;
                &lt;label class=&quot;form-label&quot;&gt;{{field.label}}&lt;/label&gt;
                {{ field }}
            &lt;/div&gt;
            {% endfor %}
            &lt;button type=&quot;submit&quot; class=&quot;btn btn-primary&quot;&gt;ç¡®è®¤æ·»åŠ &lt;/button&gt;
        &lt;/form&gt;
    &lt;/div&gt;    
&lt;/div&gt;
</code></pre>
<pre><code class="language-python">#è¿æ¥è¡¨modelformå¤„ç†ï¼ˆhtmlä¸ç”¨åšå¤ªå¤šæ”¹å˜ï¼‰
#åœ¨models.pyä¸­çš„ä»è¡¨æ·»åŠ __str__æ–¹æ³• è®©è°ƒç”¨è¿™ä¸ªç±»çš„æ—¶å€™è¿”å›çš„ä¸å†æ˜¯ä¸€ä¸ªqueryobjectè€Œæ˜¯__str__å®šä¹‰å¥½çš„è¿”å›å€¼
class Staff(models.Model):
    name = models.CharField(verbose_name='å‘˜å·¥å§“å',max_length=32)
......
    def __str__(self):
        return self.name
#åœ¨views.pyä¸­å®šä¹‰modelformç±»çš„æ—¶å€™ å­—æ®µé€‰æ‹©ç›´æ¥å†™å®šä¹‰çš„è€Œä¸æ˜¯åœ¨æ•°æ®åº“è¡¨å•ä¸­çš„å­—æ®µ
class userModelForm(ModelForm):
    class Meta:
        model = UserInfo #æ³¨ Userinfoè¡¨å•ä¸­çš„identifyæ˜¯å¼•ç”¨äº†Staffè¡¨å•ä¸­çš„idä½œä¸ºå¤–é”®
        fields = ['name','password','identify']
</code></pre>
<h3 id="12é‡å®šå‘">12.é‡å®šå‘</h3>
<ul>
<li><code>from django.shortcuts import redirect</code>æˆ–è€…<code>from django.http import HttpResponseRedirect</code><br>
returnä¸€ä¸ªé‡å®šå‘urlçš„å®ä¾‹å³å¯</li>
</ul>
<h3 id="13å‰ç«¯urlå®ç°åˆ é™¤è¯·æ±‚">13.å‰ç«¯urlå®ç°åˆ é™¤è¯·æ±‚</h3>
<ul>
<li>é€šè¿‡å‰ç«¯å‘é€ä¸€ä¸ªå¸¦æœ‰åˆ é™¤ç›®æ ‡ä¿¡æ¯çš„GETè¯·æ±‚ï¼Œç„¶ååç«¯è·å–åˆ é™¤å³å¯ï¼Œä½†æ˜¯è¿™ä¸ªå¸¦æœ‰åˆ é™¤ç›®æ ‡ä¿¡æ¯çš„urlè¯¥å¦‚ä½•ç»„è£…å‘¢ï¼Ÿé€šè¿‡urlçš„ç»„æˆè§„å¾‹ï¼Œæ·»åŠ <code>/?id=</code>ä¿¡æ¯ä¼ é€’ï¼Œä»£ç å¦‚ä¸‹ï¼š<br>
<code>&lt;a href=&quot;/login/manage/delete/?id={{user.0}}&quot;&gt;åˆ é™¤&lt;/a&gt;</code>  #è¿™å…¶ä¸­çš„{{id.0}}é€šè¿‡djangoçš„æ¨¡æ¿è¯­æ³•åŠ¨æ€èµ‹äºˆç›®æ ‡çš„idä¿¡æ¯<br>
å¯¹åº”å¤„ç†å‡½æ•°ï¼ˆè®°å¾—æ³¨å†Œurlï¼‰</li>
</ul>
<pre><code class="language-python">def delete_user_info(request):
    id = request.GET.get('id')
    UserInfo.objects.filter(id = id).delete()
    return HttpResponseRedirect('/login/manage/')
</code></pre>
<h3 id="14djangoçš„æ¨¡æ¿è¯­æ³•">14.djangoçš„æ¨¡æ¿è¯­æ³•</h3>
<ul>
<li>å…¶ä¸­æœ€å¼€å§‹çš„<code>{% extends 'nav.html'%}</code>å¿…é¡»å¤„äºå­é¡µé¢çš„ç¬¬ä¸€ä¸ªåŠ è½½ä½ç½®ï¼Œæ„å‘³ç€å¦‚æœå‰é¢æœ‰å“ªæ€•<code>{% load static %}</code>ä¹Ÿä¼šæŠ¥é”™ã€‚</li>
</ul>
<h3 id="15djangoæ­£åˆ™åŒ¹é…url">15.djangoæ­£åˆ™åŒ¹é…url</h3>
<ul>
<li>è¿™æ ·å°±ä¸ç”¨å‰ç«¯å†™å¸¦æœ‰getå‚æ•°çš„urlï¼Œåç«¯ä¹Ÿä¸éœ€è¦getè·å–,è€Œæ˜¯ç›´æ¥ä½œä¸ºä¸€ä¸ªè§£æå¥½çš„å‚æ•°ä¼ é€’ç»™è§†å›¾è¿›è¡Œå¤„ç†ï¼ŒäºŒæ˜¯ç›´æ¥åŠè¿›è¡Œè¯·æ±‚å’Œè§£æã€‚åŒæ—¶ä¹Ÿè¦æ³¨æ„ï¼Œåœ¨urlä¸­æ·»åŠ çš„æ­£åˆ™é¡ºåºä¸å½±å“åœ¨å‘½åurlä¸­çš„å‚æ•°é¡ºåº</li>
</ul>
<ul>
<li>å…·ä½“å¦‚ä¸‹ï¼š</li>
</ul>
<pre><code class="language-python">#htmlä¸­
&lt;a href=&quot;{% url 'edit' user.0 %}&quot;&gt;æ“ä½œ...&lt;/a&gt;
#urlä¸­
path('login/manage/&lt;int:id&gt;/edit/',views.edit_user_info,name = 'edit')
#viewsä¸­
def edit_user_info(request,id):
    default_userinfo = UserInfo.objects.filter(id = id).first()
    ....
</code></pre>
<p>å¯ä»¥çœ‹åˆ°<code>&lt;int:id&gt;</code>æ˜¯åœ¨<code>/edit/</code>ä¹‹å‰çš„ï¼Œä½†æ˜¯åœ¨htmlçš„urlä¸­è¿™ä¸ªé¡ºåºä¸å½±å“ã€‚åŒæ—¶åœ¨viewsä¸­å¯¹åº”çš„å‡½æ•°å¯ä»¥ç›´æ¥æ¥æ”¶åˆ°urlä¸­æ­£åˆ™åŒ¹é…åˆ°çš„å‚æ•°ï¼Œè€Œä¸ç”¨å†é€šè¿‡è§£ægetè¯·æ±‚è·å–ã€‚</p>
<h3 id="16åœ¨djangoçš„æ¨¡æ¿ä¸­å¯ä»¥é€šè¿‡objget_è”è¡¨å_displayè·å–åˆ°å’Œåç«¯get_è”è¡¨å_displayçš„æ•ˆæœç›´æ¥è¿”å›å¯¹ç…§è¿‡åçš„ç»“æœè€Œä¸æ˜¯å¯¹åº”çš„å…³è”id">16.åœ¨djangoçš„æ¨¡æ¿ä¸­ï¼Œå¯ä»¥é€šè¿‡<code>obj.get_è”è¡¨å_display</code>è·å–åˆ°å’Œåç«¯<code>get_è”è¡¨å_display()</code>çš„æ•ˆæœï¼Œç›´æ¥è¿”å›å¯¹ç…§è¿‡åçš„ç»“æœè€Œä¸æ˜¯å¯¹åº”çš„å…³è”idã€‚</h3>
<h3 id="17djangoçš„æ¨¡æ¿å¯ä»¥è¿›è¡Œçš„é¢å¤–æ“ä½œ">17.djangoçš„æ¨¡æ¿å¯ä»¥è¿›è¡Œçš„é¢å¤–æ“ä½œï¼š</h3>
<ul>
<li><code>{{number : add 1}}</code>å°±æ˜¯pythonçš„<code>+=1</code>æ“ä½œï¼Œ<code>{{datetime | date :'Y-m-d}}</code>å°±æ˜¯pythonä¸­çš„<code>strftime()</code>å‡½æ•°(è¦æ³¨æ„çš„æ˜¯é‡Œé¢çš„æ ¼å¼ä¸éœ€è¦å¸¦<code>%</code>)</li>
</ul>
<h3 id="18modelformçš„å­—æ®µæ ¡éªŒå‡½æ•°">18.modelformçš„å­—æ®µæ ¡éªŒå‡½æ•°</h3>
<ul>
<li><code>is_valid()</code>æ£€éªŒæäº¤postè¯·æ±‚ä¸­çš„formè¡¨å•ä¸­çš„å­—æ®µæ˜¯å¦ä¸ºç©ºï¼Œå…·ä½“çš„å­—æ®µå°±æ˜¯åœ¨<code>modelform</code>ä¸­<code>fields</code>åˆ—è¡¨å®šä¹‰çš„é‚£äº›.</li>
<li>åŒæ—¶è¿˜å¯ä»¥åœ¨modelformsç±»ä¸­è¿›è¡Œå­—æ®µæ ¡éªŒ é”™è¯¯çš„ä¿¡æ¯ä¼šä¿å­˜åœ¨ç”¨postè¯·æ±‚å®ä¾‹åŒ–çš„modelformä¸­ã€‚</li>
</ul>
<pre><code class="language-python">class staffMdoelForm(ModelForm):
    phonenumber = forms.CharField(label='ç”µè¯å·ç ',max_length=11,min_length=11)#è¿›è¡Œçš„å­—æ®µæ ¡éªŒ 
    #è§„å®šç”µè¯å·ç çš„é•¿åº¦ä¸º11ä½
    #è¿˜å¯ä»¥é€šè¿‡validatorså‚æ•°è¿›è¡Œæ­£åˆ™ç­›é€‰
    class Meta:
        model = Staff
        fields = ['name','age','gender','phonenumber','create_time']
    phonenumber = forms.CharField(label='ç”µè¯å·ç ',max_length=11,min_length=11)
    #è§„å®šç”µè¯å·ç çš„é•¿åº¦ä¸º11ä½
    #è¿˜å¯ä»¥é€šè¿‡validatorså‚æ•°è¿›è¡Œæ­£åˆ™ç­›é€‰
</code></pre>
<h3 id="19è°ƒæ•´è¿”å›çš„æç¤ºä¿¡æ¯ä¸ºæ±‰è¯­">19.è°ƒæ•´è¿”å›çš„æç¤ºä¿¡æ¯ä¸ºæ±‰è¯­</h3>
<ul>
<li>é€šè¿‡ä¿®æ”¹setting.pyæ–‡ä»¶ä¸­çš„è¯­è¨€é¡¹</li>
</ul>
<pre><code class="language-python">#setting.py
# LANGUAGE_CODE = &quot;en-us&quot; æ³¨é‡Šæ‰
LANGUAGE_CODE = &quot;zh-hans&quot; #æ·»åŠ 
</code></pre>
<h3 id="20modelformä¸­instanceå‚æ•°">20.modelformä¸­<code>instance</code>å‚æ•°</h3>
<ul>
<li>é€šè¿‡è®¾ç½®å•æ¡æ•°æ®å¯¹è¡¨å•è¿›è¡Œå¡«å……ï¼Œä¾‹å¦‚ï¼š</li>
</ul>
<pre><code class="language-python">#views.pyä¸­çš„ä¸€ä¸ªæ–¹æ³•
default_userinfo = UserInfo.objects.filter(id = id).first() #æ ¹æ®idåœ¨æ•°æ®åº“ä¸­è·å–å¯¹åº”çš„ä¸€æ¡æ•°æ®
userform = userModelForm(instance=default_userinfo) # é€šè¿‡instanceå‚æ•°è®¾å®šä¸€ä¸ªå®ä¾‹åŒ–çš„è¡¨å• è®©ä»–åœ¨å‰ç«¯æ¸²æŸ“çš„æ—¶å€™è‡ªåŠ¨åœ¨valueä¸Šæ˜¾ç¤ºä»æ•°æ®åº“ä¸­æ‹¿åˆ°çš„é»˜è®¤å€¼
</code></pre>
<ul>
<li>é€šè¿‡<code>instance</code>å‚æ•°å’Œ<code>data</code>å‚æ•°å¯ä»¥å®ç°æ•°æ®åº“æ•°æ®çš„æ›´æ–°</li>
</ul>
<pre><code class="language-python">#åœ¨views.pyä¸­çš„æŸä¸ªå‡½æ•°
default_userinfo = UserInfo.objects.filter(id = id).first()
userform = userModelForm(data=request.POST,instance=default_userinfo)
if userform.is_valid():
    userform.save()
    return redirect('/login/manage/')
else:
    return render(request,'edit_info.html',{
        'userform': userform,
    })
</code></pre>
<ul>
<li>å¦‚æœæƒ³åœ¨ç”¨æˆ·è¾“å…¥ä»¥å¤–çš„å­—æ®µè¿›è¡Œæ›´æ–°ï¼Œé‚£ä¹ˆåœ¨modelformå®ä¾‹åŒ–ä¹‹åé€šè¿‡<code>instacne</code>å±æ€§å¯ä»¥ä¿®æ”¹ï¼š</li>
</ul>
<pre><code class="language-python">userform = userModelForm(data=request.POST,instance=default_userinfo)
# useform.instance.å­—æ®µ =  å€¼
</code></pre>
<h3 id="21djangoæŸ¥è¯¢æ’åº">21.djangoæŸ¥è¯¢æ’åº</h3>
<ul>
<li><code>obj.objects.all().order_by('å±æ€§å')</code><br>
å¦‚æœç»™å±æ€§åå‰é¢æ·»åŠ å‡å· ä»£è¡¨é€†å‘ï¼ˆé«˜åˆ°ä½ï¼‰æ’åº</li>
</ul>
<h3 id="22ç»™åŸæœ‰çš„è¡¨ä¸­æ·»åŠ æ–°çš„å­—æ®µäº§ç”Ÿé”™è¯¯djangocoreexceptionsvalidationerror-error">22.ç»™åŸæœ‰çš„è¡¨ä¸­æ·»åŠ æ–°çš„å­—æ®µäº§ç”Ÿé”™è¯¯<code>&quot;django.core.exceptions.ValidationError&quot; error</code></h3>
<ul>
<li>äº§ç”ŸåŸå› ï¼šå¤§æ¦‚ç‡æ˜¯å› ä¸ºè¿½åŠ æ–°çš„å­—æ®µè®¾ç½®é»˜è®¤å€¼çš„æ—¶å€™äº§ç”Ÿçš„æ ¼å¼é”™è¯¯ï¼Œä¾‹å¦‚datetimeæ ¼å¼ä½†æ˜¯æ²¡æœ‰è®¾ç½®é»˜è®¤æˆ–è€…é»˜è®¤æ ¼å¼é”™è¯¯ï¼Œé€ æˆè¿™æ ·çš„åŸå› ã€‚</li>
<li>è§£å†³æ–¹æ³•ï¼šé‡ç½®æ‰€æœ‰çš„<code>migrations</code></li>
<li>æ“ä½œï¼šåˆ é™¤migrationsæ–‡ä»¶å¤¹ä¸‹é™¤äº†<code>__init__.py</code>æ–‡ä»¶ä»¥å¤–æ‰€æœ‰çš„æ–‡ä»¶ï¼Œç„¶åé‡æ–°æ‰§è¡Œæ•°æ®åº“è¿ç§»å‘½ä»¤ï¼š<code>python manage.py makemigrations</code>, <code>python manage.py migrate</code></li>
<li>å¦‚æœè¿˜ä¸æˆåŠŸå¯èƒ½æ˜¯å› ä¸ºæ•°æ®åº“ä¸­åŸæœ¬å­˜åœ¨çš„æ•°æ®å¯¼è‡´ï¼Œå°†æ•°æ®åº“æ¸…åº“ï¼ˆæ‰€æœ‰è¡¨åˆ é™¤ï¼‰ï¼Œç„¶ååœ¨æ‰§è¡Œå³å¯ã€‚</li>
</ul>
<h3 id="23djangoæŠ¥é”™orderform-object-has-no-attribute-get">23.djangoæŠ¥é”™<code>'orderForm' object has no attribute 'get'</code></h3>
<ul>
<li>åŸå› æ˜¯åœ¨è®¾ç½®<code>input</code>æ ‡ç­¾çš„æ ·å¼çš„æ—¶å€™é‡å†™çš„çˆ¶ç±»æ–¹æ³•å‡ºé”™ï¼Œå‚æ•°å¤šå†™äº†ä¸€ä¸ª<code>self</code></li>
</ul>
<pre><code class="language-python">#é”™è¯¯æºç 
    def __init__(self,*arg,**kwargs):
        super().__init__(self,*arg,**kwargs)
        for name, field in self.fields.items():
            # print(name,field) #è¿™ä¸ªæ˜¯å±•ç¤º self.fields.items()å¯ä»¥ç›´æ¥æ‹¿åˆ°å®šä¹‰åœ¨Metaä¸­çš„fieldså­—æ®µ
            field.widget.attrs = {'class' : 'form-control'} #ä¸ºç”Ÿæˆçš„è¡¨å•inputèµ‹äºˆcsså±æ€§ 
</code></pre>
<ul>
<li>è§£å†³æ–¹æ³• ï¼š å»æ‰<code>super().__init__(self,*arg,**kwargs)</code>è¿™ä¸€è¡Œä¸­çš„selfå³å¯ï¼Œæ­£ç¡®å†™æ³•ï¼š<br>
<code>  super().__init__(*arg,**kwargs)</code></li>
<li>æ¢ç©¶ä¸€ä¸‹ä¸ºä»€ä¹ˆ<code>super</code>ä¸éœ€è¦<code>self</code>ä½œä¸ºæ–¹æ³•çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼š<br>
å› ä¸º<code>super()</code>æ˜¯ä¸€ä¸ªç±» <a href="https://mozillazg.com/2016/12/python-super-is-not-as-simple-as-you-thought.html#hidsuper">reference</a> -- æ„Ÿè§‰å¥½å¤š...æš‚æ—¶æç½®ä¸€ä¸‹...ğŸ˜–</li>
</ul>
<h3 id="24å…³é—­æµè§ˆå™¨æ ¡éªŒ">24.å…³é—­æµè§ˆå™¨æ ¡éªŒ</h3>
<p>åœ¨formè¡¨å•æ·»åŠ <code>novalidate</code></p>
<pre><code class="language-html">&lt;form method=&quot;post&quot; novalidate &gt;
</code></pre>
<h3 id="25å…³äºmodelsä¸­nullå’Œblackå­—æ®µ">25.å…³äºmodelsä¸­nullå’Œblackå­—æ®µ</h3>
<ul>
<li>éœ€è¦åŒæ—¶å¼€å¯ï¼Œä½†æ˜¯æ•°æ®åº“æ›´æ¨èé»˜è®¤å€¼ä¸ºç©ºå€¼ï¼Œå› æ­¤è®¾ç½®<code>default=None</code>è€Œä¸æ˜¯<code>null</code>ã€‚<br>
å¦‚æœè®¾ç½®<code>blank=True</code>ä½†æ˜¯ä¸å¼€å¯<code>null=True</code>ï¼Œé‚£ä¹ˆåœ¨æ’å…¥çš„æ—¶å€™ï¼Œå¦‚æœä¼ å›æ¥çš„æ•°æ®ä¸ºç©ºï¼Œæ’å…¥ä¼šæŠ¥é”™ä¸èƒ½ä¸ºnullå­—æ®µ...æ€»ä¹‹è¿˜æ˜¯å¾ˆè¿·æƒ‘çš„æŠ¥é”™....ä½†æ˜¯è§£å†³æ–¹æ³•è¿˜æ˜¯æœ€å¥½è®¾ç½®ä¸¤ä¸ªéƒ½ä¸ºTrueå¹¶ä¸”è®¾ç½®é»˜è®¤å­—æ®µä¸º<code>None</code>ã€‚å¦‚æœä¸º<code>null</code>ï¼Œé‚£ä¹ˆåœ¨æ•°æ®ä¼ å…¥åˆ°å‰ç«¯çš„æ—¶å€™ä¼šé»˜è®¤è¾“å‡ºnullæˆ–è€…noneï¼Œè€Œä¸æ˜¯å°†é‚£ç‰‡åŒºåŸŸç½®ç©ºï¼Œå¯¹äºå‰ç«¯çš„ç”¨æˆ·è¾“å…¥é€»è¾‘ä¸å¤ªå‹å¥½ã€‚</li>
</ul>
<h3 id="26modelformsä¾¿æ·å†™æ³•">26.modelformsä¾¿æ·å†™æ³•</h3>
<ul>
<li>åœ¨æ·»åŠ fieldsçš„æ—¶å€™ï¼Œå¯ä»¥ç”¨<code>__all__</code>ä¸€æ¬¡æ€§è·å–å…¨éƒ¨ï¼Œ<code>exclude = [ æ’é™¤çš„å­—æ®µ ]</code>æ’é™¤æ‰ä¸è¦çš„å­—æ®µã€‚</li>
</ul>
<pre><code class="language-python">class orderForm(ModelForm):
    class Meta():
        model = Orderform
        fields = &quot;__all__&quot; #æ³¨æ„è¦å¼•å·
        # exclude = ['å­—æ®µ1','å­—æ®µäºŒ', .... ]
</code></pre>
<h3 id="27åç«¯è¡¨å•æ­£åˆ™æ ¡éªŒ">27.åç«¯è¡¨å•æ­£åˆ™æ ¡éªŒ</h3>
<ul>
<li>åœ¨modelformsç±»ä¸­å£°æ˜å­—æ®µï¼Œç„¶åé€šè¿‡validatorså‚æ•°è®¾ç½®æ­£åˆ™è¡¨è¾¾å¼ï¼š</li>
</ul>
<pre><code class="language-python">from django.core.validators import RegexValidator #éœ€è¦å¯¼å…¥æ­£åˆ™ç±»
class exampleModelForms(forms.ModelForm):
    moblie = forms.CharField(
        label = 'æ‰‹æœºå·ç ',
        validactors = [RegexValidator(r'^1[3-9]\d{9}$','æ‰‹æœºå·æ ¼å¼é”™è¯¯')]       
        #æ ¡éªŒå¤±è´¥è¿”å›åé¢çš„æç¤ºä¿¡æ¯è€Œä¸æ˜¯é»˜è®¤çš„äº†~ 
    )
</code></pre>
<h3 id="28é’©å­æ–¹æ³•è¿›è¡Œå­—æ®µæ ¡éªŒ">28.é’©å­æ–¹æ³•è¿›è¡Œå­—æ®µæ ¡éªŒ</h3>
<ul>
<li><a href="https://www.cnblogs.com/open-yang/p/11223175.html">è¯¦ç»†çš„</a></li>
<li>è¿™é‡Œæ‘˜åˆ—å‡ºå¸¸ç”¨çš„ä»£ç ç»“æœ</li>
</ul>
<pre><code class="language-python">class exampleModelForms(forms.ModelForm):
   def clean_å­—æ®µå(self): #è¿™ä¸ªéœ€è¦åœ¨ä¸€ä¸ªmodelformç±»ä¸­ è¿™ä¸ªå‡½æ•°åmodelformä¼šè‡ªåŠ¨ç”Ÿæˆå¯¹åº”çš„æ–¹æ³•
           pass 
           name = self.cleaned_data.get('name')
           if name=='admin':
               raise ValidationError('adminæ˜¯è¶…çº§ç®¡ç†å‘˜ï¼Œä¸èƒ½æ³¨å†Œï¼')#è¿™ä¸ªé”™è¯¯ä¼šç›´æ¥æ‰”è¿›è¯¥å­—æ®µçš„é”™è¯¯ç±»åˆ«ä¸­ï¼šname.errors
           return self.cleaned_data.get('name')
</code></pre>
<h3 id="29è§„å®šmodelformä¸­ä¸å¯ç¼–è¾‘çš„éƒ¨åˆ†">29.è§„å®šmodelformä¸­ä¸å¯ç¼–è¾‘çš„éƒ¨åˆ†</h3>
<p>åœ¨modelformä¸­å­—æ®µä¸­è®¾ç½®å‚æ•°<code>disabled= True</code>å³å¯ï¼Œè¿™æ ·åœ¨å‰ç«¯é¡µé¢æ¸²æŸ“å‡ºæ¥çš„è¿™ä¸€æ¡å­—æ®µæ˜¯ä¸å¯ä»¥æ›´æ”¹çš„ã€‚</p>
<h3 id="30é€šè¿‡modelformåˆ¤æ–­è¦æ·»åŠ çš„æ•°æ®æ˜¯å¦é‡å¤">30.é€šè¿‡modelformåˆ¤æ–­è¦æ·»åŠ çš„æ•°æ®æ˜¯å¦é‡å¤</h3>
<ul>
<li><code>order_edit_form = orderEditForm().filter(id=ä½ è¦æŸ¥è¯¢çš„).exist()</code> è¿”å›True/False<br>
è¿™ä¸ªæ–¹æ³•éœ€è¦æ·»åŠ åœ¨modelformä¸­çš„é’©å­æ–¹æ³•ä¸­ã€‚</li>
<li>æ’é™¤è‡ªå·±ä»¥å¤–çš„æ˜¯å¦å­˜åœ¨é‡å¤ï¼Ÿ(ä¸»è¦æ˜¯åœ¨ä¿®æ”¹æ•°æ®çš„æ—¶å€™ï¼‰<br>
é€šè¿‡<code>exclude</code>æ’é™¤è‡ªå·±ååˆ¤æ–­ï¼š<code>order_edit_form = orderEditForm().exclude(id='è‡ªå·±çš„id' ).filter(id=ä½ è¦æŸ¥è¯¢çš„).exist()</code> è¿”å›True/False</li>
</ul>
<p>æ€»ç»“ ç¼–è¾‘å’Œæ·»åŠ çš„ä¸åŒ</p>
<h3 id="31æŸ¥è¯¢æ ¹æ®æŸä¸ªå­—çš„ä¸€éƒ¨åˆ†è¿›è¡Œ">31.æŸ¥è¯¢ï¼ˆæ ¹æ®æŸä¸ªå­—çš„ä¸€éƒ¨åˆ†è¿›è¡Œï¼‰</h3>
<ul>
<li><code>filter()</code>è¿˜æ”¯æŒä¼ å…¥å­—å…¸ï¼š</li>
</ul>
<pre><code class="language-python">order_edit_form = orderEditForm().filter(id=ä½ è¦æŸ¥è¯¢çš„,other=ä½ è¦æŸ¥è¯¢çš„)
#ç­‰äº
query_dict = { 'id' : è¦æŸ¥è¯¢çš„, 'other' : è¦æŸ¥è¯¢çš„ }
order_edit_form = orderEditForm().filter(**query_dict)
 #éœ€è¦æ³¨æ„ä¼ å…¥å­—å…¸çš„æ—¶å€™éœ€è¦ä¸¤ä¸ª**
</code></pre>
<p>PS. é€šå¸¸æˆ‘ä»¬å†å˜é‡å‰åŠ ä¸€ä¸ªæ˜Ÿå·(*)è¡¨ç¤ºè¿™ä¸ªå˜é‡æ˜¯å…ƒç»„/åˆ—è¡¨ï¼ŒåŠ ä¸¤ä¸ªæ˜Ÿå·è¡¨ç¤ºè¿™ä¸ªå‚æ•°æ˜¯å­—å…¸</p>
<h3 id="32é—®é¢˜è®°å½•modelformä¸èƒ½æ›´æ–°ä¸€è¡Œæ•°æ®çš„éƒ¨åˆ†å­—æ®µ">32.é—®é¢˜è®°å½•ï¼šmodelformä¸èƒ½æ›´æ–°ä¸€è¡Œæ•°æ®çš„éƒ¨åˆ†å­—æ®µ</h3>
<ul>
<li><a href="https://www.qiniu.com/qfans/qnso-8216353#comments">è§£å†³æ–¹æ³•</a><br>
è¿™é‡Œçš„è§£å†³æ–¹æ³•å¾ˆå¤š åŒ…æ‹¬è‡ªå®šä¹‰é’©å­å‡½æ•°å¯¹postæ•°æ®è¿›è¡Œæ¸…æ™°ã€å®šä¹‰ä¸€ä¸ªå·¥å‚å‡½æ•°å¤„ç†æ¯æ¬¡ä¸åŒçš„å­—æ®µç­‰ï¼Œä¸è¿‡éƒ½å¤ªé«˜ç«¯äº†ï¼Œéƒ¨åˆ†æ¦‚å¿µæˆ‘è¿˜æ²¡æœ‰ç†è§£æ¸…æ¥šğŸ˜­</li>
<li>å› æ­¤æˆ‘æ‰“ç®—é‡‡å–æœ€ç®€å•çš„ -- ä¸€ä¸ªå­—æ®µä¸€ä¸ªå­—æ®µçš„å»<code>update</code>ğŸ˜³ã€‚ æˆ–è€…é‡‡ç”¨dictçš„æ¨¡å¼ï¼Œå¤„ç†ä¸å˜çš„å­—æ®µå’Œæ›´æ–°åçš„å­—æ®µ ç»„åˆæˆä¸ºä¸€ä¸ªæ›´æ–°åçš„å­—å…¸ç„¶åé€šè¿‡modelformä¿å­˜..</li>
<li>æœ€åå‘ç°æ˜¯æˆ‘å®ä¾‹åŒ–å‡ºé”™äº†çš„é—®é¢˜....(çœŸè¯šçš„çœ¼çğŸ˜­)</li>
</ul>
<pre><code class="language-python">    row_object = Orderform.objects.filter(id = id).first() #æ³¨æ„è¿™é‡Œå®ä¾‹åŒ–çš„æ˜¯ä¸€ä¸ªformç±» ä¹‹å‰é”™è¯¯çš„åŸå› æ˜¯è¿™é‡Œä¹Ÿå†™æˆäº†ä¸€ä¸ªmodelformç±» è¿™å°±å¯¼è‡´ä¸‹é¢instanceçš„æ—¶å€™ä¼šæŠ¥é”™ è€Œä¸”é»˜è®¤ä¸æ›´æ–°çš„å‰ç«¯æ•°æ®å®é™…ä¸Šæ˜¯ä¼šä¼ é€’å›æ¥çš„ ä½œä¸ºè¡¨å•çš„é»˜è®¤å€¼
    order_edit_form = orderEditForm(data=request.POST,instance=row_object) 
    #è¿™é‡Œå®ä¾‹åŒ–çš„æ˜¯ä¸€ä¸ªmodelformsç±»
</code></pre>
<h3 id="33djangoçš„æ¡ä»¶æŸ¥è¯¢">33.djangoçš„æ¡ä»¶æŸ¥è¯¢</h3>
<p>é™¤äº†å›ºå®šçš„ç­‰äºï¼ˆ<code>=</code>ï¼‰æŸ¥è¯¢å¤–ï¼Œè¿˜å¯ä»¥é€šè¿‡ç»™å­—æ®µ/å±æ€§æ·»åŠ ä¸‹åˆ’çº¿çš„æ–¹å¼è§„å®šèŒƒå›´æŸ¥è¯¢</p>
<ul>
<li>æ•°å­—æ–¹é¢ï¼šgtã€gteã€ltã€lteï¼šå¤§äºã€å¤§äºç­‰äºã€å°äºã€å°äºç­‰äºã€‚<br>
<code>list = BookInfo.objects.filter(id__gt=3) </code> ä»£è¡¨idå¤§äº3çš„æ•°æ®<br>
PS. ä¸ç­‰äºå¯ä»¥é€šè¿‡<code>exclude</code>è¿‡æ»¤</li>
<li>å­—ç¬¦ä¸²æ–¹é¢ï¼šstartswithã€endswithï¼šä»¥æŒ‡å®šå€¼å¼€å¤´æˆ–ç»“å°¾ï¼›containsï¼šæ˜¯å¦åŒ…å«ã€‚<br>
<code>list = BookInfo.objects.filter(btitle__endswith='éƒ¨')</code> æŸ¥è¯¢æ˜¯å¦æ•°æ®ä¸­btitleå­—æ®µä»¥â€˜éƒ¨â€™è¿™ä¸ªå­—ç»“å°¾çš„ä¸€è¡Œæ•°æ®ã€‚</li>
<li>æ—¥æœŸæŸ¥è¯¢ï¼š yearã€monthã€dayã€week_dayã€hourã€minuteã€secondï¼šå¯¹æ—¥æœŸæ—¶é—´ç±»å‹çš„å±æ€§è¿›è¡Œè¿ç®—ã€‚<br>
<code>list = BookInfo.objects.filter(bpub_date__year=1980)</code> æŸ¥è¯¢1980å¹´å‘è¡¨çš„å›¾ä¹¦<br>
<code>list = BookInfo.objects.filter(bpub_date__gt=date(1990,1,1))</code>  æŸ¥è¯¢1980å¹´1æœˆ1æ—¥åå‘è¡¨çš„å›¾ä¹¦ã€‚</li>
<li>è¿˜æœ‰å¾ˆå¤šæŸ¥è¯¢ï¼š ä¾‹å¦‚æ¯”è¾ƒåŒä¸€è¡Œæ•°æ®ä¸¤ä¸ªå­—æ®µä¹‹é—´çš„å…³ç³»ï¼ˆå¦‚é˜…è¯»æ•°é‡&gt;=è¯„è®ºæ•°é‡ï¼‰ã€ä¸æˆ–éæŸ¥è¯¢ã€èšåˆç­‰... å…·ä½“å‚è€ƒ<a href="https://www.jianshu.com/p/bde1ece240bc">reference</a>æˆ–è€…å®˜ç½‘</li>
</ul>
<p>PS. 1. <code>filter</code>å¯ä»¥è¿ç»­ä½¿ç”¨ ï¼š<code>list=BookInfo.objects.filter(bread__gt=20).filter(id__lt=3)</code> 2. <code>filter</code>å¯ä»¥ä¼ å…¥å­—å…¸</p>
<h3 id="34è®¾ç½®geté»˜è®¤å€¼">34.è®¾ç½®geté»˜è®¤å€¼</h3>
<ul>
<li><code>request.GET.get('page', '1')</code> è·å–getè¯·æ±‚ï¼Œå¦‚æœgetæ²¡æœ‰é™„å¸¦pageå‚æ•°ï¼Œé‚£ä¹ˆé»˜è®¤æ˜¯1.</li>
</ul>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Extra details of python - for long term - part.2]]></title>
        <id>http://localhost:4000/post/extra-details-of-python-for-long-term-part2/</id>
        <link href="http://localhost:4000/post/extra-details-of-python-for-long-term-part2/">
        </link>
        <updated>2023-06-26T04:11:23.000Z</updated>
        <content type="html"><![CDATA[<h1 id="2023-06-26">2023-06-26</h1>
<h3 id="9-pythonä¸­çš„__init__py">9. pythonä¸­çš„__init__.py</h3>
<p><a href="https://zhuanlan.zhihu.com/p/115350758">reference</a><br>
åœ¨pythonå·¥ç¨‹ä¸­ï¼Œå½“pythonåœ¨ä¸€ä¸ªç›®å½•ä¸‹æ£€æµ‹åˆ°<code>__init__.py</code>æ–‡ä»¶æ—¶ï¼Œå°±ä¼šæŠŠå®ƒå½“æˆä¸€ä¸ªmoduleã€‚<code>__init__.py</code>å¯ä»¥æ˜¯ç©ºçš„ï¼Œä¹Ÿå¯ä»¥æœ‰å†…å®¹ã€‚</p>
<p>--æœªæ•´ç†å®Œ</p>
<h3 id="10-pythonä¸­çš„getattræ–¹æ³•">10. pythonä¸­çš„getattr()æ–¹æ³•</h3>
<p><code>getattr</code>æ–¹æ³•å¯ä»¥è·å–ä¸€ä¸ªæ¨¡å—å…¶ä¸­çš„æ–¹æ³•å’Œå±æ€§ï¼ŒåŒ…æ‹¬classåã€ç›´æ¥å®šä¹‰çš„æ–¹æ³•ä»¥åŠå±æ€§ã€‚<br>
ä»£ç ç¤ºä¾‹ï¼š</p>
<pre><code class="language-python">#åœ¨example.pyæ–‡ä»¶ä¸­
class magical_method():
    def __init__(self,num1,num2,num3):
        self.num1 = num1
        self.num2 = num2
        self.num3 = num3
    def __contains__(self,tar):
        if tar == self.num1 or tar == self.num2 or tar == self.num3:
            return False
        else:
            return True
    def name(self):
        print('qwe')

def another_example():
    print('asdasd')

ppp = 2
</code></pre>
<pre><code class="language-python">#åœ¨åŒç›®å½•ä¸‹çš„test.pyæ–‡ä»¶ä¸­
import example
attr = dir(example)
print(attr)
</code></pre>
<pre><code class="language-python">#è¾“å‡º
['__builtins__', '__cached__', '__doc__', '__file__', '__loader__', '__name__', '__package__', '__spec__', 'another_example', 'magical_method', 'ppp']
</code></pre>
<p>éœ€è¦æ³¨æ„çš„å‡ ä¸ªç‚¹ï¼šä¸€åªä¼šè¾“å‡ºç›´æ¥å®šä¹‰åœ¨æ¨¡å—ä¸­çš„ç±»åã€æ–¹æ³•ã€å±æ€§ï¼ˆå˜é‡ï¼‰ï¼Œå¦‚æœå±æ€§/æ–¹æ³•/ç±»æ˜¯åœ¨å…¶ä»–ç±»/æ–¹æ³•ä¹‹ä¸‹ï¼Œé‚£ä¹ˆä¸ä¼šéå†å‡ºæ¥ï¼›äºŒå¯ä»¥é€šè¿‡<code>isinstance(attr, type)</code>æ–¹æ³•åˆ¤æ–­æ˜¯å¦æ˜¯ç±»ã€<code>callable(func_name)</code>åˆ¤æ–­æ˜¯å¦æ˜¯å‡½æ•°ï¼ˆæ˜¯å¦å¯ä»¥è¢«è°ƒç”¨ï¼‰ã€<code>hasattr(obj, attr)</code>ç”¨æ¥åˆ¤æ–­å±æ€§æ˜¯å¦åœ¨æŒ‡å®šç±»ä¸­ï¼›ä¸‰å¦‚æœæ²¡æœ‰<code>__name__ == &quot;__main__&quot;</code>ï¼Œé‚£ä¹ˆåœ¨dirçš„æ—¶å€™ä¼šæ‰§è¡Œè¯¥æ¨¡å—ã€‚</p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[pythonç½‘ç»œç¼–ç¨‹ -- å»ºç«‹ä¸€ä¸ªhttpæœåŠ¡å™¨+twistedæ¨¡å—--part.2]]></title>
        <id>http://localhost:4000/post/part2/</id>
        <link href="http://localhost:4000/post/part2/">
        </link>
        <updated>2023-06-26T03:45:40.000Z</updated>
        <content type="html"><![CDATA[<h1 id="">=&gt;</h1>
<p>HTTPåŸºç¡€å“åº”</p>
<ol>
<li>httpæœåŠ¡å™¨</li>
</ol>
<pre><code class="language-python"># 1.é¦–å…ˆéœ€è¦socketè¿›è¡Œåè®®ã€ç«¯å£è®¾ç½®
# 2. ç„¶åå› ä¸ºæ€§èƒ½åŸå›  éœ€è¦è®¾ç½®å¤šè¿›ç¨‹å“åº”å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚
# 3. è®¾ç½®å¤„ç†å®¢æˆ·ç«¯å‘é€ä¿¡æ¯
# 4. è¿”å›å“åº”çš„htmlä»¥åŠhttpå¤´ä¿¡æ¯
import socket
import multiprocessing
class HttpServer:
    def __init__(self,port):  #è¿›è¡Œsocketåˆå§‹è®¾ç½® ç»‘å®šç«¯å£å¼€å¯ç›‘å¬
        self.port = port
        self.server_socket = socket.socket(socket.AF_INET,socket.SOCK_STREAM) #å®ä¾‹socketå¯¹è±¡
        self.server_socket.setsockopt(socket.SOL_SOCKET,socket.SO_REUSEADDR,1) #è¿›è¡Œsocketé€‰é¡¹è®¾ç½®
        self.server_socket.bind(('0.0.0.0',port)) #ç»‘å®šç›‘å¬ç«¯å£
        self.server_socket.listen() #å¼€å¯ç›‘å¬ åœ¨æ„é€ å‡½æ•°å†…å¼€å¯ç›‘å¬ä»£è¡¨æ¯ä¸€ä¸ªå®ä¾‹éƒ½æ˜¯ä¸€ä¸ªhttpæœåŠ¡å™¨ç¨‹åº

    def start(self): #æ¥æ”¶æœåŠ¡ç«¯ä¿¡æ¯ è¿›è¡Œå¤„ç†
        while True:
            client_scoket, client_addr = self.server_socket.accept()
            print(f'ã€æ–°çš„å®¢æˆ·ç«¯è¿æ¥ã€‘å®¢æˆ·ç«¯ip{client_addr[0]},è®¿é—®ç«¯å£{client_addr[1]}')
            handle_socket = multiprocessing.Process(target=self.handle_response,args=(client_scoket,))#å¯åŠ¨ä¸€ä¸ªè¿›ç¨‹å¤„ç†è¿™ä¸ªå®¢æˆ·ç«¯è¯·æ±‚
            handle_socket.start()

    def handle_response(self,client_socket): #å¤„ç†å®¢æˆ·ç«¯å‘é€çš„è¯·æ±‚ä¿¡æ¯
        request_headers = client_socket.recv(1024)
        print(f'ã€å®¢æˆ·ç«¯æ¸…è¯·æ±‚å¤´ä¿¡æ¯ã€‘{request_headers}') #å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚å¤´ä¿¡æ¯

        #å¼€å§‹å¤„ç†å“åº”ç»™å®¢æˆ·ç«¯çš„ä¿¡æ¯
        response_start_line = 'HTTP/1.1 200 OK\r\n' #æœ¬æ¬¡ç›¸åº”æˆåŠŸ
        #æ‰‹åŠ¨å†™httpå“åº”å¤´ ä¹‹åä¼šå‘é€ç»™å®¢æˆ·ç«¯ä¼šè¢«æµè§ˆå™¨è§£æ
        response_header = 'Server:Cyanine Hrrp Server\r\nContent-Type:text/html\r\n'
        #è¿”å›çš„htmlä»£ç  ä¹Ÿå°±æ˜¯é¡µé¢ä¸»é¢˜ æœ€åŸºæœ¬çš„å¼€å‘å°±æ˜¯éœ€è¦åœ¨ä»£ç ä¸­ç¡¬åµŒå…¥htmlé¡µé¢ä»£ç 
        response_body = &quot;&lt;html&gt;&quot;\
                            &quot;&lt;head&gt;&quot;\
                                &quot;&lt;meta charset=utf-8&gt;&quot;\
                                &quot;&lt;title&gt;Cyanine Http Server Response&lt;/title&gt;&quot;\
                            &quot;&lt;/head&gt;&quot;\
                            &quot;&lt;body&gt;&quot;\
                                &quot;&lt;h1&gt;&quot;\
                                &quot;Cyanine's Http server response...&quot;\
                                &quot;&lt;/h1&gt;&quot;\
                            &quot;&lt;/body&gt;&quot;\
                        &quot;&lt;/html&gt;&quot;
        #è¦æ³¨æ„åœ¨å“åº”å¤´å’Œå“åº”bodyä¹‹é—´æ·»åŠ æ¢è¡Œ å¦åˆ™æµè§ˆå™¨ä¸èƒ½è§£æå‡ºå“åº”å†…å®¹
        response = response_start_line + response_header + '\r\n'+response_body
        client_socket.send(bytes(response,'UTF-8')) #æœåŠ¡å™¨å“åº”
        client_socket.close() #httpsæ˜¯æ— çŠ¶æ€åè®® å› æ­¤ç›¸åº”å®Œæˆä¸€æ¬¡ä¹‹åå°±ä¼šå…³é—­è¿æ¥

def main():
    #80ç«¯å£å¤§éƒ¨åˆ†æœåŠ¡çš„é»˜è®¤ç«¯å£ å› æ­¤å¦‚æœä½¿ç”¨çš„è¯ å°±å¯ä»¥ç›´æ¥å±äºåŸŸå/ä¸»æœºåœ°å€è®¿é—®æœåŠ¡
    #å¦‚æœä¸æ˜¯çš„è¯ éœ€è¦æŒ‡å®šç«¯å£ :**
    http_server = HttpServer(9090)
    http_server.start()
if __name__ == '__main__':
    main()
</code></pre>
<p>ä¸€äº›ä»£ç æ›´è¯¦ç»†çš„è®²è§£<br>
<code>self.server_socket = socket.socket(socket.AF_INET,socket.SOCK_STREAM) #å®ä¾‹socketå¯¹è±¡</code><br>
ocket(family,type[,protocol])å‡½æ•°ä¸­ï¼Œfamily æŒ‡å®šåº”ç”¨ç¨‹åºä½¿ç”¨çš„é€šä¿¡åè®®çš„åè®®æ—ï¼Œå¯¹äºTCP/IPåè®®æ—ï¼Œè¯¥å‚æ•°ä¸ºAF_INETï¼›type æ˜¯è¦åˆ›å»ºå¥—æ¥å­—çš„ç±»å‹ï¼Œsocket.SOCK_STREAMè¡¨ç¤ºæµå¼socketï¼Œä½¿ç”¨TCPåè®®çš„æ—¶å€™é€‰æ‹©æ­¤å‚æ•°ï¼ŒSOCK_DGRAMæ•°æ®æŠ¥å¼socketï¼Œä½¿ç”¨UDPåè®®çš„æ—¶å€™é€‰æ‹©æ­¤å‚æ•°ï¼›protocol æŒ‡æ˜æ‰€è¦æ¥æ”¶çš„åè®®ç±»å‹ï¼Œé€šå¸¸ä¸º0æˆ–è€…ä¸å¡«ã€‚<br>
<code>self.server_socket.setsockopt(socket.SOL_SOCKET,socket.SO_REUSEADDR,1) #è¿›è¡Œsocketé€‰é¡¹è®¾ç½®  level: è®¾ç½®é€‰é¡¹æ‰€åœ¨çš„åè®®å±‚ç¼–å·ï¼Œæœ‰å››ä¸ªå¯ç”¨é…ç½®é¡¹ï¼Œå…¶ä¸­socket.SOL_SOCKETè¡¨ç¤ºåŸºæœ¬åµŒå¥—å­—æ¥å£....å‰©ä¸‹çš„å¥½å¤æ‚ï¼Œçœ‹ä¸å¤ªæ‡‚ï¼Œæš‚ä¸”æ”¾ä¸‹ã€‚çœ‹åˆ°çš„[å‚è€ƒ](https://blog.csdn.net/c_base_jin/article/details/94353956) </code>client_socket.send(bytes(response,'UTF-8')) #æœåŠ¡å™¨å“åº”<br>
ä½¿ç”¨<code>bytes</code>çš„åŸå› æ˜¯socketåªèƒ½å‘é€å­—èŠ‚æ•°æ®æµï¼Œå› æ­¤éœ€è¦å°†responseè½¬æ¢ä¸ºbytesç±»å‹ï¼Œå†å‘é€ã€‚</p>
<h1 id="-2">=&gt;</h1>
<p>httpæœåŠ¡å™¨å»ºç«‹ç›¸åº”ç›®å½•<br>
ä¹‹å‰çš„httpæœåŠ¡åªèƒ½è¿›è¡Œä¸€æ¬¡å›ºå®šçš„å“åº”ï¼Œå¹¶ä¸”htmlä»£ç å‡ºç°åœ¨pythonä»£ç ä¸­ä¸æ–¹ä¾¿ä¿®æ”¹ï¼Œæ²¡æœ‰è¿›è¡Œå‰åç«¯åˆ†ç¦»ï¼Œè¾ƒä¸ºè½åã€‚å› æ­¤æˆ‘ä»¬å¯ä»¥å»ºç«‹ä¸€ä¸ªç›®å½•ï¼Œç›®å½•ä¸‹æœ‰ä¸åŒçš„HTMLé¡µé¢ï¼Œæ ¹æ®è¯·æ±‚çš„ä¸åŒï¼Œç›¸åº”å“åº”ç›®å½•ä¸‹å¯¹åº”çš„htmlæ–‡ä»¶ã€‚<br>
å…·ä½“å®ç°ï¼š</p>
<pre><code class="language-python"># æ·»åŠ ç›¸åº”ç›®å½• åŸå› åœ¨äºä»£ç ç»´æŠ¤ä»¥åŠæ›´åŠ é«˜æ•ˆçš„å“åº”
# éœ€è¦æ³¨æ„ è¯»å–htmlæˆ–è€…å…¶ä»–æ–‡ä»¶éƒ½æ˜¯ä»¥bytesçš„æ ¼å¼
# osçš„æ³¨æ„ç‚¹ os.getcwd() os.sep os.path.normpath()
# æ­£åˆ™çš„å†™æ³• æš‚ä¸åšè¯¦ç»†äº†è§£ 

import socket
import os #oså¤„ç†å“åº”æ–‡ä»¶ç›®å½•
import re #æ­£åˆ™åŒ¹é…è¯·æ±‚ä¸­çš„æ–‡ä»¶åœ°å€
import multiprocessing
HTML_ROOT_DIR = os.getcwd() + os.sep + &quot;template&quot;

class HttpServer:
    def __init__(self,port):  #è¿›è¡Œsocketåˆå§‹è®¾ç½® ç»‘å®šç«¯å£å¼€å¯ç›‘å¬
        self.port = port
        self.server_socket = socket.socket(socket.AF_INET,socket.SOCK_STREAM) #å®ä¾‹socketå¯¹è±¡
        self.server_socket.setsockopt(socket.SOL_SOCKET,socket.SO_REUSEADDR,1) #è¿›è¡Œsocketé€‰é¡¹è®¾ç½®
        self.server_socket.bind(('0.0.0.0',port)) #ç»‘å®šç›‘å¬ç«¯å£
        self.server_socket.listen() #å¼€å¯ç›‘å¬ åœ¨æ„é€ å‡½æ•°å†…å¼€å¯ç›‘å¬ä»£è¡¨æ¯ä¸€ä¸ªå®ä¾‹éƒ½æ˜¯ä¸€ä¸ªhttpæœåŠ¡å™¨ç¨‹åº

    def start(self): #æ¥æ”¶æœåŠ¡ç«¯ä¿¡æ¯ è¿›è¡Œå¤„ç†
        while True:
            client_scoket, client_addr = self.server_socket.accept()
            print(f'ã€æ–°çš„å®¢æˆ·ç«¯è¿æ¥ã€‘å®¢æˆ·ç«¯ip{client_addr[0]},è®¿é—®ç«¯å£{client_addr[1]}')
            handle_socket = multiprocessing.Process(target=self.handle_response,args=(client_scoket,))#å¯åŠ¨ä¸€ä¸ªè¿›ç¨‹å¤„ç†è¿™ä¸ªå®¢æˆ·ç«¯è¯·æ±‚
            handle_socket.start()
    
    #è¯»å–å¯¹åº”æ–‡ä»¶æ•°æ®
    def read_file(self,file_name):
        file_path = os.path.normpath(HTML_ROOT_DIR + file_name)
        print('ã€è¯·æ±‚æ–‡ä»¶è·¯å¾„ã€‘'+ file_path)
        f = open(file_path,'rb') #äºŒè¿›åˆ¶è¯»å–
        file_data = f.read()
        f.close()
        print('ã€è¯·æ±‚æ–‡ä»¶è·¯å¾„ã€‘è¯¥æ–‡ä»¶è¯·æ±‚ç»“æŸï¼')
        return file_data

    #è·å–äºŒè¿›åˆ¶æ–‡ä»¶
    def get_binary_data(self,file_name):
        response_body = self.read_file(file_name)
        return response_body

    #è¯»å–htmlæ–‡ä»¶ è¿”å›ç›¸åº”çš„ä¿¡æ¯
    def get_html_file(self,file_name):
        response_start_line = 'HTTP/1.1 200 OK\r\n' #æœ¬æ¬¡ç›¸åº”æˆåŠŸ
        #æ‰‹åŠ¨å†™httpå“åº”å¤´ ä¹‹åä¼šå‘é€ç»™å®¢æˆ·ç«¯ä¼šè¢«æµè§ˆå™¨è§£æ
        response_header = 'Server:Cyanine Hrrp Server\r\nContent-Type:text/html\r\n'
        response_body = self.read_file(file_name)
        return response_start_line + response_header + '\r\n' + response_body.decode('utf-8')
    def handle_response(self,client_socket): #å¤„ç†å®¢æˆ·ç«¯å‘é€çš„è¯·æ±‚ä¿¡æ¯
        request_headers = client_socket.recv(1024)
        print(f'ã€å®¢æˆ·ç«¯æ¸…è¯·æ±‚å¤´ä¿¡æ¯ã€‘{request_headers}') #å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚å¤´ä¿¡æ¯
        file_name = re.match(r&quot;\w+ +(/[^ ]*)&quot;, request_headers.decode('utf-8').split('\r\n')[0]).group(1)
        if file_name == &quot;/&quot;: #å¦‚æœè¯·æ±‚çš„æ˜¯æ ¹ç›®å½• é‚£ä¹ˆå®é™…è®¿é—®çš„æ˜¯index.htmlé¡µé¢
            file_name = '/index.html'
        if file_name.endswith(&quot;.html&quot;) or file_name.endswith(&quot;.htm&quot;):
            client_socket.send(bytes(self.get_html_file(file_name),'utf-8'))
        else:
            response_start_line = 'HTTP/1.1 200 OK\r\n' #æœ¬æ¬¡å“åº”æˆåŠŸ
            response_header ='Server:Cyanine Hrrp Server\r\nContent-Type:image/x-icon\r\n'
            client_socket.send((response_start_line + response_header + '\r\n').encode('utf-8'))
            client_socket.send(self.get_binary_data(file_name))
        client_socket.close() #httpsæ˜¯æ— çŠ¶æ€åè®® å› æ­¤ç›¸åº”å®Œæˆä¸€æ¬¡ä¹‹åå°±ä¼šå…³é—­è¿æ¥

def main():
    #80ç«¯å£å¤§éƒ¨åˆ†æœåŠ¡çš„é»˜è®¤ç«¯å£ å› æ­¤å¦‚æœä½¿ç”¨çš„è¯ å°±å¯ä»¥ç›´æ¥å±äºåŸŸå/ä¸»æœºåœ°å€è®¿é—®æœåŠ¡
    #å¦‚æœä¸æ˜¯çš„è¯ éœ€è¦æŒ‡å®šç«¯å£ :**
    http_server = HttpServer(70)
    http_server.start()
    
if __name__ == '__main__':
    main()
</code></pre>
<p>ä»£ç ç»†èŠ‚è§£æ<br>
ä¸€è¿™æ˜¯ä¸€ä¸ªç®€å•çš„httpæœåŠ¡å™¨ç›¸åº”ç›®å½•ï¼Œåªæ˜¯ç®€å•å¤„ç†index.htmlã€hello.htmlä»¥åŠfavicon.icoæ–‡ä»¶ï¼›äºŒä¸ºäº†ç»“æ„æ¸…æ™°ï¼Œå°½ç®¡è·å–<code>get_binary_data()</code>æ–¹æ³•åªæ˜¯ç»™<code>read_file</code>æ¢äº†ä¸ªåå­—ï¼Œä½†æ˜¯èƒ½å¤Ÿå°†åŠŸèƒ½æ›´åŠ æ¸…æ™°çš„åˆ†å‰²å¼€æ¥ï¼›ä¸‰ä¸ç®¡ä»€ä¹ˆå“åº”ï¼Œéƒ½è¦è®°å¾—æ·»åŠ å¯¹åº”çš„httpå“åº”å¤´ï¼›å››å“åº”å¤´å’Œå“åº”å†…å®¹å’Œåˆ†å¼€å‘é€ï¼›äº”è¦æ³¨æ„æ‰‹å†™å“åº”å¤´çš„æ—¶å€™å„ä¸ªéƒ¨åˆ†ä¹‹é—´çš„<code>\r\n</code>ï¼›<br>
åŒæ—¶è¿™é‡Œè¿˜é‡åˆ°äº†ä¸€ä¸ªéš¾ä»¥ç†è§£çš„é—®é¢˜ï¼Œå¦‚æœæ˜¯ä»¥80ç«¯å£å¯åŠ¨æœåŠ¡ï¼Œé‚£ä¹ˆå°±ç®—faviconçš„è¯·æ±‚æ²¡æœ‰å“åº”å¤´ï¼Œæµè§ˆå™¨ä¹Ÿä¼šæ­£ç¡®è§£æå‡ºæ¥å¹¶æ˜¾ç¤ºå›¾æ ‡ï¼Œä½†æ˜¯å¦‚æœæ¢æˆå…¶ä»–çš„ç«¯å£ï¼Œé‚£ä¹ˆå°±ä¸èƒ½æ­£å¸¸ç›¸åº”ï¼Œå¿…é¡»è¦æ·»åŠ å“åº”å¤´ã€‚çŒœæµ‹å¯èƒ½æ˜¯å› ä¸º80ç«¯å£æ˜¯é»˜è®¤ï¼Œè€Œè¯·æ±‚faviconä¹Ÿæ˜¯é»˜è®¤çš„ä¸€ä¸ªè¯·æ±‚ï¼Œå› æ­¤åœ¨è¿™ä¸ªæ´»åŠ¨ä¸­ï¼Œæµè§ˆå™¨ä¼šè‡ªåŠ¨è§£ææŠŠï¼Œä½†æ˜¯éé»˜è®¤ç«¯å£å°±ä¸å¯ä»¥ã€‚<a href="https://blog.csdn.net/laocooon/article/details/130762587#comments_27306408">å’Œä¸€ä½ç›¸åŒé—®é¢˜çš„å¤§ä½¬çš„è®¨è®ºä»¥åŠä»–çš„ä»£ç </a>ã€‚è¿™ä¸ªé—®é¢˜æ€ä¹ˆä¹Ÿæ‰¾ä¸åˆ°ç­”æ¡ˆï¼Œå› æ­¤æš‚ä¸”æç½®å§ğŸ˜­ã€‚æ€»æ˜¯è¿˜æ˜¯è¦è®°å¾—åœ¨æ¯ä¸€ä¸ªå“åº”å‰æ·»åŠ å“åº”å¤´ã€‚ä¸è¿‡å½“ç„¶é’ˆå¯¹ç®€å•çš„ï¼Œå¤æ‚çš„è¯æœ‰å¾ˆå¤šwebæ¡†æ¶ä¼šå¸®æˆ‘ä»¬æ»´~~~</p>
<h1 id="-3">=&gt;</h1>
<p>åŠ¨æ€è¯·æ±‚å¤„ç†<br>
webæœ‰ä¸¤ä¸ªå¤„ç†é˜¶æ®µï¼šé™æ€å¤„ç†é˜¶æ®µã€åŠ¨æ€å¤„ç†é˜¶æ®µã€‚<br>
ä¹‹å‰çš„å“åº”ç›®å½•å®é™…ä¸Šæ˜¯é™æ€å¤„ç†ï¼Œè€ŒåŠ¨æ€webæ˜¯å¯ä»¥æ ¹æ®åŠ¨æ€çš„åˆ¤æ–­å†³å®šæœ€ç»ˆè¿”å›çš„æ•°æ®å†…å®¹ã€‚<br>
pythonåŠ¨æ€å¤„ç†å®ç°ï¼š(åªæ˜¯ç®€å•çš„åŸç†äº†è§£ï¼Œä¸æ¶‰åŠå¤æ‚çš„åŠ¨æ€ç›¸åº”æ¡†æ¶)</p>
<pre><code class="language-python"># å¤„ç†åŠ¨æ€è¯·æ±‚ 
import socket
import os #oså¤„ç†å“åº”æ–‡ä»¶ç›®å½•
import re #æ­£åˆ™åŒ¹é…è¯·æ±‚ä¸­çš„æ–‡ä»¶åœ°å€
import multiprocessing
HTML_ROOT_DIR = os.getcwd() + os.sep + &quot;template&quot;
import sys 
sys.path.append('packages')

class HttpServer:
    def __init__(self,port):  #è¿›è¡Œsocketåˆå§‹è®¾ç½® ç»‘å®šç«¯å£å¼€å¯ç›‘å¬
        self.port = port
        self.server_socket = socket.socket(socket.AF_INET,socket.SOCK_STREAM) #å®ä¾‹socketå¯¹è±¡
        self.server_socket.setsockopt(socket.SOL_SOCKET,socket.SO_REUSEADDR,1) #è¿›è¡Œsocketé€‰é¡¹è®¾ç½®
        self.server_socket.bind(('0.0.0.0',port)) #ç»‘å®šç›‘å¬ç«¯å£
        self.server_socket.listen() #å¼€å¯ç›‘å¬ åœ¨æ„é€ å‡½æ•°å†…å¼€å¯ç›‘å¬ä»£è¡¨æ¯ä¸€ä¸ªå®ä¾‹éƒ½æ˜¯ä¸€ä¸ªhttpæœåŠ¡å™¨ç¨‹åº

    def start(self): #æ¥æ”¶æœåŠ¡ç«¯ä¿¡æ¯ è¿›è¡Œå¤„ç†
        while True:
            client_scoket, client_addr = self.server_socket.accept()
            print(f'ã€æ–°çš„å®¢æˆ·ç«¯è¿æ¥ã€‘å®¢æˆ·ç«¯ip{client_addr[0]},è®¿é—®ç«¯å£{client_addr[1]}')
            handle_socket = multiprocessing.Process(target=self.handle_response,args=(client_scoket,))#å¯åŠ¨ä¸€ä¸ªè¿›ç¨‹å¤„ç†è¿™ä¸ªå®¢æˆ·ç«¯è¯·æ±‚
            handle_socket.start()

    def handle_response(self,client_socket): #å¤„ç†å®¢æˆ·ç«¯å‘é€çš„è¯·æ±‚ä¿¡æ¯
        request_headers = client_socket.recv(1024)
        print(f'ã€å®¢æˆ·ç«¯æ¸…è¯·æ±‚å¤´ä¿¡æ¯ã€‘{request_headers}') #å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚å¤´ä¿¡æ¯
        file_name = re.match(r&quot;\w+ +(/[^ ]*)&quot;, request_headers.decode('utf-8').split('\r\n')[0]).group(1)
        if file_name.startswith('/packages'): #è®¿é—®åŠ¨æ€é¡µé¢
            #è·å–åŠ¨æ€å‚æ•° 
            request_name = file_name[file_name.index('/',1)+1:]#è®¿é—®è·¯å¾„
            # print(&quot;è®¿é—®è·¯å¾„ï¼š&quot;+request_name)
            param_value = '' #è¯·æ±‚å‚æ•°
            if request_name.__contains__('?') :#ï¼Ÿæ˜¯urlä¸­çš„å‚æ•°åˆ†éš”ç¬¦å·
                request_value = request_name[request_name.index('?') + 1 :]
                param_value = request_value.split('=')[1]
                request_name = request_name[0:request_name.index('?')]
                # print(request_name)
            model_name = request_name.split('/')[0]
            method_name = request_name.split('/')[1]
            model = __import__(model_name)
            method = getattr(model,method_name)
            response_body = method(param_value)
            print('ã€å“åº”æ•°æ®æ˜¯ã€‘ï¼š'+response_body)

            response_start_line = 'HTTP/1.1 200 OK\r\n' 
            #æ‰‹åŠ¨å†™httpå“åº”å¤´ ä¹‹åä¼šå‘é€ç»™å®¢æˆ·ç«¯ä¼šè¢«æµè§ˆå™¨è§£æ
            response_header = 'Server:Cyanine Hrrp Server\r\nContent-Type:text/html\r\n'
            response = response_start_line+response_header+'\r\n'+response_body
            print(response)
            client_socket.send(bytes(response,'UTF-8'))
        client_socket.close()


def main():
    #80ç«¯å£å¤§éƒ¨åˆ†æœåŠ¡çš„é»˜è®¤ç«¯å£ å› æ­¤å¦‚æœä½¿ç”¨çš„è¯ å°±å¯ä»¥ç›´æ¥å±äºåŸŸå/ä¸»æœºåœ°å€è®¿é—®æœåŠ¡
    #å¦‚æœä¸æ˜¯çš„è¯ éœ€è¦æŒ‡å®šç«¯å£ :**
    http_server = HttpServer(80)
    http_server.start()
    
if __name__ == '__main__':
    #http://localhost/packages/echo/service?param=canshu
    main()
</code></pre>
<p>åŒæ—¶è¿˜éœ€è¦ä¸€ä¸ªåœ¨åŒç›®å½•ä¸‹çš„packagesæ–‡ä»¶å¤¹ï¼Œæ–‡ä»¶è·¯å¾„å¦‚ä¸‹</p>
<pre><code>â”œâ”€packages
â”‚  â”‚  echo.py
â”‚  â”‚  __init__.py
â”‚  â”‚  
â”‚  â””â”€__pycache__
â”‚          echo.cpython-310.pyc
â”‚          echo.cpython-311.pyc
â”‚          
â”œâ”€template
â”‚      favicon.ico
â”‚      hello.html
â”‚      index.html
â”‚        
â”œâ”€ç½‘ç»œç¼–ç¨‹
â”‚      01-server.py
â”‚      02-client.py
â”‚      03-echo-server.py
â”‚      04-echo-client.py
â”‚      05-UDP-server.py
â”‚      06-UDP-client.py
â”‚      07-broadcast-client.py
â”‚      08-broadcast-server.py
â”‚      09-http-server.py
â”‚      10-http-lib-server.py
â”‚      11-dynamic-request.py #è¿™ä¸ªæ˜¯æœ¬æ–‡ä»¶
</code></pre>
<p>å…¶ä¸­çš„/packages/echo.pyæ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š</p>
<pre><code class="language-python">def service(text):
    if text:
        response = f'&lt;head&gt;&lt;title&gt;Cyanine\'s Http Server&lt;/title&gt;&lt;meta charset=&quot;utf-8&quot;&gt;&lt;/head&gt;&lt;body&gt;&lt;h1&gt;å‚æ•°ä¿¡æ¯ï¼š{text}&lt;/h1&gt;&lt;/body&gt;'
        return response
    else:
        return '&lt;h1&gt;æ²¡æœ‰å‚æ•°ä¿¡æ¯&lt;/h1&gt;'
</code></pre>
<p>éœ€è¦æ³¨æ„çš„ï¼š<br>
ä¸€åœ¨<code>packages</code>æ–‡ä»¶å¤¹ä¸‹ä¸€å®šè¦æœ‰<code>__init.py__</code>æ–‡ä»¶ï¼Œè¿™æ ·æ‰èƒ½åœ¨<code>__import__</code>çš„æ—¶å€™æ­£ç¡®è¯†åˆ«åˆ°æ¨¡å—ï¼ŒåŒæ—¶ä¹Ÿéœ€è¦æå‰è®¾å®šé»˜è®¤çš„æ¨¡å—è·¯å¾„ï¼ˆ<code>sys.path.append(path/to/module)</code>ï¼‰ï¼›äºŒå“åº”çš„æ—¶å€™é™¤äº†éœ€è¦ç¡®å®šå“åº”å¤´ï¼Œåœ¨å“åº”çš„htmlä»£ç ä¸­éœ€è¦è§„å®šç¼–ç æ–¹å¼ï¼Œå¦åˆ™ä¼šå‡ºç°ä¹±ç ï¼ˆ<code>&lt;meta charset=utf-8&gt;</code>)ï¼›ä¸‰åŠ¨æ€å¤„ç†æˆ‘åˆšå¬èµ·æ¥é«˜å¤§ä¸Šï¼Œä½†å®é™…ä¸Šæ“ä½œä¸€éï¼Œæ„Ÿå—å°±æ˜¯å¯¹urlçš„è§£æï¼ŒåŠ ä¸Šä¸€äº›ç¨‹åºå¤„ç†å‚æ•°ï¼Œå°±æ˜¯åŠ¨æ€å¤„ç†ï¼›å››åŠ¨æ€å¤„ç†urléœ€è¦ç”¨åˆ°å¾ˆå¤šå¯¹å­—ç¬¦ä¸²çš„æ“ä½œã€‚<br>
PS. å¦å¤–ä¸€ä¸ªæ–¹ä¾¿çš„å°tipsï¼Œåœ¨å†™é¡¹ç›®ç»“æ„çš„æ—¶å€™ï¼Œå‘½ä»¤è¡Œé‡Œä½¿ç”¨<code>tree</code>ä¼šç”Ÿæˆç›®å½•ç»“æ„ï¼Œ<code>tree &gt; txtname.txt</code>ä¼šå°†ç›®å½•è¾“å‡ºåˆ°è¿™ä¸ªtxtæ–‡ä»¶ä¸­ï¼Œå‚æ•°<code>/f</code>ä¼šæ˜¾ç¤ºæ‰€æœ‰çš„æ–‡ä»¶å±‚çº§ï¼Œä¸åŠ å‚æ•°åªä¼šæ˜¾ç¤ºåˆ°æ‰€æœ‰çš„ç›®å½•å±‚çº§ã€‚</p>
<h1 id="-4">=&gt;</h1>
<p>urllib3æ¨¡å—<br>
ç”¨è¿™ä¸ªæ¨¡å—å¯ä»¥å®ç°æµè§ˆå™¨çš„æ¨¡æ‹Ÿè®¿é—®ï¼Œæ˜¯urllibçš„å‡çº§ç‰ˆï¼Œä¸¤è€…åŠŸèƒ½ç±»ä¼¼ï¼Œåªæœ‰ç»†å¾®å·®åˆ«ã€‚</p>
<h1 id="-5">=&gt;</h1>
<p>Twistedæ¨¡å— (ç±»ä¼¼javaä¸­nio)<br>
æ˜¯pythonä¸­ä¸“é—¨å®ç°å¼‚æ­¥å¤„ç†çš„ioæ¦‚å¿µï¼Œä¸»è¦æ˜¯æå‡æœåŠ¡ç«¯çš„æ•°æ®å¤„ç†èƒ½åŠ›ã€‚ç†è§£twistedçš„è®¾è®¡æ€æƒ³ï¼Œé‚£ä¹ˆéœ€è¦å¯¹æ¯”ä¼ ç»Ÿçš„æœåŠ¡å™¨ç¨‹åºå¼€å‘ã€‚æ—©æœŸæ²¡æœ‰å¤šæ ¸CPUæ¦‚å¿µï¼Œå•çº¿ç¨‹å¤„ç†çš„æ•ˆç‡ä½ä¸‹ï¼Œå¤šçº¿ç¨‹å¹¶å‘ç¼–ç¨‹æœ‰å¯èƒ½äº§ç”Ÿæ­»é”é—®é¢˜ï¼ˆä¸åŒè¿›ç¨‹ä»¥åŠçº¿ç¨‹ä¹‹é—´çš„ç­‰å¾…å’Œå”¤é†’æœºåˆ¶ï¼‰ï¼ˆå› ä¸ºéƒ½æ˜¯ä¸€ä¸ªä¸€ä¸ªè¿›ç¨‹å»æ‰§è¡Œï¼‰ã€‚æ‰€ä»¥åæ¥ï¼Œå¦‚æœä¸ä½¿ç”¨å¹¶å‘ç¼–ç¨‹ï¼Œå°±ä¸ä¼šäº§ç”Ÿç§ç§é—®é¢˜ï¼ˆèµ„æºåˆ‡æ¢ã€ç³»ç»Ÿè°ƒåº¦ã€åŒæ­¥ä¸ç­‰å¾…ç­‰ï¼‰ï¼Œ</p>
<blockquote>
<p>é˜»å¡è®¾è®¡<br>
æœåŠ¡ç«¯ä¸å®¢æˆ·ç«¯çš„recv<br>
ä¼šæµªè´¹å¤§é‡æœåŠ¡å™¨èµ„æº -&gt; è¿™å°±æ˜¯é˜»å¡IO</p>
</blockquote>
<p>å¤šçº¿ç¨‹æ˜¯ä¸èƒ½è§£å†³é˜»å¡IOçš„ï¼Œå› æ­¤æœ€å¥½çš„æ–¹æ³•æ˜¯éé˜»å¡IOï¼ˆåˆ†ä¸ºåŒæ­¥éé˜»å¡IOå’Œå¼‚æ­¥éé˜»å¡IOï¼‰ï¼Œå› æ­¤å®ç°ä¸‹æ¥å°±æ˜¯åœ¨ä¸€ä¸ªè¿›ç¨‹ä¸­ä¸æ–­åœ°è¿›è¡Œå¾ªç¯å¤„ç†<br>
-&gt; twistedæ˜¯ä¸€ä¸ªäº‹ä»¶é©±åŠ¨å‹çš„ç½‘ç»œå¼•æ“ï¼Œæœ€å¤§çš„ç‰¹ç‚¹å°±æ˜¯æä¾›æœ‰ä¸€ä¸ªäº‹ä»¶å¾ªç¯å¤„ç†ï¼Œå½“å¤–éƒ¨äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œä½¿ç”¨å›è°ƒæœºåˆ¶æ¥è§¦å‘ç›¸åº”çš„æ“ä½œå¤„ç†ï¼Œå¤šä¸ªä»»åŠ¡åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­æ‰§è¡Œçš„æ—¶å€™ï¼Œè¿™ç§æ–¹å¼å¯ä»¥ä½¿ç¨‹åºå°½å¯èƒ½åœ°å‡å°‘å¯¹å…¶å®ƒçº¿ç¨‹çš„ä»¥æ¥ï¼Œä¹Ÿä½¿å¾—ç¨‹åºå¼€å‘äººå‘˜ä¸å†å…³æ³¨çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚<br>
-&gt; twistedä¸­çš„æ‰€æœ‰å¤„ç†äº‹ä»¶å…¨éƒ¨äº¤ç»™reactorè¿›è¡Œç»Ÿä¸€ç®¡ç†ã€‚<br>
-&gt; reactor è¿›è¡Œæ‰€æœ‰è¾“å‡ºè¾“å‡ºæœ‰å…³çš„äº‹ä»¶æ³¨å†Œã€‚åœ¨æ•´ä¸ªç¨‹åºçš„è¿è¡Œä¸­ï¼Œreactorå¾ªç¯ä¼šä»¥å•çº¿ç¨‹çš„å½¢å¼æŒç»­è¿è¡Œï¼Œå½“éœ€è¦æ‰§è¡Œå›è°ƒå¤„ç†çš„æ—¶å€™ä¼šåœæ­¢å¾ªç¯ï¼Œå½“å›è°ƒæ“ä½œæ‰§è¡Œå®Œæ¯•ä¹‹åå°†ç»§ç»­é‡‡ç”¨å¾ªç¯çš„å½¢å¼è¿›è¡Œå…¶ä»–ä»»åŠ¡å¤„ç†ã€‚</p>
<h1 id="-6">=&gt;</h1>
<p>ä½¿ç”¨twistedå¼€å‘TCPç¨‹åº<br>
ä¼šä½¿æœåŠ¡ç«¯çš„èµ„æºåˆ©ç”¨å¸¦æ¥æå¤§ä¾¿åˆ©ã€‚</p>
<ol>
<li>æœåŠ¡ç«¯ï¼š</li>
</ol>
<pre><code class="language-python">import twisted
import twisted.internet.protocol
import twisted.internet.reactor

SERVER_PORT = 8080

class Server(twisted.internet.protocol.Protocol): #ç»§æ‰¿çˆ¶ç±»
    def connectionMade(self): #å¤å†™æœåŠ¡ç«¯è¿æ¥æ–¹æ³•
        print(f'å®¢æˆ·ç«¯{self.transport.getPeer().host}è¿æ¥æˆåŠŸ...')
        return super().connectionMade() 
    def dataReceived(self, data: bytes): #å¤å†™æœåŠ¡ç«¯æ•°æ®æ¥æ”¶æ–¹æ³•
        print('ã€æœåŠ¡ç«¯æ”¶åˆ°æ•°æ®ã€‘' + data.decode('utf-8')) #å¤„ç†æ“ä½œ
        self.transport.write(('ã€ECHOã€‘' + data.decode('utf-8')).encode('UTF-8')) #è¿›è¡Œå›åº” ç±»æ¯”socketçš„send
        return super().dataReceived(data)

#æ³¨å†Œreactor
#reactoræ ¹æ®å·¥å‚è·å¾—ç›¸åº”äº‹ä»¶å›è°ƒå¤„ç†ç±»
class DefaultServerFactory(twisted.internet.protocol.Factory):
    protocol = Server

def main():
    #æœåŠ¡ç›‘å¬
    twisted.internet.reactor.listenTCP(SERVER_PORT,DefaultServerFactory())
    print('æœåŠ¡å™¨å¯åŠ¨å®Œæ¯•ï¼Œç­‰å¾…å®¢æˆ·ç«¯è¿æ¥...')
    twisted.internet.reactor.run()

if __name__ == '__main__':
    main()
</code></pre>
<ol start="2">
<li>å®¢æˆ·ç«¯</li>
</ol>
<pre><code class="language-python">import twisted
import twisted.internet.protocol
import twisted.internet.reactor

SERVER_PORT = 8080
SERVER_HOST = 'localhost'

class Client(twisted.internet.protocol.Protocol):
    def connectionMade(self):
        print('æœåŠ¡å™¨è¿æ¥æˆåŠŸ...')
        self.send() #å»ºç«‹è¿æ¥ä¹‹åå°±å‘é€æ•°æ®
        return super().connectionMade()
    
    def send(self): #è‡ªå®šä¹‰å‘é€çš„æ–¹å¼
        input_data = input('è¯·è¾“å…¥å‘é€çš„æ•°æ®:')
        if input_data:
            self.transport.write(input_data.encode('utf-8'))
        else:
            self.transport.loseConnection() #å¦‚æœæ²¡æœ‰æ•°æ®å‘é€å°±å…³é—­è¿æ¥
    def dataReceived(self, data: bytes): #æ¥æ”¶æœåŠ¡ç«¯çš„æ•°æ®
        print(data.decode('utf-8'))
        self.send() #è¿›è¡Œä¸‹ä¸€æ¬¡æ•°æ®å‘é€
        return super().dataReceived(data)
    
class DefaultClientfactory(twisted.internet.protocol.ClientFactory):
    protocol = Client
    #å¦‚æœè¿æ¥æ–­å¼€ å°±åœæ­¢reactorçš„å¾ªç¯
    clientConnectLost = clientCOnnectionFailed = lambda self, connector,reason : twisted.internet.reactor.stop()

def main():
    twisted.internet.reactor.connectTCP(SERVER_HOST,SERVER_PORT,DefaultClientfactory()) #æœåŠ¡ç›‘å¬
    twisted.internet.reactor.run() #å¯åŠ¨reactorå¾ªç¯

if __name__ == '__main__':
    main()
</code></pre>
<p>æ•´ä¸ªæ¡†æ¶è¿˜æ˜¯å¤„äºä¸€ä¸ªæ¨¡ç³ŠçŠ¶æ€ï¼Œä½†æ˜¯å¯¹twistedçš„äº‹ä»¶è½®è¯¢æœºåˆ¶è¿˜æ˜¯æœ‰äº†ä¸€ç‚¹æ¸…æ¥šçš„è®¤çŸ¥ã€‚<br>
æˆ‘çš„ç†è§£:</p>
<blockquote>
<p>å°†æ•°æ®çš„å¤„ç†å’Œæ•°æ®çš„æ¥æ”¶å‘é€ã€æœåŠ¡å™¨çš„è¿æ¥è¿™ä¸¤ä¸ªéƒ¨åˆ†å‰¥ç¦»å¼€ã€‚åœ¨reactorä¸­å¦‚æœæ¥æ”¶åˆ°ä¸€ä¸ªä¿¡æ¯ï¼Œé‚£ä¹ˆå°±ä¼šè°ƒç”¨åˆ°twistedå¾ªç¯ä¸­çš„æŸä¸ªå¤„ç†ç¨‹åºï¼Œç„¶åå¤„ç†å®Œæˆä¹‹åå°†æ•°æ®è¿”å›ç»™reactorè¿›è¡Œå‘é€ï¼Œç„¶åtwistedäº‹ä»¶å°±ä¼šç»§ç»­å¾ªç¯ã€‚ç›¸å½“äºå°†ä¸€ä¸ªsocketè¿›ç¨‹ä¸­çš„accept()é˜»å¡å’Œå®é™…çš„å¤„ç†å‰¥ç¦»å¼€ï¼Œè®©å¤„ç†ç¨‹åºä¸å—åˆ°é˜»å¡ç¨‹åºçš„å½±å“ï¼Œå› æ­¤å¯ä»¥åœ¨ä¸€ä¸ªè¿›ç¨‹ä¸­é«˜æ•ˆçš„å¤„ç†å¤šä¸ªå®¢æˆ·ç«¯çš„è¿æ¥ï¼ŒèŠ‚çœäº†æœåŠ¡å™¨çš„èµ„æºã€‚<br>
ï¼ˆæœ‰ç‚¹åƒä¸¤ä¸ªåœˆï¼Œreactorä¸€ä¸ªåœˆï¼Œtwistedä¸€ä¸ªåœˆï¼Œå½“é‡åˆ°æ•°æ®éœ€è¦å¤„ç†çš„æ—¶å€™ä¸¤ä¸ªåœˆå°±ä¼šè¿ä¸€æ¡çº¿ï¼Œå¤„ç†å®Œä¹‹åå°±æŠŠçº¿æ“¦å»ï¼‰</p>
</blockquote>
<h1 id="-7">=&gt;</h1>
<p>æš‚æ—¶å…ˆåˆ°è¿™é‡Œï¼Œåé¢è¿˜æœ‰twistedçš„UDPå®¢æˆ·ç«¯å¼€å‘ä»¥åŠdeferredçš„æ¦‚å¿µã€‚ -- 2023-06-26</p>
<p>deferred</p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[pythonç½‘ç»œç¼–ç¨‹ -- å»ºç«‹ä¸€ä¸ªhttpæœåŠ¡å™¨+twistedæ¨¡å—--part.1]]></title>
        <id>http://localhost:4000/post/python-wang-luo-bian-cheng/</id>
        <link href="http://localhost:4000/post/python-wang-luo-bian-cheng/">
        </link>
        <updated>2023-06-20T03:26:07.000Z</updated>
        <content type="html"><![CDATA[<h1 id="">=&gt;</h1>
<p>B/Så’ŒC/Sæ¶æ„ã€ åè€…ä½¿ç”¨TCPåè®®ï¼Œå‰è€…ä½¿ç”¨HTTPåè®®ï¼ˆHTTPæ˜¯å¯¹TCPçš„æ‰©å……ï¼‰ã€‚<br>
æ‰€æœ‰çš„ç½‘ç»œé€šè®¯éƒ½å¿…é¡»ç»è¿‡OSIï¼ˆä¸ƒå±‚æ¶æ„ï¼‰ -- ä¸ƒå±‚æ¶æ„è¯¦è§£ =&gt; TCP/IP å››å±‚æ¶æ„ ã€äº”å±‚æ¶æ„<br>
ä½†æ˜¯ä¸ºäº†æ–¹ä¾¿ç¨‹åºå¼€å‘ï¼Œsocketä¾¿å‡ºç°äº†ï¼Œä»–åŒ…è£…äº†ä¸ƒå±‚æ¶æ„ä¸­å¯¹æ•°æ®çš„å¤„ç† ï¼Œè®©å¼€å‘åªä¸“æ³¨äºä¸Šå±‚ï¼Œè€Œä¸ç”¨å»ä¸ºäº†æ•°æ®ä¼ è¾“å’Œæ¥æ”¶ä¸ºæ¯ä¸€ä¸ªæ¶æ„çš„æ•°æ®å¤„ç†è´¹å¿ƒã€‚socketæ˜¯å¯¹å„ç§ç½‘ç»œåè®®çš„æŠ½è±¡å®ç°ã€‚ä¸åŒè¯­è¨€ä¸ºäº†æ–¹ä¾¿å¼€å‘ï¼Œéƒ½ä¼šå¯¹ç½‘ç»œåè®®è¿›è¡ŒåŒ…è£…ï¼Œå› æ­¤socketæ˜¯ä¸€ä¸ªé€šç”¨çš„æ¦‚å¿µã€‚</p>
<h1 id="-2">=&gt;</h1>
<p>socketæ˜¯ä¸åŒè¿›ç¨‹ä¹‹é—´çš„é€šè®¯ï¼Œè¿™æ„å‘³ç€ä¸ä»…èƒ½è¿›è¡Œå®¢æˆ·æœºå’ŒæœåŠ¡å™¨ä¹‹é—´ï¼ŒåŒä¸€å°ä¸»æœºä¹‹é—´çš„ä¸åŒè¿›ç¨‹ä¹Ÿå¯ä»¥é€šè¿‡socketè¿›è¡Œäº¤æµã€‚<br>
socketä¸»è¦æ˜¯å¯¹TCP/IPåè®®å’ŒUDPåè®®çš„åŒ…è£…ï¼š<br>
TCP/IP : æœ‰çŠ¶æ€ã€ä¸‰æ¬¡æ¡æ‰‹ã€å››æ¬¡æŒ¥æ‰‹ã€æ€§èƒ½è¾ƒä½èµ„æºå ç”¨å¤§ï¼›<br>
UDP ï¼š æ— çŠ¶æ€ã€æ²¡æœ‰æ¡æ‰‹ä¸æŒ¥æ‰‹ã€ä¸ä¿å­˜å•ä¸ªç»“ç‚¹è¿æ¥ä¿¡æ¯ã€é€‚åˆå¹¿æ’­æ“ä½œ<br>
æ€»  -&gt; ä¸ç®¡æ˜¯TCPè¿˜æ˜¯UDPï¼Œéƒ½æ˜¯å¯¹ä¼ è¾“å±‚çš„ä¿è¯ï¼Œæ•°æ®éƒ½ä¼šé€šè¿‡ä¸ƒå±‚æ¶æ„è¿›è¡Œå¤„ç†ï¼Œæœ€åç»è¿‡ç‰©ç†å±‚å‘å‡ºã€‚socketçš„å­˜åœ¨åŒ…è£…äº†ä¼ è¾“å±‚ï¼Œå› æ­¤ç°åœ¨ç¨‹åºå‘˜å¼€å‘çš„æ—¶å€™å°±åªéœ€è¦å…³æ³¨æ ¸å¿ƒå¸¦å§ï¼Œä¸éœ€è¦åœ¨æ³¨æ„å…·ä½“çš„æ“ä½œåè®®ã€‚</p>
<h1 id="-3">=&gt;</h1>
<p>TCPé€šè®¯ï¼ŒC/Sæ¶æ„</p>
<ol>
<li>æœåŠ¡å™¨ç«¯socketç¨‹åº</li>
</ol>
<pre><code class="language-python">import socket
SERVER_HOST = 'localhost' #æœåŠ¡å™¨ç«¯
SERVER_PORT = 7000 #æœ¬ç¨‹åºç«¯å£

def main():
    with socket.socket() as  server_socket:
        server_socket.bind((SERVER_HOST,SERVER_PORT)) #ç»‘å®šæœ¬æœºç«¯å£
        server_socket.listen() #å¼€å¯ç›‘å¬  
        print(f'æœåŠ¡å™¨å¯åŠ¨å®Œæ¯•ï¼Œåœ¨{SERVER_PORT}ç«¯å£ç›‘å¬ï¼Œç­‰å¾…å®¢æˆ·ç«¯é“¾æ¥...')
        #è¿›å…¥é˜»å¡ ç›´åˆ°å®¢æˆ·ç«¯è¿›è¡Œé“¾æ¥åè§£é™¤
        client_conn,address = server_socket.accept() #è¿›å…¥é˜»å¡çŠ¶æ€ã€
        with client_conn:
            print(f'å®¢æˆ·ç«¯å·²è¿æ¥åˆ°æœåŠ¡ç«¯ï¼Œä¸»æœºåœ°å€æ˜¯{address[0]}ï¼Œç«¯å£æ˜¯{address[1]}')
            client_conn.send(&quot;è¯·æ±‚å·²ç»æ”¶åˆ°ï¼Œæµ‹è¯•æˆåŠŸï¼&quot;.encode('UTF-8'))

if __name__ == '__main__':
    main()
</code></pre>
<ol start="2">
<li>ä½¿ç”¨telnetå‘½ä»¤æµ‹è¯•<br>
windowséœ€è¦åœ¨è®¾ç½®é‡Œé…ç½®telnetï¼Œä»–æ˜¯æ“ä½œç³»ç»Ÿä¸­æä¾›çš„ä¸€ä¸ªæµ‹è¯•å‘½ä»¤ã€‚<br>
<code>telnet localhost 7000</code></li>
<li>å®¢æˆ·ç«¯socketç¨‹åº</li>
</ol>
<pre><code class="language-python">import socket
SERVER_HOST = '127.0.0.1' #æœåŠ¡å™¨ä¸»æœºåç§°/ipåœ°å€
SERVER_PORT = 7000 #æœåŠ¡å™¨é“¾æ¥ç«¯å£

def main():
    with socket.socket() as client_socket: #å»ºç«‹å®¢æˆ·ç«¯socket
        client_socket.connect((SERVER_HOST,SERVER_PORT))
        print(f'æœåŠ¡å™¨è¿”å›æ•°æ® -- {client_socket.recv(40).decode(&quot;UTF-8&quot;)}')

if __name__ == '__main__':
    main()
</code></pre>
<h1 id="-4">=&gt;</h1>
<p>echoç¨‹åºæ¨¡å‹</p>
<ol>
<li>echoæœåŠ¡ç«¯</li>
</ol>
<pre><code class="language-python">import socket
SERVER_HOST = 'localhost'
SERVER_PORT = 7070
coding = ['utf-8','gbk']
def echo_server():
    with socket.socket() as server_socket:
        server_socket.bind((SERVER_HOST,SERVER_PORT)) #bind()å‡½æ•°ä¼ å…¥å…ƒç»„
        server_socket.listen()  #ç›‘å¬ç«¯å£
        print('æœåŠ¡ç«¯å·²å¯åŠ¨ï¼Œç­‰å¾…å®¢æˆ·ç«¯é“¾æ¥...')
        socket_conn,addr = server_socket.accept() #ç­‰å¾…æ¥æ”¶ è¿›å…¥é˜»å¡
        with socket_conn: #åœ¨æ¥æ”¶åˆ°çš„ä¿¡æ¯å‰æ·»åŠ ã€Echoã€‘ç„¶åè¿”å› 
            #è¿æ¥ä¸Šäº†ä¹‹åæ‰whileå¾ªç¯ ä¸æ–­è¿›è¡Œé€šè®¯ 
            #ç¬¬ä¸€æ¬¡è¿æ¥æˆåŠŸå‘é€ä¸€æ¬¡æç¤º
            socket_conn.send('ã€Echoã€‘è¿æ¥æˆåŠŸï¼Œè¾“å…¥å­—ç¬¦å‘é€è¯·æ±‚ï¼Œè¾“å…¥byebyeç»“æŸé“¾æ¥ã€‚'.encode('utf-8'))
            while True:
                response = socket_conn.recv(100).decode(coding[0])
                if response.upper() == &quot;BYEBYE&quot;:
                    print('å®¢æˆ·ç«¯å‘é€ç»ˆæ­¢æŒ‡ä»¤ï¼Œè¿æ¥ç»“æŸ...')
                    socket_conn.send('byebye'.encode(coding[0]))
                    break
                else:
                    socket_conn.send(f'ã€Echoã€‘{response}'.encode(coding[0]))
if __name__ == '__main__':
    echo_server()
</code></pre>
<blockquote>
<p>è¿™é‡Œéœ€è¦æ³¨æ„çš„æœ‰ä¸¤ç‚¹ï¼ˆæˆ‘çŠ¯çš„é”™ğŸ˜£ï¼‰ï¼Œä¸€æ˜¯<code>with as</code>çš„æ—¶å€™éœ€è¦æ³¨æ„å‘½åä¸è¦èµ·å†²çªï¼›äºŒæ˜¯å†æ³¨æ„whileçš„ä½ç½®ï¼Œè¿æ¥æˆåŠŸåå†whileæ‰èƒ½å®ç°ä¸æ–­åœ°é€šè®¯ï¼Œè€Œä¸æ˜¯åœ¨è¿æ¥ä¹‹å‰å°±ä¸æ–­åœ°whileã€‚<br>
è¿™é‡Œçœç•¥telnetæµ‹è¯•ã€‚</p>
</blockquote>
<ol start="2">
<li>echoå®¢æˆ·ç«¯</li>
</ol>
<pre><code class="language-python">import socket
SERVER_HOST = 'localhost'
SERVER_PORT = 7070
def echo_client():
    with socket.socket() as client:
        client.connect((SERVER_HOST,SERVER_PORT))
        #è¿æ¥æˆåŠŸä¹‹åè¿›è¡Œé€šè®¯
        while True:
            response = client.recv(100).decode('utf-8')
            if response.upper() == 'BYEBYE':
                print('é“¾æ¥ç»“æŸ...')
                break
            else:
                print(response)
                text = input()
                client.send(text.encode('utf-8'))
if __name__ == '__main__':
    echo_client()
</code></pre>
<blockquote>
<p>éœ€è¦æ³¨æ„ï¼Œä¸€ä¸ªæœåŠ¡åªèƒ½ç»‘å®šä¸€ä¸ªç«¯ï¼Œå¦‚æœç¨‹åºç«¯å£è¢«å ç”¨ï¼Œé‚£ä¹ˆå°±æ— æ³•æ­£å¸¸å¯åŠ¨ã€‚</p>
</blockquote>
<p>æ­¤æ—¶çš„ç¨‹åºå·²ç»å®ç°äº†ä¸€ä¸ªsocketé€šè®¯ï¼Œå¹¶ä¸”æ˜¯åŸºäºTCPåè®®çš„ï¼Œä½†æ˜¯æœ‰ä¸€ä¸ªé‡å¤§é—®é¢˜ï¼šé‡‡ç”¨çš„æ˜¯å•è¿›ç¨‹çš„å¤„ç†æ¨¡å‹å®Œæˆçš„é€šè®¯ã€‚è¿™å°±æ„å‘³ç€ï¼Œå¦‚æœå½“å‰æœåŠ¡ç«¯å·²ç»æœ‰ä¸€ä¸ªå®¢æˆ·ç«¯è¿›è¡Œé“¾æ¥ï¼Œé‚£ä¹ˆå¦ä¸€ä¸ªå®¢æˆ·ç«¯é“¾æ¥çš„è¯å°±ä¼šå› ä¸ºä¸»è¿›ç¨‹è¢«å ç”¨è€Œå¯¼è‡´æ— æ³•æ“ä½œã€‚å› æ­¤æé«˜æ€§èƒ½å°±éœ€è¦è¿›è¡Œå¤šè¿›ç¨‹ä¼˜åŒ–ã€‚åŒæ—¶ï¼Œå½“å‰æœåŠ¡ç«¯ç¨‹åºè¿˜ä¼šåœ¨å®¢æˆ·ç«¯æ–­å¼€è¿æ¥ä¹‹ååœæ­¢è¿è¡Œï¼Œè¿™è¿˜æ„å‘³ç€åä¸€ä¸ªæœåŠ¡ç«¯å¹¶ä¸ä¼šåƒé˜Ÿåˆ—ä¸€æ ·ä¾æ¬¡æ¥æ”¶å®¢æˆ·ç«¯ï¼Œè€Œæ˜¯åœ¨ç¬¬ä¸€ä¸ªå®¢æˆ·ç«¯å®Œæˆè¿æ¥ä¹‹åå…³é—­æœåŠ¡ï¼Œå¯¼è‡´åé¢çš„å®¢æˆ·ç«¯å¤±å»è¿æ¥ã€‚<br>
3. ä¿®æ”¹æœåŠ¡ç«¯ç¨‹åºï¼Œé‡‡ç”¨å¤šè¿›ç¨‹ ï¼ˆå¤šå¹¶å‘ç¼–ç¨‹ï¼‰</p>
<pre><code class="language-python">import socket,multiprocessing #å¼•å…¥å¤šè¿›ç¨‹å¤„ç†
SERVER_HOST = 'localhost'
SERVER_PORT = 7070
coding = ['utf-8','gbk']
def echo_handle(socket_conn,addr):
   with socket_conn: #åœ¨æ¥æ”¶åˆ°çš„ä¿¡æ¯å‰æ·»åŠ ã€Echoã€‘ç„¶åè¿”å› 
       #è¿æ¥ä¸Šäº†ä¹‹åæ‰whileå¾ªç¯ ä¸æ–­è¿›è¡Œé€šè®¯ 
       #ç¬¬ä¸€æ¬¡è¿æ¥æˆåŠŸå‘é€ä¸€æ¬¡æç¤º
       socket_conn.send('ã€Echoã€‘è¿æ¥æˆåŠŸï¼Œè¾“å…¥å­—ç¬¦å‘é€è¯·æ±‚ï¼Œè¾“å…¥byebyeç»“æŸé“¾æ¥ã€‚'.encode('utf-8'))
       while True:
           response = socket_conn.recv(100).decode(coding[0])
           if response.upper() == &quot;BYEBYE&quot;:
               print(f'å®¢æˆ·ç«¯-{addr[1]}å‘é€ç»ˆæ­¢æŒ‡ä»¤ï¼Œè¿æ¥ç»“æŸ...')
               socket_conn.send('byebye'.encode(coding[0]))
               break
           else:
               socket_conn.send(f'ã€Echoã€‘{response}'.encode(coding[0]))
def echo_server():
   with socket.socket() as server_socket:
       server_socket.bind((SERVER_HOST,SERVER_PORT)) #bind()å‡½æ•°ä¼ å…¥å…ƒç»„
       server_socket.listen()  #ç›‘å¬ç«¯å£
       print('æœåŠ¡ç«¯å·²å¯åŠ¨ï¼Œç­‰å¾…å®¢æˆ·ç«¯é“¾æ¥...')
       while True:
           socket_conn,addr = server_socket.accept() #ç­‰å¾…æ¥æ”¶ è¿›å…¥é˜»å¡ å› æ­¤åœ¨æ²¡æœ‰æ¥æ”¶åˆ°å®¢æˆ·ç«¯è¯·æ±‚çš„æ—¶å€™whileä¼šåœæ­¢åœ¨è¿™é‡Œ æ¥æ”¶åˆ°ä¸€ä¸ªå¾ªç¯ä¸€æ¬¡
           process = multiprocessing.Process(target=echo_handle,args=(socket_conn,addr),name=f'å®¢æˆ·ç«¯è¿›ç¨‹-{addr[1]}')
           process.start() #å¯åŠ¨è¿›ç¨‹

if __name__ == '__main__':
   echo_server()            
</code></pre>
<p>PS.é«˜å¹¶å‘ -&gt; å¤„ç†å¥½æœåŠ¡ç«¯çš„å¤„ç†æ•ˆç‡ã€‚<br>
è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼šä¸€éœ€è¦å¯¼å…¥<code>multiprocessing</code>æ¨¡å—å¤„ç†å¤šè¿›ç¨‹ï¼›äºŒéœ€è¦å°†å¤„ç†å‡½æ•°å•ç‹¬å‰¥ç¦»å‡ºå»ï¼Œç„¶åæ ¹æ®æ¯ä¸€ä¸ªè¯·æ±‚åˆ›å»ºä¸€ä¸ªè¿›ç¨‹å“åº”ï¼›ä¸‰<code>multiprocessing.Process</code>å®ä¾‹åŒ–å‚æ•°ä¸­<code>target</code>è¡¨ç¤ºç›®æ ‡å‡½æ•°ï¼Œ<code>args</code>è¡¨ç¤ºä¼ å…¥è¿›å‡½æ•°çš„å‚æ•°ï¼Œ<code>name</code>è¡¨ç¤ºè¿›ç¨‹çš„åå­—ã€‚å››è¿˜éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨è¿›å…¥<code>accept</code>çš„æ—¶å€™ï¼Œä¸»è¿›ç¨‹ä¼šè¿›å…¥é˜»å¡ï¼Œè¿™æ„å‘³ç€å¤–è¾¹çš„whileå¾ªç¯ä¼šæš‚åœåœ¨<code>accept()</code>è¿™é‡Œï¼Œç›´åˆ°æ¥å—åˆ°åæ‰è¿›è¡Œä¸‹ä¸€ä¸ªå¾ªç¯ï¼Œä¹Ÿå°±æ˜¯è¿›å…¥ä¸‹ä¸€ä¸ªé˜»å¡ç­‰å¾…ï¼Œè¿™ä¹Ÿè§£å†³äº†ä¿®æ”¹ä¹‹å‰æœåŠ¡ç«¯ä¼šåœ¨ä¸€ä¸ªå®¢æˆ·ç«¯ç»ˆæ­¢è¿æ¥ä¹‹åç»“æŸæœåŠ¡ï¼Œä»–ä¼šä¸€ç›´è¿è¡Œã€‚</p>
<p>#=&gt;<br>
UDPé€šè®¯<br>
ç›¸å¯¹äºTCPæ˜¯ä¸€ç§ä¸å®‰å…¨è¿æ¥ï¼Œä½†æ˜¯æƒ³èƒ½ç›¸å¯¹è¾ƒå¥½ã€‚åœ¨pythonä½¿ç”¨ä¸­å·®åˆ«ä¸å¤§ï¼Œåªéœ€è¦åœ¨å¼•ç”¨socketä¸­æŒ‡å®šå¯¹åº”å‚æ•°ï¼ŒåŒæ—¶ä¹Ÿä¸éœ€è¦ç›‘å¬ã€æ¥æ”¶ä¿®æ”¹ä¸ºrecvfrom()ã€å‘é€ä¿®æ”¹ä¸ºsendto()ã€‚</p>
<ol>
<li>UDPæœåŠ¡ç«¯</li>
</ol>
<pre><code class="language-python">import socket
SERVER_HOST = 'localhost'
SERVER_PORT = 7070

def main():
    #socket.AF_INETè¡¨ç¤ºä½¿ç”¨ipv4ç½‘ç»œåè®®è¿›è¡ŒæœåŠ¡ç«¯åˆ›å»º
    #socket.SOCK_DGRAM åˆ›å»ºä¸€ä¸ªæ•°æ®æŠ¥ï¼ˆUDP) åè®®çš„ç½‘ç»œç«¯
    with socket.socket(socket.AF_INET,socket.SOCK_DGRAM)  as udp_server:
        udp_server.bind((SERVER_HOST,SERVER_PORT)) #bind()å‡½æ•°ä¼ å…¥å…ƒç»„
        print(f'æœåŠ¡å™¨å¯åŠ¨å®Œæˆï¼Œç›‘å¬ç«¯å£{SERVER_PORT}')
        while True: #æœåŠ¡ç«¯å“åº”å°±æ˜¯åœ¨æ”¶åˆ°çš„ä¿¡æ¯å‰é¢æ·»åŠ ã€Echoã€‘
            data,addr = udp_server.recvfrom(100) #ä¸æ–­æ¥æ”¶å®¢æˆ·ç«¯ä¿¡æ¯
            print(f'ã€æœåŠ¡å™¨ã€‘å®¢æˆ·ç«¯{addr[0]}:{addr[1]}æˆåŠŸè¿æ¥ï¼')
            echo_data = f'ã€Echoã€‘{data.decode(&quot;utf-8&quot;)}'.encode('utf-8')
            udp_server.sendto(echo_data,addr) #å°†å†…å®¹ç›¸åº”ç»™æ¥æ”¶åˆ°ä¿¡æ¯çš„å¯¹åº”çš„å®¢æˆ·ç«¯
if __name__ =='__main__':
    main()
</code></pre>
<ol start="2">
<li>UDPå®¢æˆ·ç«¯</li>
</ol>
<pre><code class="language-python">import socket
SERVER_HOST = 'localhost'
SERVER_PORT = 7070

#UDPå®¢æˆ·ç«¯ä¸TCPå®¢æˆ·ç«¯çš„ä¸åŒå°±åœ¨äº ä¸€æ˜¯åè®®ä¸åŒ äºŒæ˜¯ä¸éœ€è¦è¿›è¡Œè¿æ¥ åªéœ€è¦ä¸æ–­åœ°å‘é€æ¥æ”¶å³å¯
def echo_udp_client():
    with socket.socket(socket.AF_INET,socket.SOCK_DGRAM) as client:
        while True:
            send_data = input('è¯·è¾“å…¥æƒ³å‘é€çš„æ•°æ®...\n')
            if send_data:
                client.sendto(send_data.encode('utf-8'),(SERVER_HOST,SERVER_PORT))
                data,addr = client.recvfrom(100) #recvfromä¼šæ¥å—ä¸€ä¸ªå…ƒç»„ åŒ…å«ä¸¤ä¸ªå…ƒç´ dataå’Œä¸»æœºåœ°å€ è€Œä¸»æœºåœ°å€åˆæ˜¯ä¸€ä¸ªå…ƒç»„ åŒ…å«ä¸»æœºåœ°å€å’Œç«¯å£ä¸¤ä¸ªå…ƒç´ 
                print(data.decode('utf-8'))
            else: #å¦‚æœè¾“å…¥å†…å®¹ä¸ºç©º é‚£ä¹ˆç¨‹åºç»“æŸ
                break

if __name__ == '__main__':
    echo_udp_client()
</code></pre>
<ol start="3">
<li>send/sendto, recv/recvfromåŒºåˆ«<br>
PS. 1. UDPä¸éœ€è¦å»ºç«‹ç¨³å®šçš„é“¾æ¥ ï¼Œä¸å—åˆ°è¿æ¥çš„æ§åˆ¶ï¼Œä¸éœ€è¦è€ƒè™‘å¤šè¿æ¥ï¼ˆä¸éœ€è¦è€ƒè™‘å¹¶å‘ï¼‰ï¼Œéœ€è¦ä¸æ–­çš„æ¥æ”¶ï¼Œä½†åªéœ€è¦å°†å“åº”çš„ä¿¡æ¯åŸè·¯è¿”å›ç»™å¯¹åº”çš„å®¢æˆ·ç«¯å³å¯ã€‚2. UDPæ˜¯ä¸€ç§æ— è¿æ¥åè®®ï¼Œå› æ­¤ä¸èƒ½ä½¿ç”¨<code>telnet</code>å‘½ä»¤è¿›è¡Œè¿æ¥æµ‹è¯•ã€‚</li>
</ol>
<h1 id="-5">=&gt;</h1>
<p>UDPå¹¿æ’­</p>
<ol>
<li>UDPå¹¿æ’­æ¥æ”¶ç«¯</li>
</ol>
<pre><code class="language-python">import socket
BROASTCAT_CLIENT_ADDR = ('0.0.0.0',21567) #å®¢æˆ·ç«¯ç»‘å®šåœ°å€

def mian():
    with socket.socket(socket.AF_INET,socket.SOCK_DGRAM) as client: #è¿™é‡Œä¸å˜
        #è®¾ç½®å¹¿æ’­æ¨¡å¼
        client.setsockopt(socket.SOL_SOCKET,socket.SO_BROADCAST,1)
        client.bind(BROASTCAT_CLIENT_ADDR) #ç»‘å®šå¹¿æ’­å®¢æˆ·ç«¯çš„åœ°å€
        while True:
            message,addr = client.recvfrom(100)
            print(f'æ¥æ”¶åˆ°çš„å¹¿æ’­å®¢æˆ·ç«¯æ•°æ®ï¼šã€{message.decode(&quot;utf-8&quot;)}ã€‘,å¹¿æ’­æ¥æºä¸º{addr[0]}:{addr[1]}')

if __name__ == '__main__':
    mian()
</code></pre>
<ol start="2">
<li>UDPå¹¿æ’­å‘é€ç«¯(æœåŠ¡ç«¯)</li>
</ol>
<pre><code class="language-python">import socket
BROASTCAT_SERVER_ADDR = ('&lt;broadcast&gt;',21567) #å¹¿æ’­åœ°å€ 

def main():
    with socket.socket(socket.AF_INET,socket.SOCK_DGRAM) as server_socket: #è¿™é‡Œä¸å˜ è®¾ç½®UDPç¼–ç 
        #è®¾ç½®å¹¿æ’­æ¨¡å¼
        server_socket.setsockopt(socket.SOL_SOCKET,socket.SO_BROADCAST,1)
        server_socket.sendto(f'è¿™æ˜¯ä¸€æ¡æ¥è‡ªæœåŠ¡ç«¯çš„å¹¿æ’­...'.encode('utf-8'),BROASTCAT_SERVER_ADDR)

if __name__ == '__main__':
    main()
</code></pre>
<ol start="3">
<li>éœ€è¦æ³¨æ„çš„ç‚¹/å…·ä½“è§£é‡Š<br>
å…³é”®çš„å‡½æ•°é…ç½®é¡¹ï¼š</li>
</ol>
<blockquote>
<p>setsockopt(self,level:int,optname:int.value:Union[int,bytes])<br>
level: è®¾ç½®é€‰é¡¹æ‰€åœ¨çš„åè®®å±‚ç¼–å·ï¼Œæœ‰å››ä¸ªå¯ç”¨é…ç½®é¡¹<br>
socket.SOL_SOCKET åŸºæœ¬åµŒå¥—å­—æ¥å£<br>
socket.IPPROTO_IP ipv4åµŒå¥—å­—æ¥å£<br>
socket.IPPROTO_IPV6 ipv6åµŒå¥—å­—æ¥å£<br>
socket.IPPRPTP_TCP TCPåµŒå¥—å­—æ¥å£<br>
optname : è®¾ç½®é€‰é¡¹åç§°ï¼Œä¾‹å¦‚ï¼Œå¦‚æœè¦è¿›è¡Œå¹¿æ’­åˆ™å¯ä»¥ä½¿ç”¨â€œsocket.BROADCAâ€œ;<br>
value: è®¾ç½®é€‰é¡¹çš„å…·ä½“å†…å®¹</p>
</blockquote>
<p>ä¸ºä»€ä¹ˆè¦è®¾ç½®å¹¿æ’­çš„ç«¯å£å‘¢ï¼Ÿ</p>
<blockquote>
<p>&quot;å¹¿æ’­æœ‰ä¸€ä¸ªå¹¿æ’­ç»„ï¼Œå³åªæœ‰ä¸€ä¸ªå¹¿æ’­ç»„å†…çš„èŠ‚ç‚¹æ‰èƒ½æ”¶åˆ°å‘å¾€è¿™ä¸ªå¹¿æ’­ç»„çš„ä¿¡æ¯ã€‚ä»€ä¹ˆå†³å®šäº†ä¸€ä¸ªå¹¿æ’­ç»„å‘¢ï¼Œå°±æ˜¯ç«¯å£å·ï¼Œå±€åŸŸç½‘å†…ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå¦‚æœè®¾ç½®äº†å¹¿æ’­å±æ€§å¹¶ç›‘å¬äº†ç«¯å£å·Aåï¼Œé‚£ä¹ˆä»–å°±åŠ å…¥äº†Aç»„å¹¿æ’­ï¼Œè¿™ä¸ªå±€åŸŸç½‘å†…æ‰€æœ‰å‘å¾€å¹¿æ’­ç«¯å£Açš„ä¿¡æ¯ä»–éƒ½æ”¶çš„åˆ°ã€‚åœ¨å¹¿æ’­çš„å®ç°ä¸­ï¼Œå¦‚æœä¸€ä¸ªèŠ‚ç‚¹æƒ³æ¥å—Aç»„å¹¿æ’­ä¿¡æ¯ï¼Œé‚£ä¹ˆå°±è¦å…ˆå°†ä»–ç»‘å®šç»™åœ°å€å’Œç«¯å£Aï¼Œç„¶åè®¾ç½®è¿™ä¸ªsocketçš„å±æ€§ä¸ºå¹¿æ’­å±æ€§ã€‚&quot;<br>
<a href="https://blog.csdn.net/leonwei/article/details/6202976">reference</a></p>
</blockquote>
<p>å¯ä»¥ç†è§£ä¸ºï¼ŒæœåŠ¡ç«¯å‘åŒä¸€ä¸ªå±€åŸŸç½‘å†…çš„æ‰€æœ‰è®¾å¤‡çš„è¿™ä¸ªç«¯å£å·å‘é€æ¶ˆæ¯ï¼Œç„¶ååªæœ‰æ¥æ”¶ç«¯è®¾ç½®ä¸ºå¹¿æ’­æ¨¡å¼å¹¶ç»‘å®šè¿™ä¸ªç«¯å£ä¹‹åï¼Œæ‰èƒ½æ¥æ”¶åˆ°å®¢æˆ·ç«¯å‘ç€ä¸ªç«¯å£å‘é€çš„æ¶ˆæ¯ï¼›è€Œæ‰€æœ‰çš„å±€åŸŸç½‘å†…çš„è¿™ä¸ªç«¯å£çš„è®¾å¤‡å°±ç»„æˆäº†ä¸€ä¸ªå¹¿æ’­ç»„ã€‚å…·ä½“è®¾ç½®æ¥è¯´ï¼ŒæœåŠ¡ç«¯éœ€è¦è®¾ç½®è¿™ä¸ªå¹¿æ’­ç»„çš„ç«¯å£å’Œå¹¿æ’­æ¨¡å¼ï¼š</p>
<pre><code class="language-python">BROASTCAT_SERVER_ADDR = ('&lt;broadcast&gt;',21567) #å¹¿æ’­åœ°å€ 
......
server_socket.setsockopt(socket.SOL_SOCKET,socket.SO_BROADCAST,1) #è®¾ç½®å¹¿æ’­æ¨¡å¼ 
server_socket.sendto(f'è¿™æ˜¯ä¸€æ¡æ¥è‡ªæœåŠ¡ç«¯çš„å¹¿æ’­...'.encode('utf-8'),BROASTCAT_SERVER_ADDR) #å‘é€åˆ°å¹¿æ’­ç»„çš„è¿™ä¸ªç«¯å£
</code></pre>
<p>è€Œå®¢æˆ·ç«¯éœ€è¦è®¾ç½®å¹¿æ’­æ¥æºçš„åœ°å€å’Œå¹¿æ’­å‘é€çš„ç«¯å£å³å¯ï¼š</p>
<pre><code class="language-python">BROASTCAT_CLIENT_ADDR = ('0.0.0.0',21567) #å®¢æˆ·ç«¯ç»‘å®šåœ°å€
......
client.setsockopt(socket.SOL_SOCKET,socket.SO_BROADCAST,1) #
client.bind(BROASTCAT_CLIENT_ADDR) #ç»‘å®šå¹¿æ’­å®¢æˆ·ç«¯çš„åœ°å€
</code></pre>
<p>å¹¿æ’­æ¥æ”¶ç«¯ä¸ä¸€å®šèƒ½æ¥æ”¶åˆ°å¹¿æ’­ï¼Œä½†æ˜¯åªè¦æ‰“å¼€æ¥æ”¶ç«¯å°±å¯ä»¥æ¥æ”¶åˆ°å¹¿æ’­ï¼›å®¢æˆ·ç«¯æ‰§è¡Œä¹‹åå°±ä¼šä¸€ç›´ç­‰å¾…æœåŠ¡ç«¯å‘é€çš„æ¶ˆæ¯ã€‚</p>
<h1 id="-6">=&gt;</h1>
<p>HTTPåè®®/HTTPæœåŠ¡å™¨<br>
ä¼ ç»Ÿsocketéœ€è¦æä¾›ä¸¤ä¸ªç¨‹åºç«¯ï¼ˆæœåŠ¡ç«¯ã€å®¢æˆ·ç«¯ï¼‰ï¼Œå› æ­¤æ¯ä¸€æ¬¡æœåŠ¡ç«¯å‡çº§éƒ½éœ€è¦è¿›è¡Œå®¢æˆ·ç«¯å¼ºåˆ¶æ›´æ–°ã€‚å› æ­¤åœ¨ä¼ ç»Ÿç½‘ç»œç¼–ç¨‹çš„åŸºç¡€ä¸Šå°±å®ç°äº†HTTPåè®®ï¼ˆHTTPæ˜¯å¯¹TCPåè®®çš„ä¸€ç§æ›´é«˜çº§çš„åŒ…è£…ï¼‰ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰å®Œå…¨è„±ç¦»ä¼ ç»Ÿçš„TCPåè®®ï¼Œæ˜¯åœ¨TCPåè®®å‰é¢æ·»åŠ çš„å¤´éƒ¨ä¿¡æ¯ã€‚<br>
HTTP - è¶…æ–‡æœ¬ä¼ è¾“åè®® æ˜¯å¯¹B/Sæ¶æ„çš„æ ‡å‡†åè®®<br>
B/Sç›¸å¯¹äºC/Sçš„å¥½å¤„å°±æ˜¯ä¸ç”¨åœ¨å¼€å‘ä¸€å¥—å®¢æˆ·ç«¯<br>
åœ¨æ•´ä¸ªhttpå¼€å‘æµç¨‹ä¸­ï¼Œæœ€é‡è¦çš„è®¾è®¡å°±æ˜¯htmlä»£ç çš„å¼€å‘ã€‚ä½†å¯¹äºwebæœåŠ¡å™¨å¼€å‘è€Œè¨€ï¼Œæœ€é‡è¦çš„æ˜¯æ¸…æ¥šhttpæœåŠ¡å™¨çš„å¼€å‘ã€‚<br>
åœ¨æ•´ä¸ªhttpè¯·æ±‚å’Œå“åº”çš„å¤„ç†è¿‡ç¨‹ä¸­ï¼Œå…³é”®é—®é¢˜å°±åœ¨äºè¯·æ±‚å’Œå“åº”çš„å¤´éƒ¨ä¿¡æ¯æœ‰å“ªäº›ã€å“åº”çŠ¶æ€ç ã€‚<br>
HTTPåè®®ä¸­ï¼Œè®¾è®¡äº†å¤šç§è¯·æ±‚æ¨¡å¼ï¼Œä¸»è¦æœ‰getã€postã€‚<br>
httpå¤´éƒ¨ä¿¡æ¯ï¼š<br>
httpçŠ¶æ€ç ï¼š1**ã€2**ã€3**ã€4**ã€<br>
å¸¸è§å“åº”å¤´ä¿¡æ¯</p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[scrapyçˆ¬è™«æ¡†æ¶æ·±å…¥ç†è§£ -- æœªæ•´ç†å®Œ]]></title>
        <id>http://localhost:4000/post/scrapy-pa-chong-kuang-jia-geng-shen-ru-li-jie-yi-ji-shi-yong/</id>
        <link href="http://localhost:4000/post/scrapy-pa-chong-kuang-jia-geng-shen-ru-li-jie-yi-ji-shi-yong/">
        </link>
        <updated>2023-06-17T08:41:17.000Z</updated>
        <content type="html"><![CDATA[<h2 id="1-loggingæ¨¡å—">1. loggingæ¨¡å—</h2>
<h2 id="2-ç¯å¢ƒå˜é‡setting">2. ç¯å¢ƒå˜é‡ï¼ˆsettingï¼‰</h2>
<p><a href="https://doc.scrapy.org/en/latest/topics/settings.html#topics-settings">å®˜æ–¹æ–‡æ¡£</a></p>
<h3 id="21-å¦‚ä½•è®¾ç½®å¹¶è®¿é—®setting">2.1 å¦‚ä½•è®¾ç½®å¹¶è®¿é—®setting</h3>
<h4 id="211-åœ¨spiderä¸­">2.1.1 åœ¨spiderä¸­</h4>
<p>spiderä¸­ï¼Œsettingæ˜¯ä¸€ä¸ªç»§æ‰¿scrapy.Spiderçš„ä¸€ä¸ªå®ä¾‹å±æ€§ï¼Œå¯ä»¥é€šè¿‡self.settingè®¿é—®å¯¹åº”åœ¨setting.pyä¸­çš„ç¯å¢ƒå˜é‡ã€‚</p>
<pre><code class="language-python">#åœ¨setting.pyæ–‡ä»¶ä¸­
MONGO_URI=' å¯¹åº”çš„URI'
</code></pre>
<pre><code class="language-python">#åœ¨spiderä¸­è°ƒç”¨
class ExampleSpider(scrapy.Spider):
    ...#çœç•¥
    def parse(self, response):
        mongodb = self.settings['MONGO_URI']
        logging.log(logging.INFO,mongodb)
    #ä¼šåœ¨æ—¥å¿—ä¸­è¾“å‡º
    #2023-06-17 16:44:04 [root] INFO: å¯¹åº”çš„URI
</code></pre>
<p>scrapyåŒæ ·æ”¯æŒä¸ºæ¯ä¸€ä¸ªSpiderè®¾ç½®ä¸åŒçš„ç¯å¢ƒå˜é‡ï¼Œä»¥é¿å…æ‰€æœ‰ç¯å¢ƒå˜é‡éƒ½æŒ¤åœ¨ä¸€ä¸ªsetting.pyæ–‡ä»¶ä¸­é€ æˆè‡ƒè‚¿ã€‚åœ¨æ¯ä¸€ä¸ªspiderå®ä¾‹ä¸­éƒ½æœ‰ä¸€ä¸ªç»§æ‰¿æ¥çš„custom_settingså±æ€§å¯ä»¥ä¿®æ”¹ï¼Œå®ƒæ˜¯ä¸€ä¸ªå­—å…¸ç±»å‹ï¼Œæ‰€æœ‰å•ç‹¬çš„ç¯å¢ƒå˜é‡éƒ½å¯ä»¥åœ¨è¿™é‡Œå£°æ˜ï¼ŒåŒ…æ‹¬cookies, header, ä»¥åŠå…¶ä»–å¯ä»¥å†™åœ¨setting.pyæ–‡ä»¶ä¸­çš„å˜é‡ã€‚å£°æ˜æ–¹æ³•è·ŸSpiderçš„nameå±æ€§ç›¸åŒã€‚è°ƒç”¨åˆ™é€šè¿‡self.custom_settingsä½¿ç”¨åœ¨æ–¹æ³•ä¸­ã€‚</p>
<h4 id="212-åœ¨pipelineç­‰å…¶ä»–ç»„ä»¶ä¸­">2.1.2 åœ¨pipelineç­‰å…¶ä»–ç»„ä»¶ä¸­</h4>
<p>ä½¿ç”¨ç±»æ–¹æ³•from_crawler()å¯ä»¥è®¿é—®åˆ°<br>
<a href="https://docs.scrapy.org/en/latest/topics/settings.html#how-to-access-settings">å®˜æ–¹æ–‡æ¡£å‚è€ƒ</a></p>
<blockquote>
<p>â€œ<strong>Settings can be accessed through the scrapy.crawler.Crawler.settings attribute of the Crawler that is passed to from_crawler method in extensions, middlewares and item pipelines</strong>â€</p>
</blockquote>
<p>ç¤ºä¾‹ä»£ç ï¼š</p>
<pre><code class="language-python">class MyExtension:
    def __init__(self, log_is_enabled=False):
        if log_is_enabled:
            print(&quot;log is enabled!&quot;)

    @classmethod
    def from_crawler(cls, crawler):
        settings = crawler.settings
        return cls(settings.getbool(&quot;LOG_ENABLED&quot;))
</code></pre>
<p>åœ¨<code>from_crawler()</code>æ–¹æ³•ä¸­çš„settingå¯¹è±¡æ˜¯ä¸€ä¸ªç±»å­—å…¸å¯¹è±¡ï¼Œå› æ­¤å¯ä»¥ç”¨å­—å…¸çš„æ–¹å¼è®¿é—®ç¯å¢ƒå˜é‡(ä¾‹å¦‚ï¼š<code>e.g., settings['LOG_ENABLED']</code>)ï¼Œä½†æ˜¯ä¸ºäº†é¿å…å¯èƒ½çš„ç±»å‹é”™è¯¯ï¼ˆæ¯”å¦‚è°ƒç”¨éœ€è¦intç±»å‹ï¼Œä½†æ˜¯ç¯å¢ƒå˜é‡ä¸­æ˜¯strç±»å‹ï¼Œç›´æ¥ä½¿ç”¨keyè®¿é—®å°±å¯èƒ½è¿”å›intç±»å‹é€ æˆé”™è¯¯ï¼‰ï¼Œæ›´æ¨èä½¿ç”¨settingå¯¹è±¡çš„apiã€‚</p>
<blockquote>
<p><a href="https://docs.scrapy.org/en/latest/topics/api.html#scrapy.settings.Settings">å®˜æ–¹æ–‡æ¡£ä¸­settingå¯¹è±¡çš„api</a><br>
åŒ…æ‹¬<code>get()</code>,<code>getbool()</code>, <code>getdict()</code>, <code>getdictorlist()</code>, <code>getfloat()</code>,  <code>getint()</code>,  <code>getlist()</code>ç­‰ï¼Œç”¨é€”ä¹Ÿèƒ½ä»æ–¹æ³•åæ˜¾è€Œæ˜“è§å‡ºï¼Œå…·ä½“è¯·å‚è€ƒå®˜æ–¹é“¾æ¥ã€‚</p>
</blockquote>
<h2 id="1-crawleræ¨¡å—">1. crawleræ¨¡å—</h2>
<h2 id="2-itemæºç å¦‚ä½•å®ç°å­˜å‚¨keyå­—æ®µ">2. itemæºç å¦‚ä½•å®ç°å­˜å‚¨keyå­—æ®µ,</h2>
<p>https://www.cnblogs.com/twelfthing/articles/4709287.html<br>
https://www.cnblogs.com/fengf233/p/11298623.html#2.field()%E7%B1%BB</p>
<h2 id="5-å¤šä¸ªspiderä»¥åŠå¤šä¸ªpipelineå¯¹åº”çš„è®¾ç½®">5. å¤šä¸ªSpiderä»¥åŠå¤šä¸ªPipelineå¯¹åº”çš„è®¾ç½®</h2>
<p>https://www.ziji.work/python/scrapy-many-spider-pipeline.html#SCRAPYSPIDER-4</p>
<h2 id="6-å¤§ä½¬çš„æºç è§£æ">6. å¤§ä½¬çš„æºç è§£æ</h2>
<p>è™½ç„¶ç°åœ¨åŸºæœ¬çœ‹ä¸æ‡‚ï¼ˆÃ—<br>
http://kaito-kidd.com/2016/11/09/scrapy-code-analyze-entrance/</p>
<h2 id="7-è®¿é—®setting">7. è®¿é—®setting</h2>
<h2 id="8-ä¸ºä»€ä¹ˆfrom_crawleræ–¹æ³•éœ€è¦è®¾ç½®ä¸ºç±»æ–¹æ³•">8. ä¸ºä»€ä¹ˆfrom_crawleræ–¹æ³•éœ€è¦è®¾ç½®ä¸ºç±»æ–¹æ³•ï¼Ÿ</h2>
<p><a href="https://www.keepnight.com/archives/1126/">æç‚¹é“¾æ¥</a><br>
æœ€åè¿™ç¯‡åšå®¢çš„æœ€åä¸€å¥è¯ç®€ç›´ä¸€ä¸‹å­ç»™æˆ‘ç‚¹é€äº†ï¼Œè™½ç„¶ä¹‹å‰ä¸“é—¨å»æŸ¥äº†<code>@classmethod</code>ã€factory methodè¿™äº›ä¸œè¥¿ï¼Œä½†ä¸ºä»€ä¹ˆè¿™ä¹ˆåšè¿˜æ˜¯å¾ˆæ··ä¹±ã€‚</p>
<blockquote>
<p><strong>å¤§æ¦‚å°±æ˜¯æ£€æµ‹spiderç±»æœ‰æ²¡æœ‰from_crawlerï¼Œæœ‰çš„è¯å°±returnä¸€ä¸ªcls()çš„å®ä¾‹åŒ–å¯¹è±¡ï¼Œäº§ç”Ÿå®ä¾‹åŒ–å¯¹è±¡åä¼šè‡ªåŠ¨è°ƒ__init__æ–¹æ³•ã€‚</strong></p>
</blockquote>
<p>ç»“åˆå®˜æ–¹æ–‡æ¡£çš„<a href="https://docs.scrapy.org/en/latest/topics/api.html?highlight=crawler#scrapy.crawler.CrawlerRunner.create_crawler">Crawler API</a>ã€<a href="https://docs.scrapy.org/en/latest/topics/item-pipeline.html#from_crawler">pipelineä¸­from_crawler()æ–¹æ³•</a>ã€<a href="https://docs.scrapy.org/en/latest/topics/spiders.html?highlight=crawler#scrapy.Spider.from_crawler">Spiderä¸­from_crawler()æ–¹æ³•</a>ï¼Œä»¥åŠ<a href="http://kaito-kidd.com/2016/11/09/scrapy-code-analyze-entrance/">å¤§ä½¬å¯¹scrapyæºç çš„è§£æ</a>æ‰æœ‰ä¸€ç§çªç„¶é†’æ‚Ÿçš„æ„Ÿè§‰ã€‚</p>
<blockquote>
<p>PS. è¿™é‡Œæˆ‘ä¸€ç›´çŠ¯äº†ä¸€ä¸ªæ¦‚å¿µä¸Šçš„é”™è¯¯ï¼Œæˆ‘ä¸€ç›´ä»¥ä¸ºç¤ºä¾‹ä»£ç ä¸­<code>from_crawler(cls, cralwer)</code> çš„crawleræ˜¯ç±»çš„å±æ€§å‚æ•°ï¼ˆæˆ‘è¯¯è®¤ä¸ºæ˜¯æœ‰ç‚¹åƒæ„é€ æ–¹æ³•ä¸­çš„å‚æ•°ï¼Œè¢«æˆ‘ææ··äº†ğŸ˜£ï¼‰ï¼Œæ˜¯ä¸€ä¸ªå®šä¹‰åœ¨å½“å‰ç±»é‡Œé¢çš„ä¸€ä¸ªç»§æ‰¿è¿‡æ¥çš„å±æ€§ï¼Œå› æ­¤èŠ±äº†å¾ˆå¤šæ—¶é—´å»æŸ¥è¿™ä¸ª<code>crawler</code>åœ¨scrapyä¸­çš„ä½œç”¨ã€‚ä½†æ˜¯å®é™…ä¸Šå®ƒåªæ˜¯ä¸€ä¸ªå‡½æ•°çš„å½¢å‚ï¼Œå®ƒæœ¬èº«ä¸å¸¦æœ‰ä»»ä½•æ„ä¹‰ï¼ˆå°±åƒæ˜¯å®šä¹‰å‡½æ•°çš„æ—¶å€™æ‹¬å·é‡Œçš„a,b,c,dç­‰å‚æ•°ä¸€æ ·ï¼‰ã€‚ç„¶ååˆå› ä¸ºcrawleråœ¨scrapyåˆæ˜¯ä¸€ä¸ªå…³é”®å¯¹è±¡ï¼Œæ‰€ä»¥æŸ¥äº†å¾ˆä¹…éƒ½æ²¡æœ‰ç»“æœã€‚<br>
ç›´åˆ°æˆ‘çœ‹åˆ°äº†ä¸Šé¢é‚£ç¯‡æç‚¹é“¾æ¥çš„åšå®¢ï¼Œè¿™æ‰æƒ³é€šäº†ã€‚</p>
</blockquote>
<p>ä»æˆ‘çš„ç†è§£æ¥è¯´ ï¼š<br>
ç¬¬ä¸€æ­¥ï¼Œåœ¨è¿è¡Œè¿™ä¸ªçˆ¬è™«ä¹‹å‰ï¼Œscrapyä¼šä¸ºè¿è¡Œåšä¸€äº›å‡†å¤‡ï¼Œå…¶ä¸­å°±åŒ…æ‹¬åˆ¤æ–­pipelineï¼Œ spider, è¿˜æœ‰å…¶ä»–ä¸€äº›ç»„ä»¶ä¸­çš„<code>from_crawler()</code>æ–¹æ³•æ˜¯å¦è¢«é‡å†™ï¼Œè¿™ä¸ªåˆ¤æ–­å°±éœ€è¦åœ¨ç±»æ²¡æœ‰å®ä¾‹åŒ–ä¹‹å‰è°ƒç”¨ï¼Œæ‰€ä»¥<code>from_crawler()</code>è¢«å®šä¹‰ä¸ºç±»æ–¹æ³•ã€‚<br>
ç¬¬äºŒæ­¥ï¼Œä¹‹åæ ¹æ®å…·ä½“çš„ç±»ï¼Œåœ¨ä»Crawlerè¿™ä¸ªå¯¹è±¡ä¸­å®ä¾‹åŒ–ä¸€ä¸ªå¯¹åº”çš„from_crawleræ–¹æ³•ã€‚<br>
ä¸Šé¢è¿™å¥è¯æœ‰ä¸¤ç‚¹éœ€è¦ç€é‡ç†è§£ã€‚</p>
<ol>
<li>ç¬¬ä¸€ç‚¹ï¼Œè¿™ä¹Ÿå°±æ˜¯<code>from_crawler()</code>æ˜¯ä¸€ä¸ªâ€œfactory methodâ€ï¼Œscrapyä¼šæ ¹æ®ä¸åŒçš„å¯¹è±¡ä¸ºç±»èµ‹äºˆä¸åŒçš„<code>from_crawler()</code>æ–¹æ³•ã€‚åœ¨æˆ‘çš„ç†è§£ä¸­ï¼Œå°±æ˜¯æœ‰ä¸€ä¸ªç±»ï¼Œä¸“é—¨è´Ÿè´£ä¸ºå…¶ä»–ä¸åŒçš„ç±»èµ‹äºˆä¸åŒçš„<code>from_crawler()</code>æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯<strong>ç±»æ–¹æ³•çš„ç±»</strong>ã€‚</li>
<li>ç¬¬äºŒç‚¹ï¼Œscrapyä»Crawler<code>åˆ›å»ºfrom_crawler()</code>çš„å«ä¹‰å°±æ˜¯ä¸ºè¿™ä¸ªæ–¹æ³•ä¼ å…¥ä¸€ä¸ª<code>scrapy.crawler.Crawler</code>å¯¹è±¡ï¼Œè€Œè¿™ä¸ªå¯¹è±¡åˆæ˜¯ç”±scrapyé€šè¿‡ä¸€ä¸ª<code>Spiderå­ç±»</code>å’Œ<code>scrapy.settings.Settings </code>å¯¹è±¡å®ä¾‹åŒ–è€Œæ¥ã€‚</li>
</ol>
<blockquote>
<p><a href="https://docs.scrapy.org/en/latest/topics/api.html#scrapy.crawler.Crawler">å®˜æ–¹æ–‡æ¡£</a><br>
<strong><code>classscrapy.crawler.Crawler(spidercls, settings)</code></strong><br>
<strong>The Crawler object must be instantiated with a scrapy.Spider subclass and a scrapy.settings.Settings object.</strong></p>
</blockquote>
<p>å› æ­¤ï¼Œåœ¨Crawlerå¯¹è±¡ä¸­å°±æœ‰èƒ½è¿‡è·å–settingçš„APIï¼Œè¿™ä¸ªAPIå’Œ2.1.2ä¸­çš„settingå¯¹è±¡çš„ä¸€æ¨¡ä¸€æ ·ï¼ˆå› ä¸ºæœ¬æ¥å°±æ˜¯ä¸€ä¸ªä¸œè¥¿ğŸ‘ï¼Œéƒ½æ˜¯settingå¯¹è±¡ï¼Œè¿™é‡Œå°±æœ‰ä¸²èµ·æ¥çš„æ„Ÿè§‰äº†ï¼‰</p>
<h3 id="9-è®¾ç½®cookies">9. è®¾ç½®cookies</h3>
<p><a href="https://zhuanlan.zhihu.com/p/337212121">çŸ¥ä¹å‚è€ƒ</a>ä½†æ˜¯æ²¡æœ‰è®²åŸç†</p>
<h3 id="10-å…³é—­scrapyæ—¥å¿—">10. å…³é—­scrapyæ—¥å¿—</h3>
<p><a href="https://www.qiniu.com/qfans/qnso-33203620">å‚è€ƒ</a><br>
<a href="https://coding.imooc.com/learn/questiondetail/133488.html">è§£å†³æ–¹æ³•</a></p>
<p>æ·»åŠ twistedå®šæ—¶å™¨ ä»¥åŠ è¾“å‡ºè°ƒç”¨æ—¥å¿—<br>
https://www.jianshu.com/p/5a5cdd7f2bfb</p>
<h3 id="11-å®šæ—¶è°ƒåº¦scrapy">11. å®šæ—¶è°ƒåº¦scrapy</h3>
<p>https://blog.csdn.net/python36/article/details/82683528</p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[scrapy itemèµ‹å€¼/å¡«å…… ç»†èŠ‚æ³¨æ„]]></title>
        <id>http://localhost:4000/post/scrapy-item-fu-zhi-tian-chong-xi-jie-zhu-yi/</id>
        <link href="http://localhost:4000/post/scrapy-item-fu-zhi-tian-chong-xi-jie-zhu-yi/">
        </link>
        <updated>2023-06-16T07:29:41.000Z</updated>
        <content type="html"><![CDATA[<h2 id="1-èµ·å› ">1.  èµ·å› </h2>
<p>æˆ‘åœ¨çˆ¬å–åˆ°å¾®åšçƒ­æœçš„jsonæ•°æ®ä¹‹åï¼Œå‘æ— è®ºå¦‚ä½•éƒ½ä¼šæŠ¥é”™æ•°æ®åº“å­—æ®µæ–¹é¢çš„é—®é¢˜ï¼Œå…·ä½“æŠ¥é”™å¦‚ä¸‹ï¼š</p>
<pre><code>Traceback (most recent call last):
  File &quot;D:\anaconda\envs\DjangoEnv\Lib\site-packages\twisted\internet\defer.py&quot;, line 892, in _runCallbacks
    current.result = callback(  # type: ignore[misc]
  File &quot;D:\anaconda\envs\DjangoEnv\Lib\site-packages\scrapy\utils\defer.py&quot;, line 307, in f
    return deferred_from_coro(coro_f(*coro_args, **coro_kwargs))
  File &quot;D:\Aproject\django-project\project5-scrapy-tutorial\project_2\tutorial\tutorial\pipelines.py&quot;, line 46, in process_item    
    self.db[collection_name].insert_one(dict(hot))
ValueError: dictionary update sequence element #0 has length 1; 2 is required
</code></pre>
<p>å…·ä½“çš„åŸå› ä¸€ç›´ä¸æ¸…æ¥šï¼Œåªèƒ½æ¨¡ç³Šçš„çŒœæµ‹å®åœ¨å‘æ•°æ®åº“å¯¼å…¥æ•°æ®çš„æ—¶å€™ï¼Œå› ä¸ºæ ¼å¼çš„åŸå› å‡ºé”™äº†ï¼Œä½†å…·ä½“æ˜¯ä»€ä¹ˆåŸå› ï¼Œæˆ‘æŠŠä»£ç çœ‹äº†ä¸€éåˆä¸€éæ€ä¹ˆä¹Ÿæ‰¾ä¸å‡ºæ¥å“ªé‡Œé”™äº†ã€‚çŒœæµ‹å¯èƒ½æ˜¯çˆ¬å–çš„jsonæ•°æ®è§£æé”™è¯¯ï¼Œæ‰€ä»¥å°†jsonæ•°æ®ä¸‹è½½åˆ°æ–‡ä»¶ä¸­ï¼Œç„¶ååœ¨jupyterä¸­ä¸æ–­è°ƒè¯•ä¸æ–­æ‰¾ï¼Œçœ‹çœ‹æˆ‘æ˜¯æŠŠé‚£ä¸ªæ‹¬å·ç»™æ¼äº†ğŸ˜¡ã€‚<br>
æœ€åå®åœ¨æ˜¯æ‰¾ä¸åˆ°äº†ï¼Œæƒ³ç€æ˜¯ä¸æ˜¯å¯ä»¥é€šè¿‡è°ƒè¯•ä¸€æ­¥ä¸€æ­¥çš„åˆ¤æ–­å“ªé‡Œå‡ºé”™äº†ï¼Œä½†æ˜¯æˆ‘æ²¡æœ‰åœ¨scrapyçš„æ–‡æ¡£ä¸­æ‰¾åˆ°å…³äºpipelineçš„è°ƒè¯•æ–¹æ³•ï¼ˆåªæœ‰å…³äºspiderçš„ï¼‰ï¼Œæœ€ååœ¨çŸ¥ä¹ä¸Šä¸€ç¯‡æ–‡ç« æ‰¾åˆ°äº†æ–¹æ³•ï¼Œ<a href="https://zhuanlan.zhihu.com/p/25200262">å‚è€ƒé“¾æ¥</a>ï¼Œä½†æ˜¯ä½œè€…çš„æ–¹æ³•åœ¨æˆ‘ï¼ˆwindows11+vscï¼‰è¿è¡Œä¹‹åä¼šæŠ¥é”™ï¼Œä¹‹åå‚è€ƒäº†è¯„è®ºåŒºçš„æ–¹æ³•ï¼Œåœ¨å’Œ<code>scrapy.cfg</code>åŒä¸€å±‚ï¼ˆé¡¹ç›®æ ¹ç›®å½•ä¸­ï¼‰ä¸­å»ºç«‹<code>run.py</code>æ–‡ä»¶ï¼Œè¾“å…¥ä»¥ä¸‹ä»£ç ï¼Œå†åœ¨é¡¹ç›®ä¸­è®¾ç½®æ–­ç‚¹ï¼Œç„¶ådebugæ–‡ä»¶<code>run.py</code>ï¼Œå°±å¯ä»¥å®ç°è°ƒè¯•çš„åŠŸèƒ½ã€‚</p>
<blockquote>
<p>å…·ä½“ä»£ç ï¼š</p>
</blockquote>
<pre><code class="language-python">import os
from scrapy.cmdline import execute
os.chdir(os.path.dirname(os.path.realpath(__file__)))
try:
    execute(
    [
    'scrapy',
    'crawl',
    'weibo', #è¿™é‡Œæ¢æˆå¯¹åº”çš„spideråå­—
    '-o',
    'out.json',
    ]
    )
except SystemExit:
    pass    
</code></pre>
<h2 id="2-è°ƒè¯•ä¹‹å">2.  è°ƒè¯•ä¹‹å</h2>
<p>åœ¨è°ƒè¯•ä¹‹åï¼Œæˆ‘å‘ç°<code>pipeline.py</code>æ–‡ä»¶ä¸­å¯¹åº”classç±»ä¸­çš„<code>process_item()</code>æ–¹æ³•ä¸­çš„<code>item</code>å˜é‡å¹¶ä¸æ˜¯æˆ‘æƒ³è±¡ä¸­çš„æ˜¯ä¸€ä¸ªç”±å­—å…¸å…ƒç´ ç»„æˆçš„åˆ—è¡¨ï¼Œè€Œæ˜¯ä¸€ä¸ªå­—å…¸ï¼Œå¹¶ä¸”keyæ˜¯åœ¨<code>item.py</code>æ–‡ä»¶ä¸­è®¾å®šçš„ï¼Œvalueæ˜¯åœ¨<code>parse()</code>æ–¹æ³•ä¸­èµ‹å€¼çš„ã€æˆ‘æƒ³è¦çš„å­—å…¸å…ƒç´ åˆ—è¡¨ã€‚ç»ˆäºç¡®å®šçš„åŸå› ï¼Œå› æ­¤ä¿®æ”¹ä¹Ÿå¾ˆç®€å•ã€‚</p>
<h2 id="3-ä¿®æ”¹">3. ä¿®æ”¹</h2>
<p>å°†åŸæœ¬çš„<code>process_item()</code>æ–¹æ³•ä¿®æ”¹å³å¯</p>
<pre><code class="language-python">def process_item(self,item,spider):
    now = datetime.datetime.now() #ä»¥å½“å‰äº‹ä»¶ä½œä¸ºcollectionçš„åå­—
    collection_name = datetime.datetime.strftime(now,'%Y-%m-%d:%H:%M:%S')

    #åŸæ¥é”™è¯¯çš„ï¼š 
    #for hot in item:  -&gt;ä¿®æ”¹ä¸ºä¸‹é¢çš„éƒ¨åˆ†
    for hot in item['realtime']: 
        self.db[collection_name].insert_one(dict(hot))
    return item
</code></pre>
<h2 id="4-æ¢ç©¶åŸå› ">4. æ¢ç©¶åŸå› </h2>
<p><a href="https://docs.scrapy.org/en/latest/topics/items.html#item-types">å®˜æ–¹æ–‡æ¡£</a><br>
é¦–å…ˆï¼Œå¼€å‘è€…ä¸ºäº†æ–¹ä¾¿åœ¨pythonä¸­å¤„ç†çˆ¬åˆ°çš„webæ•°æ®ï¼Œå› æ­¤å°†itemç±»è®¾è®¡ä¸ºç±»å­—å…¸ç»“æ„ï¼Œå¹¶ä¸”å®Œå…¨copyäº†pythonä¸­dictçš„apiï¼ˆcvå¤§æ³•å¥½ğŸ˜‹ï¼‰</p>
<blockquote>
<p><strong>Item objects replicate the standard dict API, including its __init__ method.</strong></p>
</blockquote>
<p>å› æ­¤å®é™…ä¸Šï¼Œitemç±»å°±æ˜¯ä¸€ä¸ªåœ¨scrapyä¸­çš„spider, pipelineä¹‹é—´è¿›è¡Œæ•°æ®äº¤æ¢çš„å­—å…¸ç±»ã€‚ä»–çš„æµç¨‹å°±æ˜¯ï¼š<br>
ç¬¬ä¸€æ­¥ï¼Œåœ¨<code>item.py</code>æ–‡ä»¶ä¸­è®¾å®šitemçš„keyå€¼ï¼›<br>
ç¬¬äºŒéƒ¨ï¼Œåœ¨spiderä¸­çš„<code>parse</code>æ–¹æ³•ä¸­è¢«è§£æå¥½çš„ç½‘é¡µæ•°æ®å¡«å……value;<br>
ç¬¬ä¸‰æ­¥ï¼Œé€šè¿‡pipelineä¿å­˜æˆä¸ºæ–‡ä»¶/ä¿å­˜åˆ°æ•°æ®åº“ç­‰</p>
<p>è¯¦ç»†çš„ä¾‹å­å¦‚ä¸‹ï¼š<br>
4.1 åœ¨items.pyä¸­è§„å®šä¸€ä¸ªç±»ï¼Œå¦‚ä¸‹ï¼š</p>
<pre><code class="language-python">class Example(scrapy.Item): #å¿…é¡»ç»§æ‰¿scrapy.Item æ‰èƒ½ä½¿ç”¨å¯¹åº”çš„api
    realtime = scrapy.Field() 
</code></pre>
<blockquote>
<p>è¿™é‡Œçš„Field()çš„ä½œç”¨<br>
PS.<a href="https://docs.scrapy.org/en/latest/topics/items.html#scrapy.item.scrapy.Field">å®˜æ–¹æ–‡æ¡£</a><br>
&quot; The Field class is just an alias to the built-in dict class and doesnâ€™t provide any extra functionality or attributes.&quot; è¡¨æ˜Fieldç±»ä¹‹é™…ä¸Šåªæ˜¯pythonå†…ç½®å­—å…¸çš„åˆ«åï¼Œæ²¡æœ‰å…¶ä»–ä»»ä½•åˆ«çš„ä½œç”¨ï¼ˆ<a href="https://www.cnblogs.com/fengf233/p/11298623.html#2.field()%E7%B1%BB">Field()æºç è§£æ</a>ï¼‰ï¼Œå½“ç„¶å¤æ‚çš„è€Œæ˜¯itemå¦‚ä½•ï¼ˆè¯´å®è¯æ²¡çœ‹æ‡‚ğŸ˜µ<a href="https://www.cnblogs.com/twelfthing/articles/4709287.html">itemæºç è§£æ</a>ï¼‰ã€‚<br>
å½“ç„¶ä¹Ÿå¯ä»¥é‡å†™<code>Overriding the serialize_field() method</code>æ–¹æ³•ï¼Œå»è§„å®šå…·ä½“çš„æ•°æ®ç±»å‹ï¼ˆ<a href="https://docs.scrapy.org/en/latest/topics/exporters.html#overriding-the-serialize-field-method">å…·ä½“å‚è€ƒå®˜æ–¹æ–‡æ¡£</a>ï¼‰<br>
æ•´ä¸ªitemç±»çš„ä½¿ç”¨éå¸¸ç±»ä¼¼ä¸Djangoçš„Formç±»ï¼Œä¸è¿‡Field()è§„å®šçš„å­—æ®µç±»å‹æ˜¯è¿œè¿œç®€å•ä¸Djangoçš„ã€‚</p>
</blockquote>
<p>4.2 ç„¶åå†spiderä¸­æˆ‘çˆ¬å–åˆ°çš„æ˜¯ä¸€ä¸ªjsonæ•°æ®ï¼Œä¾‹å¦‚</p>
<pre><code class="language-json">{
&quot;ok&quot;: 1,
    &quot;data&quot;: {
        &quot;realtime&quot;: [
                {
                &quot;star_name&quot;: {},
                &quot;word_scheme&quot;: &quot;#æ–°é—»æ ‡é¢˜#&quot;,
                &quot;emoticon&quot;: &quot;&quot;,
            }
        ]}
}
</code></pre>
<p>4.3 ç„¶åæˆ‘åœ¨å¯¹item.pyæ–‡ä»¶ä¸­çš„ç±»è¿›è¡Œå¡«å……ï¼Œå¦‚ä¸‹ï¼š</p>
<pre><code class="language-python">class ExampleSpider(scrapy.Spider):
    ...#ç•¥
    def parse(self, response):
            jsondata = json.loads(response.text)          #ä½¿ç”¨scrapyä¸­responseå±æ€§textå°†çˆ¬å–åˆ°çš„ç½‘é¡µè§£æä¸ºstrï¼Œç„¶åä½¿ç”¨json.loadsæ–¹æ³•è½¬åŒ–ä¸ºå­—å…¸æ ¼å¼
            realtime = jsondata['data']['realtime'] #æå–çƒ­æœæ•°æ®åˆ—è¡¨
            item = Example() #å®ä¾‹åŒ–item
            item['realtime'] = realtime
            return item
</code></pre>
<p>è¿™é‡Œéœ€è¦é‡ç‚¹æ³¨æ„<code> item['realtime'] = realtime</code>ï¼Œè™½ç„¶åœ¨ä¹‹å‰å·²ç»å°†realtimeåˆ—è¡¨æå–å‡ºæ¥ï¼Œä½†æ˜¯åœ¨å¡«å……çš„æ—¶å€™ï¼Œä¼ å…¥pipelineä¸­è¿›è¡Œå‚¨å­˜çš„å®é™…ä¸Šæ˜¯ä¸€ä¸ªitemå­—å…¸ï¼Œå­—å…¸keyæ˜¯åœ¨item.pyæ–‡ä»¶ä¸­å®šä¹‰çš„å±æ€§ï¼Œå­—å…¸valueæ˜¯åœ¨parseæ–¹æ³•ä¸­å¡«å……çš„å¯¹è±¡ã€‚æ‰€ä»¥å®é™…ä¸Šä¼ å…¥åˆ°pipelineæ¨¡å—ä¸­çš„itemç»“æ„æ˜¯å¦‚ä¸‹ï¼š</p>
<pre><code class="language-json">{ 
    'realtime': [{
        &quot;star_name&quot;: {},
        &quot;word_scheme&quot;: &quot;#æ–°é—»æ ‡é¢˜#&quot;,
        &quot;emoticon&quot;: &quot;&quot;,
    },
    ]
}
</code></pre>
<p>4.4 ä¹Ÿå°±æ˜¯æ„å‘³ç€ï¼Œå¦‚æœä½ åœ¨pipeline.pyæ–‡ä»¶çš„å¯¹åº”ç±»ä¸­çš„process_itemæ–¹æ³•ä¸­ï¼Œå¦‚æœéœ€è¦ç”¨åˆ°åŸæœ¬çš„åˆ—è¡¨ï¼Œé¦–å…ˆä»itemå­—å…¸ä¸­æå–å‡ºæ¥ï¼Œå…·ä½“å¦‚ä¸‹ï¼š</p>
<pre><code class="language-python">    def process_item(self,item,spider):
            #....
        for hot in item['realtime']:
            #....
        return item
</code></pre>
]]></content>
    </entry>
</feed>