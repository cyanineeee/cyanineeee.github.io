<html>
  <head>
    <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>djangoå­¦ä¹  -- å‰åç«¯ä¸åˆ†ç¦»çš„ -- part.2 | cyanine</title>
<link rel="shortcut icon" href="https://cyanineeee.github.io/favicon.ico?v=1727687297417">
<link href="https://cdn.jsdelivr.net/npm/remixicon@2.3.0/fonts/remixicon.css" rel="stylesheet">
<link rel="stylesheet" href="https://cyanineeee.github.io/styles/main.css">
<link rel="alternate" type="application/atom+xml" title="djangoå­¦ä¹  -- å‰åç«¯ä¸åˆ†ç¦»çš„ -- part.2 | cyanine - Atom Feed" href="https://cyanineeee.github.io/atom.xml">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Droid+Serif:400,700">



    <meta name="description" content="35.æ—¶é—´é€‰æ‹©æ’ä»¶
download_link
office_link
usage

ä½¿ç”¨æå…¶ç®€å•ï¼šåªéœ€è¦é€‰æ‹©domç„¶åç»‘å®šå³å¯ï¼Œåœ¨ä½¿ç”¨æ–¹æ³•é‡Œå¯ä»¥è®¾ç½®å„ç§å‚æ•°

$('#id_presettime').datetimepicker({
  ..." />
    <meta name="keywords" content="" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">
    <script src="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.5.1/build/highlight.min.js"></script>
  </head>
  <body>
    <div class="main">
      <div class="main-content">
        <div class="site-header">
  <a href="https://cyanineeee.github.io">
  <img class="avatar" src="https://cyanineeee.github.io/images/avatar.png?v=1727687297417" alt="">
  </a>
  <h1 class="site-title">
    cyanine
  </h1>
  <p class="site-description">
    my personal blog
  </p>
  <div class="menu-container">
    
      
        <a href="/" class="menu">
          Home Page
        </a>
      
    
      
        <a href="/archives" class="menu">
          Archive
        </a>
      
    
      
        <a href="/tags" class="menu">
          Tags
        </a>
      
    
      
        <a href="/post/about" class="menu">
          About
        </a>
      
    
  </div>
  <div class="social-container">
    
      
    
      
    
      
    
      
    
      
    
  </div>
</div>

        <div class="post-detail">
          <article class="post">
            <h2 class="post-title">
              djangoå­¦ä¹  -- å‰åç«¯ä¸åˆ†ç¦»çš„ -- part.2
            </h2>
            <div class="post-info">
              <span>
                2023-06-30
              </span>
              <span>
                14 min read
              </span>
              
            </div>
            
            <div class="post-content-wrapper">
              <div class="post-content" v-pre>
                <h3 id="35æ—¶é—´é€‰æ‹©æ’ä»¶">35.æ—¶é—´é€‰æ‹©æ’ä»¶</h3>
<p><a href="https://www.bootcss.com/p/bootstrap-datetimepicker/index.htm">download_link</a><br>
<a href="https://bootstrap-datepicker.readthedocs.io/en/latest/options.html">office_link</a><br>
<a href="https://blog.csdn.net/qq_28633249/article/details/77142352">usage</a></p>
<ul>
<li>ä½¿ç”¨æå…¶ç®€å•ï¼šåªéœ€è¦é€‰æ‹©domç„¶åç»‘å®šå³å¯ï¼Œåœ¨ä½¿ç”¨æ–¹æ³•é‡Œå¯ä»¥è®¾ç½®å„ç§å‚æ•°</li>
</ul>
<pre><code class="language-js">$('#id_presettime').datetimepicker({
   format: 'yyyy-mm-dd hh:ii'
});   
</code></pre>
<h3 id="36modelfieldå®šä¹‰æˆæˆè¡¨å•çš„å±æ€§æ ·å¼">36.modelfieldå®šä¹‰æˆæˆè¡¨å•çš„å±æ€§æ ·å¼</h3>
<pre><code class="language-python">class orderForm(ModelForm):
    class Meta():
        model = Orderform
        fields = &quot;__all__&quot;

    #æ–¹æ³•ä¸€ åŸç”Ÿçš„å±æ€§
    widgets = {
        #ä¸ºhtmlè¡¨å•ä¸­nameç±»å‹çš„inputæ ‡ç­¾æ·»åŠ &quot;class=form-control&quot;
        'name' : forms.TextInput(attrs = {&quot;class&quot; : &quot;form-control&quot;})
        #ä¸ºhtmlè¡¨å•ä¸­passwordç±»å‹çš„inputæ ‡ç­¾æ·»åŠ &quot;class=form-control&quot;
        'password' : formsPasswordInput( attrs = {&quot;class&quot; : &quot;form-control&quot;})
        ...
    }

    #æ–¹æ³•äºŒ æ‰©å†™çˆ¶ç±»å‡½æ•°çš„å±æ€§
        def __init__(self,*arg,**kwargs):
            super().__init__(*arg,**kwargs)
            for name, field in self.fields.items():
                # print(name,field) #è¿™ä¸ªæ˜¯å±•ç¤º self.fields.items()å¯ä»¥ç›´æ¥æ‹¿åˆ°å®šä¹‰åœ¨Metaä¸­çš„fieldså­—æ®µ
                field.widget.attrs = {'class' : 'form-control'} #ä¸ºç”Ÿæˆçš„è¡¨å•inputèµ‹äºˆcsså±æ€§ 
</code></pre>
<ul>
<li>æ‰©å…… è¿™ä¸ªå±æ€§å¯ä»¥ç»§æ‰¿ ä¸è¿‡æš‚æ—¶å¯¹æˆ‘æ²¡ä»€ä¹ˆç”¨å¤„ å› æ­¤passè¿‡</li>
</ul>
<h3 id="37ä¿®æ”¹dajngoçš„modelformç±»çš„inputçš„typeç±»å‹ä¸ºdatetime-local">37.ä¿®æ”¹dajngoçš„modelformç±»çš„<code>input</code>çš„<code>type</code>ç±»å‹ä¸º<code>datetime-local</code></h3>
<ul>
<li>ç¬¬ä¸€ç§æ˜¯é€šè¿‡å‰ç«¯jså®ç°ï¼Œä¸€å…±ä¸‰æ­¥ï¼šç¬¬ä¸€æ‹¿åˆ°åŸå§‹çš„æ—¶é—´æ•°æ®ï¼Œç¬¬äºŒé€‰æ‹©inputæ¡†ç„¶åä¿®æ”¹typeï¼Œç¬¬ä¸‰è®²åŸå§‹çš„æ—¶é—´æ•°æ®ä¿®æ”¹æ ¼å¼ä¹‹ååœ¨èµ‹äºˆç»™inputæ¡†ï¼š</li>
</ul>
<pre><code class="language-js">function changeDatetimeInput(id){
    var time = $(`#${id}`).val().replaceAll('/','-');
    $(`#${id}`).attr('type','datetime-local');
    $(`#${id}`).val(time)
}
changeDatetimeInput('id_presettime');
changeDatetimeInput('id_endtime');
</code></pre>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåç«¯djangoä¼ æ¥çš„ä¹‹é—´ç±»å‹æ˜¯<code>yyyy/mm/dd hh:ii</code>ï¼Œä½†æ˜¯htmlå†…ç½®çš„æ—¶é—´é€‰æ‹©inputæ¡†çš„æ—¶é—´å­—ç¬¦ä¸²æ ¼å¼è¦æ±‚æ˜¯<code>yyyy-mm-ddThh:ii</code>ï¼Œå› æ­¤éœ€è¦å°†åŸæ¥çš„æ–œæ ï¼ˆ/ï¼‰æ›¿æ¢æˆçŸ­æ¨ªï¼ˆ-ï¼‰ï¼Œä¸­é—´Â·çš„<code>T</code>æ˜¯ä¸€ä¸ªæ—¶é—´å­—ç¬¦è¡¨ç¤ºï¼Œå¯ä»¥ç”¨å¤§å†™å­—ç¬¦Tè¡¨ç¤ºï¼Œä½†æœ€ç»ˆè§£æçš„æ—¶å€™ç©ºæ ¼ä¹Ÿå¯ä»¥ï¼Œ<a href="https://blog.csdn.net/jim_LoveQ/article/details/107457771">å…·ä½“å‚è€ƒ</a></p>
<ul>
<li>ç¬¬äºŒç§å°±æ˜¯ä¿®æ”¹djangoçš„<code>DateTimeInput</code><br>
è¿™ç§çœ‹ä¸æ‡‚åŸå› ï¼Œä½†æ˜¯å¦‚æœåªæ˜¯ä»…ä»…ä¿®æ”¹input_typeçš„è¯æ˜¯è§£æä¸äº†çš„ï¼Œå›ç­”ç»™å‡ºçš„åŸå› æ˜¯åç«¯ä¼šå› ä¸ºè¾“å…¥åˆæ³•åˆ¤æ–­å’Œä¸é€šè¿‡ï¼Œ<a href="https://stackoverflow.com/questions/50214773/type-datetime-local-in-django-form">detail_link_and_solution</a></li>
</ul>
<pre><code class="language-python">from django import forms
class DateTimeLocalInput(forms.DateTimeInput):
    input_type = &quot;datetime-local&quot;

class DateTimeLocalField(forms.DateTimeField):
    # Set DATETIME_INPUT_FORMATS here because, if USE_L10N 
    # is True, the locale-dictated format will be applied 
    # instead of settings.DATETIME_INPUT_FORMATS.
    # See also: 
    # https://developer.mozilla.org/en-US/docs/Web/HTML/Date_and_time_formats
    input_formats = [
        &quot;%Y-%m-%dT%H:%M:%S&quot;, 
        &quot;%Y-%m-%dT%H:%M:%S.%f&quot;, 
        &quot;%Y-%m-%dT%H:%M&quot;
    ]
    widget = DateTimeLocalInput(format=&quot;%Y-%m-%dT%H:%M&quot;)
</code></pre>
<p>ç„¶åå†è‡ªå·±çš„modelformä¸­å°†æƒ³è¦ä¿®æ”¹inputçš„typç±»å‹ä¸ºdatetime-localçš„å­—æ®µè®¾ç½®ä¸º<code>DateTimeLocalField</code>å³å¯ï¼š</p>
<pre><code class="language-python">#ç”¨æ³•
class orderEditForm(ModelForm):
    presettime = DateTimeLocalField() #åœ¨è¿™é‡Œå°†æƒ³è¦çš„å­—æ®µè®¾ç½®å³å¯
    class Meta():
        model = Orderform
        fields = &quot;__all__&quot;
</code></pre>
<pre><code class="language-html">&lt;!-- {{field}}ç”Ÿæˆçš„å…·ä½“æ ·å¼  --&gt;
&lt;input type=&quot;text&quot; name=&quot;endtime&quot; value=&quot;1899/12/31 00:00&quot; class=&quot;form-control&quot; id=&quot;id_endtime&quot;&gt;
</code></pre>
<h3 id="38é€šè¿‡validationerroræ¥ä¸ºé’©å­æ–¹æ³•è®¾ç½®éæ³•è¾“å…¥æç¤ºä¿¡æ¯">38.é€šè¿‡validationErroræ¥ä¸ºé’©å­æ–¹æ³•è®¾ç½®éæ³•è¾“å…¥æç¤ºä¿¡æ¯</h3>
<p><code>raise ValidationError</code></p>
<h3 id="39å¯†ç åŠ å¯†-é€šè¿‡é’©å­æ–¹æ³•å®šä¹‰">39.å¯†ç åŠ å¯† é€šè¿‡é’©å­æ–¹æ³•å®šä¹‰</h3>
<ul>
<li>é’©å­æ–¹æ³•è¿”å›çš„å°±æ˜¯å‚¨å­˜åˆ°æ•°æ®åº“ä¸­</li>
<li>md5åŠ å¯† åŠ å¯†éœ€è¦â€œç›â€ï¼Œä¸ºäº†æ–¹ä¾¿å’Œæ•ˆæœ ä½¿ç”¨djangoåœ¨è®¾ç½®ä¸­ç”Ÿæˆçš„secret_keyæ¥å½“ä½œâ€œç›â€</li>
</ul>
<pre><code class="language-python">from django.conf import settings
import hashlib

def md5(data_string):
    obj = hashlib.md5(settings.SECRET_KEY.encode('utf-8'))
    obj.update(data_string.encode('utf-8'))
    return obj.hexdigest()
</code></pre>
<h3 id="40å¯¹äºdjanfoçš„ormå¦‚æœæœç´¢ä¸åˆ°">40.å¯¹äºdjanfoçš„ORMï¼Œå¦‚æœæœç´¢ä¸åˆ°</h3>
<p>æœç´¢ä¸åˆ°å°±è¿”å›Noneï¼Œå¯ä»¥ç”¨æ¥åˆ¤æ–­æ˜¯å¦æ˜¯åˆæ³•è¯·æ±‚</p>
<h3 id="41å¯¹äºè¡¨å•éªŒè¯">41.å¯¹äºè¡¨å•éªŒè¯</h3>
<p>æ‰€æœ‰éªŒè¯é€šè¿‡çš„ä¿¡æ¯éƒ½å‚¨å­˜åœ¨å¯¹åº”çš„<code>cleaned_data</code>ä¸­</p>
<h3 id="42djangoæŠ¥é”™">42.djangoæŠ¥é”™</h3>
<p><code>'Manager' object is not callable</code><br>
åŸå› æ˜¯<code>objects</code>æ˜¯ä¸€ä¸ªå±æ€§è€Œä¸æ˜¯ä¸€ä¸ªæ–¹æ³•ï¼Œå†™æˆ<code>objects()</code>ä¼šæŠ¥è¿™ä¸ªé”™</p>
<h3 id="43ç”¨æˆ·ç™»å½•">43.ç”¨æˆ·ç™»å½•</h3>
<ul>
<li>cookies å’Œ session<br>
æ— çŠ¶æ€çŸ­é“¾æ¥<br>
é€šè¿‡cookiesç»™ç”¨æˆ·å‘æ”¾ä¸€ä¸ªâ€œå‡­è¯â€ï¼Œ ä¿å­˜åœ¨æµè§ˆå™¨ä¸­çš„é”®å€¼å¯¹ï¼Œå‘é€è¯·æ±‚çš„æ—¶å€™è‡ªåŠ¨æºå¸¦<br>
session djangoé»˜è®¤å‚¨å­˜åœ¨mysqlä¸­</li>
</ul>
<p>ä¸šåŠ¡è¿‡ç¨‹ï¼šæ”¶åˆ°ç”¨æˆ·çš„æäº¤ -&gt; æ ¡éªŒï¼ˆåœ¨æ•°æ®åº“æ¯”è¾ƒï¼‰ -&gt; æˆåŠŸ ç”Ÿæˆéšæœºå­—ç¬¦ä¸²å†™å…¥åˆ°ç”¨æˆ·æµè§ˆå™¨çš„cookiesä»¥åŠæ•°æ®åº“ä¸­ï¼ˆè¿™é‡Œåªéœ€è¦è°ƒç”¨<code>request.session()</code>æ–¹æ³•å³å¯ djangoä¼šè‡ªåŠ¨å¤„ç†ä¸¤ä¸ªäº‹ä»¶ï¼‰ï¼Œå¹¶ä¸”ä¼šå°†ä¼ å…¥çš„å­—ç¬¦ç»è¿‡å¤„ç†ä¹‹åï¼Œä»¥<code>{session_key:session_data}</code>é”®å€¼å¯¹çš„å½¢å¼ä¿å­˜åœ¨æ•°æ®åº“ä¸­ï¼Œå…¶ä¸­session_keyå°±æ˜¯ä¼ é€’ç»™æµè§ˆå™¨çš„cookiesï¼Œè€Œsession_dataå°±æ˜¯åœ¨ä¸‹é¢ä»£ç ä¸­å®šä¹‰çš„å­—å…¸ï¼ˆç»è¿‡å­—ç¬¦è½¬æ¢ï¼Œéœ€è¦ä½¿ç”¨çš„æ—¶å€™djangoä¼šè§£ç ï¼‰</p>
<pre><code class="language-python">        else: #ç™»é™†æˆåŠŸ
            request.session['info'] = { #å†™å…¥session
                'id':login_object.id,
                'name' : login_object.name,
            }
</code></pre>
<ul>
<li>
<p style="color:red;font-size:large;">PS. ç‰¹åˆ«éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨åé¢çš„è°ƒç”¨request.sessionä¸­çš„å±æ€§çš„åå­—éƒ½æ˜¯æ¥è‡ªäºæ­¤ï¼</p>
</li>
</ul>
<p>å› æ­¤éœ€è¦åœ¨ç”¨æˆ·è®¿é—®çš„æ—¶å€™åˆ¤æ–­ç”¨æˆ·æ˜¯å¦ç™»å½• -&gt; å·²ç™»å½•ç»§ç»­è®¿é—® æœªç™»å½•è·³è½¬å›ç™»é™†é¡µé¢ï¼š<br>
ç”¨æˆ·è¯·æ±‚-&gt; æ‹¿åˆ°ç”¨æˆ·cookieså¹¶åˆ¤æ–­ï¼š</p>
<pre><code class="language-python">#ç¬¬ä¸€ç§æ–¹æ³• åœ¨æ¯ä¸ªè¯·æ±‚å‰éƒ½åŠ ä¸Šå¯¹äºcookiesçš„åˆ¤æ–­
    if not request.session.get('info'):
        return redirect('/login/')
</code></pre>
<p>å¤ªlowğŸ˜<br>
åº”è¯¥ä½¿ç”¨djangoçš„ä¸­é—´ä»¶é«˜æ•ˆçš„å¤„ç†</p>
<h3 id="44djangoä¸­é—´ä»¶">44.djangoä¸­é—´ä»¶</h3>
<p><a href="https://docs.djangoproject.com/zh-hans/4.1/topics/http/middleware/">å®˜æ–¹æ–‡æ¡£</a></p>
<ul>
<li>å¯¹äºdjangoï¼Œæ¯ä¸€ä¸ªè¯·æ±‚éƒ½éœ€è¦ç»è¿‡å¾ˆå¤šä¸­é—´ä»¶ä¹‹åæ‰èƒ½è®¿é—®åˆ°è§†å›¾å‡½æ•°ï¼›åŒæ ·çš„ï¼Œæ‰€æœ‰çš„è§†å›¾å‡½æ•°è¿”å›å€¼éƒ½éœ€è¦ç»è¿‡å¾ˆå¤šä¸­é—´ä»¶çš„å¤„ç†æ‰ä¼šè¿”å›ç»™ç”¨æˆ·ã€‚</li>
<li>djangoçš„ä¸­é—´ä»¶éƒ½æ˜¯ç±»ï¼Œé€šè¿‡<code>process_request</code>æ–¹æ³•å¯¹ä¼ å…¥çš„è¯·æ±‚è¿›è¡Œå¤„ç†ï¼Œé€šè¿‡<code>process_response</code>å¯¹è§†å›¾å‡½æ•°çš„returnè¿›è¡ŒåŒ…è£…ã€‚å¦‚æœæŸä¸ªè¯·æ±‚ä¸èƒ½é€šè¿‡ä¸€ä¸ªä¸­é—´ä»¶ï¼Œé‚£ä¹ˆå°±ä¼šç›´æ¥è¿”å›ç»™ç”¨æˆ·ï¼Œè€Œä¸ä¼šåˆ°è¾¾è§†å›¾å‡½æ•°ã€‚</li>
<li>ä¸­é—´ä»¶å†™å¥½ä¹‹åéœ€è¦åœ¨setting.pyæ–‡ä»¶ä¸­çš„MIDDLEWAREä¸­æ³¨å†Œï¼ˆå…·ä½“åˆ°ç±»åï¼‰ï¼Œå“ªä¸ªåœ¨å‰é¢é‚£ä¸ªå…ˆæ‰§è¡Œã€‚</li>
<li>ä¸­é—´çš„<code>process_request</code>æ–¹æ³•å¦‚æœè¿”å›ä¸ºNoneï¼Œé‚£ä¹ˆç»§ç»­å‘åæ‰§è¡Œï¼›å¦‚æœéœ€è¦è¿”å›ï¼Œé‚£ä¹ˆè¿”å›çš„ç±»å‹ä¸è§†å›¾å‡½æ•°çš„è¿”å›ç±»ä¼¼ï¼ˆä¾‹å¦‚render,redirect,HttpResponseç­‰ï¼‰ï¼Œå¹¶ä¸”ä¸åœ¨å‘åæ‰§è¡Œã€‚</li>
<li>åº”ç”¨ä¸­é—´ä»¶ï¼š
<ul>
<li>1.æ³¨å†Œä¸­é—´ä»¶</li>
<li>2.ä¸­é—´ä»¶ä¸­è¿”å›å€¼</li>
<li>3.é€šè¿‡ä¸­é—´ä»¶å®ç°ç™»å½•æ ¡éªŒ<br>
ä»£ç å®ç°</li>
</ul>
</li>
</ul>
<pre><code class="language-python">#middleware.pyæ–‡ä»¶
from django.utils.deprecation import MiddlewareMixin
from django.shortcuts import render,redirect
from django.http import HttpResponse

class SessionChectMiddleware(MiddlewareMixin):
    def process_request(self,request):
        #æ’é™¤ä¸éœ€è¦ç™»é™†çš„é¡µé¢
        allow_url = ['/login/','/register/']
        if request.path_info in allow_url:
            return
        #è¯»å–session
        info = request.session.get('info')
        if info:
            return
        else: 
            return redirect('/login/')
</code></pre>
<pre><code class="language-python">#åœ¨setting.pyæ–‡ä»¶ä¸­æ³¨å†Œ
MIDDLEWARE = [
    &quot;django.middleware.security.SecurityMiddleware&quot;,
...... ,
    &quot;cake.middleware.SessionChectMiddleware&quot;,
]
</code></pre>
<p>PS. request.path_infoå¯ä»¥è·å–åˆ°è¯·æ±‚çš„urlè·¯å¾„ã€‚</p>
<h3 id="45æ³¨é”€æ“ä½œ-ç”¨æˆ·é€€å‡ºç™»å½•">45.æ³¨é”€æ“ä½œ - ç”¨æˆ·é€€å‡ºç™»å½•</h3>
<p>ä¹Ÿå°±æ˜¯å°†æµè§ˆå™¨çš„cookieså’Œsessionåˆ é™¤<br>
åŒæ ·ä½¿ç”¨request.sessionä¸­çš„æ–¹æ³•å³å¯</p>
<h3 id="46é€šè¿‡sessionè·å–ç”¨æˆ·ç™»å½•ä¿¡æ¯æ˜¾ç¤ºåœ¨å¯¼èˆªæ ">46.é€šè¿‡sessionè·å–ç”¨æˆ·ç™»å½•ä¿¡æ¯æ˜¾ç¤ºåœ¨å¯¼èˆªæ </h3>
<p>æ¯æ¬¡è§†å›¾å‡½æ•°çš„ä¸­ä¼ é€’çš„requestä¸­éƒ½åŒ…å«sessionå‚æ•°ï¼Œå› æ­¤å¯ä»¥ç›´æ¥åœ¨æ¨¡æ¿ä¸­è°ƒç”¨<code>{{request.session.info.å±æ€§}}</code>æ¥è·å–å¯¹åº”çš„ä¿¡æ¯ï¼ˆå› ä¸ºrequestæ˜¯é»˜è®¤ä¼ é€’çš„ï¼‰ï¼Œä¸ç”¨åˆ»æ„é€šè¿‡åˆ«çš„æ¨¡æ¿å‚æ•°æ¥æ¸²æŸ“ã€‚</p>
<pre><code class="language-python">    &lt;button class=&quot;btn btn-secondary dropdown-toggle btn-sm&quot; type=&quot;button&quot; id=&quot;dropdownMenuButton2&quot; data-bs-toggle=&quot;dropdown&quot; aria-expanded=&quot;false&quot;&gt;
                        {{ request.session.info.name}}
&lt;/button&gt;
</code></pre>
<h3 id="47formå’Œmodelform">47.formå’Œmodelform</h3>
<ul>
<li>formå¯ä»¥è‡ªå®šä¹‰å­—æ®µ<br>
modeformæ—¢å¯ä»¥è‡ªå®šä¹‰ è¿˜å¯ä»¥åœ¨æ•°æ®åº“ä¸­æ‹¿å–å­—æ®µ</li>
<li>formæ²¡æœ‰saveæ–¹æ³•å¯ä»¥ç›´æ¥å­˜å…¥åˆ°æ•°æ®åº“ ä½†æ˜¯modelformæœ‰</li>
</ul>
<h3 id="48å›¾ç‰‡éªŒè¯ç ">48.å›¾ç‰‡éªŒè¯ç </h3>
<p>-&gt; pythonä¸­å¦‚ä½•åŠ¨æ€ç”Ÿæˆå›¾ç‰‡å¹¶å†™å…¥å€¼ (ä¸åšè¿‡å¤šäº†è§£ ä»…ä»…å½“æˆé»‘ç›’ä½¿ç”¨)<br>
<a href="https://www.cnblogs.com/crischou/p/7152974.html">å‚è€ƒæ–‡çŒ®</a></p>
<ul>
<li>éœ€è¦pillowåº“</li>
</ul>
<pre><code class="language-python">import random
from PIL import Image,ImageFont,ImageDraw,ImageFilter
#éœ€è¦æ³¨æ„ï¼ï¼ è¿™é‡Œçš„å­—ä½“æ–‡ä»¶font_fileè·¯å¾„ç»„åˆæ˜¯åŸºäºè¿è¡Œçš„æ ¹ç›®å½•å†³å®šçš„ éœ€è¦æ ¹æ®ç›¸å¯¹ä½ç½®çš„ä¸åŒè¿›è¡Œè°ƒæ•´ï¼è¿™é‡Œæˆ‘å°†ä»–æ”¾åœ¨æ ¹ç›®å½•ä¸‹é¢çš„static/æ–‡ä»¶å¤¹å†…
def check_code(width=120, height=30, char_length=5, font_file='./static/kumo.ttf', font_size=28):
    # font = ImageFont.load_default() #ä½¿ç”¨é»˜è®¤å­—ä½“
    code = []
    img = Image.new(mode='RGB', size=(width, height), color=(255, 255, 255))
    draw = ImageDraw.Draw(img, mode='RGB')
    def rndChar():
        &quot;&quot;&quot;
        ç”Ÿæˆéšæœºå­—æ¯   
        :return:
        &quot;&quot;&quot;
        return chr(random.randint(65, 90))
    def rndColor():
        &quot;&quot;&quot;
        ç”Ÿæˆéšæœºé¢œè‰²
        :return:
        &quot;&quot;&quot;
        return (random.randint(0, 255), random.randint(10, 255), random.randint(64, 255))
    # å†™æ–‡å­—
    font = ImageFont.truetype(font_file, font_size)
    for i in range(char_length):
        char = rndChar()
        code.append(char)
        h = random.randint(0, 4)
        draw.text([i * width / char_length, h], char, font=font, fill=rndColor())
    # å†™å¹²æ‰°ç‚¹
    for i in range(40):
        draw.point([random.randint(0, width), random.randint(0, height)], fill=rndColor())
    # å†™å¹²æ‰°åœ†åœˆ
    for i in range(40):
        draw.point([random.randint(0, width), random.randint(0, height)], fill=rndColor())
        x = random.randint(0, width)
        y = random.randint(0, height)
        draw.arc((x, y, x + 4, y + 4), 0, 90, fill=rndColor())
    # ç”»å¹²æ‰°çº¿
    for i in range(5):
        x1 = random.randint(0, width)
        y1 = random.randint(0, height)
        x2 = random.randint(0, width)
        y2 = random.randint(0, height)

        draw.line((x1, y1, x2, y2), fill=rndColor())

    img = img.filter(ImageFilter.EDGE_ENHANCE_MORE)
    return img,''.join(code)
 
if __name__ == '__main__':
    # 1. ç›´æ¥æ‰“å¼€
    # img,code = check_code()
    # img.show()
 
    # 2. å†™å…¥æ–‡ä»¶
    img,code = check_code()
    with open('code.png','wb') as f:
        img.save(f,format='png')
 
    # 3. å†™å…¥å†…å­˜(Python3)
    # from io import BytesIO
    # stream = BytesIO()
    # img.save(stream, 'png')
    # stream.getvalue()
 
    # 4. å†™å…¥å†…å­˜ï¼ˆPython2ï¼‰
    # import StringIO
    # stream = StringIO.StringIO()
    # img.save(stream, 'png')
    # stream.getvalue()

    pass
</code></pre>
<p style='color:red'>éœ€è¦æ³¨æ„ï¼ï¼`check_code()`çš„å­—ä½“æ–‡ä»¶`font_file`è·¯å¾„ç»„åˆæ˜¯åŸºäºè¿è¡Œçš„æ ¹ç›®å½•å†³å®šçš„ éœ€è¦æ ¹æ®ç›¸å¯¹ä½ç½®çš„ä¸åŒè¿›è¡Œè°ƒæ•´ï¼è¿™é‡Œæˆ‘å°†ä»–æ”¾åœ¨æ ¹ç›®å½•ä¸‹é¢çš„`static/`æ–‡ä»¶å¤¹å†…</p>
+ ç„¶åå°±æ˜¯éƒ¨ç½²åˆ°djangä¸­ï¼šä¸»è¦æ˜¯å°†å‰ç«¯è¯·æ±‚å›¾ç‰‡çš„urlæ›¿æ¢ä¸ºåŠ¨æ€çš„ï¼Œç„¶åç”ŸæˆéªŒè¯ç çš„è§†å›¾å‡½æ•°è¿”å›å¯¹åº”çš„éªŒè¯ç å›¾ç‰‡ã€‚
```python
from .function.checkcode import check_code #è¿™ä¸ªå°±æ˜¯åˆšæ‰çš„ç”ŸæˆéªŒè¯ç å›¾ç‰‡çš„å‡½æ•°
from io import BytesIO #å°†å›¾ç‰‡å‚¨å­˜åˆ°å†…å­˜ä¸­éœ€è¦ç”¨çš„åº“
<p>def image_code(request):<br>
'''ç”ŸæˆéªŒè¯ç '''<br>
img,str = check_code()<br>
print(str)<br>
stream = BytesIO()<br>
img.save(stream, 'png')</p>
<pre><code>return HttpResponse(stream.getvalue()) #ä»å†…å­˜ä¸­è¯»å–åˆ°å›¾ç‰‡ç„¶åä»¥http responseçš„å½¢å¼ä¼ å›ç»™å‰ç«¯ å‰ç«¯çš„imgæ ‡ç­¾è§£æä¹‹åå°±æ˜¯ä¸€ä¸ªå›¾ç‰‡
</code></pre>
<pre><code>```html
&lt;img src=&quot;/image/code/&quot;&gt; 
&lt;!-- åªè¦è°ƒç”¨å¯¹åº”çš„urlå°±å¯ä»¥ --&gt;

</code></pre>
<p>PS. éœ€è¦æ³¨æ„çš„æ˜¯ï¼šåŒä¸€ä¸ªæ–‡ä»¶ä¸­ä¸è¦å‡ºç°åå­—ç›¸åŒçš„å‡½æ•°ï¼Œä¸ç®¡æ˜¯å¼•ç”¨çš„è¿˜æ˜¯æœ¬æ–‡ä»¶çš„ï¼Œä¼šå¯¼è‡´è°ƒç”¨å‡ºé”™</p>
<h3 id="49å¦‚ä½•éªŒè¯éªŒè¯ç å‘¢">49.å¦‚ä½•éªŒè¯éªŒè¯ç å‘¢ï¼Ÿ</h3>
<p>é€šè¿‡sessionï¼ - è¿™æ ·æ¯ä¸ªç”¨æˆ·åœ¨ç™»é™†çš„æ—¶å€™å¯¹äºéªŒè¯ç çš„éªŒè¯å°±ä¸ä¼šå—åˆ°å¹²æ‰°ï¼Œå¹¶ä¸”é‡å¤åˆ·æ–°ä¹Ÿä¼šæ›´æ–°sessionä¸­å¯¹åº”çš„éªŒè¯ç ã€‚<br>
è¿™é‡Œæœ‰å¾ˆå¤šéœ€è¦æ³¨æ„çš„ç‚¹ï¼</p>
<ul>
<li><code>add_errors()</code>å¯ä»¥å‘formsä¸­æŒ‡å®šå­—æ®µæ·»åŠ é”™è¯¯æç¤ºä¿¡æ¯ï¼Œç„¶åèƒ½åœ¨å‰ç«¯çš„<code>{{fields.å±æ€§å­—æ®µ.errors.0}}</code>ä¸­å–åˆ°ã€‚</li>
<li>ç”±äºéªŒè¯ç çš„å­—æ®µæ˜¯æ²¡æœ‰åœ¨ç”¨æˆ·model/æ•°æ®åº“è¡¨ä¸­å­˜åœ¨çš„ï¼Œå› æ­¤å¦‚æœç›´æ¥ä¼ å…¥<code>request.POST</code>ä½œä¸ºdataå‚æ•°ä¼šæŠ¥é”™ã€‚å› æ­¤åº”è¯¥å°†éªŒè¯ç å­—æ®µå•ç‹¬å‰”é™¤ã€‚</li>
<li>éªŒè¯ç éªŒè¯éœ€è¦è°ƒç”¨ä¹‹å‰åˆ›å»ºéªŒè¯ç æ—¶å­˜å…¥sessionçš„å­—æ®µï¼Œå°†ä¸¤ä¸ªå­—æ®µç›¸æ¯”è¾ƒåˆ¤æ–­æ˜¯å¦æ­£ç¡®ã€‚</li>
<li>ç™»å½•æˆåŠŸä¹‹åéœ€è¦é‡æ–°è®¾ç½®sessionçš„è¿‡æœŸæ—¶é—´ ï¼Œå› ä¸ºä¸ºäº†éªŒè¯ç çš„ç™»å½•æ—¶æ•ˆï¼Œåœ¨ç”ŸæˆéªŒè¯ç çš„æ—¶å€™ä¼šè®¾ç½®ä¿å­˜éªŒè¯ç å¯¹æ¯”å­—æ®µçš„sessionä¿¡æ¯æ—¶æ•ˆæ¯”è¾ƒçŸ­ï¼Œå› æ­¤ç™»å½•æˆåŠŸä¹‹åéœ€è¦é‡æ–°è®¾ç½®ã€‚<br>
æœ€ç»ˆçš„ç™»å½•é€»è¾‘</li>
</ul>
<pre><code class="language-python">from .models import UserInfo #modelä¸­çš„ç±» æ˜¯æœ€åŸæœ¬çš„ç”¨æˆ·ä¿¡æ¯ç±» åŒ…æ‹¬è´¦æˆ·åå’Œå¯†ç ä»¥åŠè‡ªåŠ¨ç”Ÿæˆçš„id
from io import BytesIO #ç”Ÿæˆå›¾ç‰‡å‚¨å­˜åœ¨å†…å­˜
from .encrypt import md5 #åŠ å¯†

class loginForm(forms.Form):
    name = forms.CharField(label='ç”¨æˆ·å',widget=forms.TextInput(
        attrs = {
            'class' :&quot;my-input-item&quot;
        }
    ))
    password = forms.CharField(label='å¯†ç ',widget=forms.PasswordInput(
        attrs = {
            'class' :&quot;my-input-item&quot;
        }
    ))
    code = forms.CharField(label='éªŒè¯ç ',widget=forms.TextInput(
        attrs={
            'class':&quot;my-input-item&quot; ,
            'style':&quot;margin-top:0;&quot; ,
            'placeholder':&quot;éªŒè¯ç &quot;
        }
    ),required=True)

    def cleaned_password(self):
        return md5(self.changed_data.get('password')) #md5åŠ å¯†

#ç™»å½•é¡µé¢ 
def login(request):
    if request.method == 'GET':
        form = loginForm()
        return render(request,'login.html',{
            'form':form
        })

    login_form = loginForm(data=request.POST)
    if login_form.is_valid():
        user_input_code = login_form.cleaned_data.pop('code') 
        #éªŒè¯ç çš„æ ¡éªŒ
        code = request.session.get('image_code','') #è¿™ä¸ªæ˜¯åœ¨ç”ŸæˆéªŒè¯ç çš„æ—¶å€™å­˜å…¥sessionä¸­çš„ï¼Œå¦‚æœè¿‡æ—¶æˆ–è€…è·å–ä¸åˆ°é»˜è®¤ä¸ºç©º
        if code.upper() != user_input_code.upper(): #ä¸è€ƒè™‘å¤§å°å†™ 
            #å¦‚æœéªŒè¯ç ä¸ç›¸ç­‰
            login_form.add_error('code','éªŒè¯ç é”™è¯¯')
            return render(request,'login.html',{
                'form' : login_form,
            })

        login_object = UserInfo.objects.filter(**login_form.cleaned_data).first() #æ ¡éªŒç”¨æˆ·å¯†ç 
        if not login_object:
            login_form.add_error('name','ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯')
            return render(request,'login.html',{
                'form' : login_form,
            })
        else: #ç™»é™†æˆåŠŸ
            request.session['info'] = { #å†™å…¥session
                'id':login_object.id,
                'name' : login_object.name,
            }
            request.session.set_expiry(60 * 60 * 24 * 7) #å†é‡æ–°è®¾ç½®session ä¿å­˜7å¤©
            return redirect('/login/manage/')
    else: #è¡¨å•éªŒè¯æœªé€šè¿‡
        return render(request,'login.html',{
                'form' : login_form,
            }) 

#ç”ŸæˆéªŒè¯ç 
def image_code(request):
    '''ç”ŸæˆéªŒè¯ç '''
    img,str = check_code()
    request.session['image_code'] = str
    request.session.set_expiry(60) #è®¾ç½®éªŒè¯ç session 60sè¿‡æ—¶
    stream = BytesIO()
    img.save(stream, 'png')
    return HttpResponse(stream.getvalue())
</code></pre>
<p>PS. UserInfoæ˜¯åœ¨model.pyæ–‡ä»¶ä¸­çš„ORMç±»ï¼Œå¯¹åº”ç€å‚¨å­˜ç™»å½•ç”¨æˆ·å¸å·å¯†ç çš„æ•°æ®åº“è¡¨ã€‚</p>

              </div>
              <div class="toc-container">
                <ul class="markdownIt-TOC">
<li>
<ul>
<li>
<ul>
<li><a href="#35%E6%97%B6%E9%97%B4%E9%80%89%E6%8B%A9%E6%8F%92%E4%BB%B6">35.æ—¶é—´é€‰æ‹©æ’ä»¶</a></li>
<li><a href="#36modelfield%E5%AE%9A%E4%B9%89%E6%88%90%E6%88%90%E8%A1%A8%E5%8D%95%E7%9A%84%E5%B1%9E%E6%80%A7%E6%A0%B7%E5%BC%8F">36.modelfieldå®šä¹‰æˆæˆè¡¨å•çš„å±æ€§æ ·å¼</a></li>
<li><a href="#37%E4%BF%AE%E6%94%B9dajngo%E7%9A%84modelform%E7%B1%BB%E7%9A%84input%E7%9A%84type%E7%B1%BB%E5%9E%8B%E4%B8%BAdatetime-local">37.ä¿®æ”¹dajngoçš„modelformç±»çš„<code>input</code>çš„<code>type</code>ç±»å‹ä¸º<code>datetime-local</code></a></li>
<li><a href="#38%E9%80%9A%E8%BF%87validationerror%E6%9D%A5%E4%B8%BA%E9%92%A9%E5%AD%90%E6%96%B9%E6%B3%95%E8%AE%BE%E7%BD%AE%E9%9D%9E%E6%B3%95%E8%BE%93%E5%85%A5%E6%8F%90%E7%A4%BA%E4%BF%A1%E6%81%AF">38.é€šè¿‡validationErroræ¥ä¸ºé’©å­æ–¹æ³•è®¾ç½®éæ³•è¾“å…¥æç¤ºä¿¡æ¯</a></li>
<li><a href="#39%E5%AF%86%E7%A0%81%E5%8A%A0%E5%AF%86-%E9%80%9A%E8%BF%87%E9%92%A9%E5%AD%90%E6%96%B9%E6%B3%95%E5%AE%9A%E4%B9%89">39.å¯†ç åŠ å¯† é€šè¿‡é’©å­æ–¹æ³•å®šä¹‰</a></li>
<li><a href="#40%E5%AF%B9%E4%BA%8Edjanfo%E7%9A%84orm%E5%A6%82%E6%9E%9C%E6%90%9C%E7%B4%A2%E4%B8%8D%E5%88%B0">40.å¯¹äºdjanfoçš„ORMï¼Œå¦‚æœæœç´¢ä¸åˆ°</a></li>
<li><a href="#41%E5%AF%B9%E4%BA%8E%E8%A1%A8%E5%8D%95%E9%AA%8C%E8%AF%81">41.å¯¹äºè¡¨å•éªŒè¯</a></li>
<li><a href="#42django%E6%8A%A5%E9%94%99">42.djangoæŠ¥é”™</a></li>
<li><a href="#43%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95">43.ç”¨æˆ·ç™»å½•</a></li>
<li><a href="#44django%E4%B8%AD%E9%97%B4%E4%BB%B6">44.djangoä¸­é—´ä»¶</a></li>
<li><a href="#45%E6%B3%A8%E9%94%80%E6%93%8D%E4%BD%9C-%E7%94%A8%E6%88%B7%E9%80%80%E5%87%BA%E7%99%BB%E5%BD%95">45.æ³¨é”€æ“ä½œ - ç”¨æˆ·é€€å‡ºç™»å½•</a></li>
<li><a href="#46%E9%80%9A%E8%BF%87session%E8%8E%B7%E5%8F%96%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95%E4%BF%A1%E6%81%AF%E6%98%BE%E7%A4%BA%E5%9C%A8%E5%AF%BC%E8%88%AA%E6%A0%8F">46.é€šè¿‡sessionè·å–ç”¨æˆ·ç™»å½•ä¿¡æ¯æ˜¾ç¤ºåœ¨å¯¼èˆªæ </a></li>
<li><a href="#47form%E5%92%8Cmodelform">47.formå’Œmodelform</a></li>
<li><a href="#48%E5%9B%BE%E7%89%87%E9%AA%8C%E8%AF%81%E7%A0%81">48.å›¾ç‰‡éªŒè¯ç </a></li>
<li><a href="#49%E5%A6%82%E4%BD%95%E9%AA%8C%E8%AF%81%E9%AA%8C%E8%AF%81%E7%A0%81%E5%91%A2">49.å¦‚ä½•éªŒè¯éªŒè¯ç å‘¢ï¼Ÿ</a></li>
</ul>
</li>
</ul>
</li>
</ul>

              </div>
            </div>
          </article>
        </div>

        
          <div class="next-post">
            <div class="next">ä¸‹ä¸€ç¯‡</div>
            <a href="https://cyanineeee.github.io/post/mysql-null-he-kong-de-qu-bie/">
              <h3 class="post-title">
                mysql -- nullå’Œç©ºçš„åŒºåˆ«
              </h3>
            </a>
          </div>
        

        

        <div class="site-footer">
  Powered by <a href="https://github.com/getgridea/gridea" target="_blank">Gridea</a>
  <a class="rss" href="https://cyanineeee.github.io/atom.xml" target="_blank">
    <i class="ri-rss-line"></i> RSS
  </a>
</div>

      </div>
    </div>

    <script>
      hljs.initHighlightingOnLoad()

      let mainNavLinks = document.querySelectorAll(".markdownIt-TOC a");

      // This should probably be throttled.
      // Especially because it triggers during smooth scrolling.
      // https://lodash.com/docs/4.17.10#throttle
      // You could do like...
      // window.addEventListener("scroll", () => {
      //    _.throttle(doThatStuff, 100);
      // });
      // Only not doing it here to keep this Pen dependency-free.

      window.addEventListener("scroll", event => {
        let fromTop = window.scrollY;

        mainNavLinks.forEach((link, index) => {
          let section = document.getElementById(decodeURI(link.hash).substring(1));
          let nextSection = null
          if (mainNavLinks[index + 1]) {
            nextSection = document.getElementById(decodeURI(mainNavLinks[index + 1].hash).substring(1));
          }
          if (section.offsetTop <= fromTop) {
            if (nextSection) {
              if (nextSection.offsetTop > fromTop) {
                link.classList.add("current");
              } else {
                link.classList.remove("current");    
              }
            } else {
              link.classList.add("current");
            }
          } else {
            link.classList.remove("current");
          }
        });
      });

    </script>
  </body>
</html>
