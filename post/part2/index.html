<html>
  <head>
    <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>pythonç½‘ç»œç¼–ç¨‹ -- å»ºç«‹ä¸€ä¸ªhttpæœåŠ¡å™¨+twistedæ¨¡å—--part.2 | cyanine</title>
<link rel="shortcut icon" href="https://cyanineeee.github.io/favicon.ico?v=1727687297417">
<link href="https://cdn.jsdelivr.net/npm/remixicon@2.3.0/fonts/remixicon.css" rel="stylesheet">
<link rel="stylesheet" href="https://cyanineeee.github.io/styles/main.css">
<link rel="alternate" type="application/atom+xml" title="pythonç½‘ç»œç¼–ç¨‹ -- å»ºç«‹ä¸€ä¸ªhttpæœåŠ¡å™¨+twistedæ¨¡å—--part.2 | cyanine - Atom Feed" href="https://cyanineeee.github.io/atom.xml">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Droid+Serif:400,700">



    <meta name="description" content="=&gt;
HTTPåŸºç¡€å“åº”

httpæœåŠ¡å™¨

# 1.é¦–å…ˆéœ€è¦socketè¿›è¡Œåè®®ã€ç«¯å£è®¾ç½®
# 2. ç„¶åå› ä¸ºæ€§èƒ½åŸå›  éœ€è¦è®¾ç½®å¤šè¿›ç¨‹å“åº”å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚
# 3. è®¾ç½®å¤„ç†å®¢æˆ·ç«¯å‘é€ä¿¡æ¯
# 4. è¿”å›å“åº”çš„htmlä»¥åŠhttpå¤´ä¿¡æ¯..." />
    <meta name="keywords" content="" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">
    <script src="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.5.1/build/highlight.min.js"></script>
  </head>
  <body>
    <div class="main">
      <div class="main-content">
        <div class="site-header">
  <a href="https://cyanineeee.github.io">
  <img class="avatar" src="https://cyanineeee.github.io/images/avatar.png?v=1727687297417" alt="">
  </a>
  <h1 class="site-title">
    cyanine
  </h1>
  <p class="site-description">
    my personal blog
  </p>
  <div class="menu-container">
    
      
        <a href="/" class="menu">
          Home Page
        </a>
      
    
      
        <a href="/archives" class="menu">
          Archive
        </a>
      
    
      
        <a href="/tags" class="menu">
          Tags
        </a>
      
    
      
        <a href="/post/about" class="menu">
          About
        </a>
      
    
  </div>
  <div class="social-container">
    
      
    
      
    
      
    
      
    
      
    
  </div>
</div>

        <div class="post-detail">
          <article class="post">
            <h2 class="post-title">
              pythonç½‘ç»œç¼–ç¨‹ -- å»ºç«‹ä¸€ä¸ªhttpæœåŠ¡å™¨+twistedæ¨¡å—--part.2
            </h2>
            <div class="post-info">
              <span>
                2023-06-26
              </span>
              <span>
                18 min read
              </span>
              
            </div>
            
            <div class="post-content-wrapper">
              <div class="post-content" v-pre>
                <h1 id="">=&gt;</h1>
<p>HTTPåŸºç¡€å“åº”</p>
<ol>
<li>httpæœåŠ¡å™¨</li>
</ol>
<pre><code class="language-python"># 1.é¦–å…ˆéœ€è¦socketè¿›è¡Œåè®®ã€ç«¯å£è®¾ç½®
# 2. ç„¶åå› ä¸ºæ€§èƒ½åŸå›  éœ€è¦è®¾ç½®å¤šè¿›ç¨‹å“åº”å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚
# 3. è®¾ç½®å¤„ç†å®¢æˆ·ç«¯å‘é€ä¿¡æ¯
# 4. è¿”å›å“åº”çš„htmlä»¥åŠhttpå¤´ä¿¡æ¯
import socket
import multiprocessing
class HttpServer:
    def __init__(self,port):  #è¿›è¡Œsocketåˆå§‹è®¾ç½® ç»‘å®šç«¯å£å¼€å¯ç›‘å¬
        self.port = port
        self.server_socket = socket.socket(socket.AF_INET,socket.SOCK_STREAM) #å®ä¾‹socketå¯¹è±¡
        self.server_socket.setsockopt(socket.SOL_SOCKET,socket.SO_REUSEADDR,1) #è¿›è¡Œsocketé€‰é¡¹è®¾ç½®
        self.server_socket.bind(('0.0.0.0',port)) #ç»‘å®šç›‘å¬ç«¯å£
        self.server_socket.listen() #å¼€å¯ç›‘å¬ åœ¨æ„é€ å‡½æ•°å†…å¼€å¯ç›‘å¬ä»£è¡¨æ¯ä¸€ä¸ªå®ä¾‹éƒ½æ˜¯ä¸€ä¸ªhttpæœåŠ¡å™¨ç¨‹åº

    def start(self): #æ¥æ”¶æœåŠ¡ç«¯ä¿¡æ¯ è¿›è¡Œå¤„ç†
        while True:
            client_scoket, client_addr = self.server_socket.accept()
            print(f'ã€æ–°çš„å®¢æˆ·ç«¯è¿æ¥ã€‘å®¢æˆ·ç«¯ip{client_addr[0]},è®¿é—®ç«¯å£{client_addr[1]}')
            handle_socket = multiprocessing.Process(target=self.handle_response,args=(client_scoket,))#å¯åŠ¨ä¸€ä¸ªè¿›ç¨‹å¤„ç†è¿™ä¸ªå®¢æˆ·ç«¯è¯·æ±‚
            handle_socket.start()

    def handle_response(self,client_socket): #å¤„ç†å®¢æˆ·ç«¯å‘é€çš„è¯·æ±‚ä¿¡æ¯
        request_headers = client_socket.recv(1024)
        print(f'ã€å®¢æˆ·ç«¯æ¸…è¯·æ±‚å¤´ä¿¡æ¯ã€‘{request_headers}') #å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚å¤´ä¿¡æ¯

        #å¼€å§‹å¤„ç†å“åº”ç»™å®¢æˆ·ç«¯çš„ä¿¡æ¯
        response_start_line = 'HTTP/1.1 200 OK\r\n' #æœ¬æ¬¡ç›¸åº”æˆåŠŸ
        #æ‰‹åŠ¨å†™httpå“åº”å¤´ ä¹‹åä¼šå‘é€ç»™å®¢æˆ·ç«¯ä¼šè¢«æµè§ˆå™¨è§£æ
        response_header = 'Server:Cyanine Hrrp Server\r\nContent-Type:text/html\r\n'
        #è¿”å›çš„htmlä»£ç  ä¹Ÿå°±æ˜¯é¡µé¢ä¸»é¢˜ æœ€åŸºæœ¬çš„å¼€å‘å°±æ˜¯éœ€è¦åœ¨ä»£ç ä¸­ç¡¬åµŒå…¥htmlé¡µé¢ä»£ç 
        response_body = &quot;&lt;html&gt;&quot;\
                            &quot;&lt;head&gt;&quot;\
                                &quot;&lt;meta charset=utf-8&gt;&quot;\
                                &quot;&lt;title&gt;Cyanine Http Server Response&lt;/title&gt;&quot;\
                            &quot;&lt;/head&gt;&quot;\
                            &quot;&lt;body&gt;&quot;\
                                &quot;&lt;h1&gt;&quot;\
                                &quot;Cyanine's Http server response...&quot;\
                                &quot;&lt;/h1&gt;&quot;\
                            &quot;&lt;/body&gt;&quot;\
                        &quot;&lt;/html&gt;&quot;
        #è¦æ³¨æ„åœ¨å“åº”å¤´å’Œå“åº”bodyä¹‹é—´æ·»åŠ æ¢è¡Œ å¦åˆ™æµè§ˆå™¨ä¸èƒ½è§£æå‡ºå“åº”å†…å®¹
        response = response_start_line + response_header + '\r\n'+response_body
        client_socket.send(bytes(response,'UTF-8')) #æœåŠ¡å™¨å“åº”
        client_socket.close() #httpsæ˜¯æ— çŠ¶æ€åè®® å› æ­¤ç›¸åº”å®Œæˆä¸€æ¬¡ä¹‹åå°±ä¼šå…³é—­è¿æ¥

def main():
    #80ç«¯å£å¤§éƒ¨åˆ†æœåŠ¡çš„é»˜è®¤ç«¯å£ å› æ­¤å¦‚æœä½¿ç”¨çš„è¯ å°±å¯ä»¥ç›´æ¥å±äºåŸŸå/ä¸»æœºåœ°å€è®¿é—®æœåŠ¡
    #å¦‚æœä¸æ˜¯çš„è¯ éœ€è¦æŒ‡å®šç«¯å£ :**
    http_server = HttpServer(9090)
    http_server.start()
if __name__ == '__main__':
    main()
</code></pre>
<p>ä¸€äº›ä»£ç æ›´è¯¦ç»†çš„è®²è§£<br>
<code>self.server_socket = socket.socket(socket.AF_INET,socket.SOCK_STREAM) #å®ä¾‹socketå¯¹è±¡</code><br>
ocket(family,type[,protocol])å‡½æ•°ä¸­ï¼Œfamily æŒ‡å®šåº”ç”¨ç¨‹åºä½¿ç”¨çš„é€šä¿¡åè®®çš„åè®®æ—ï¼Œå¯¹äºTCP/IPåè®®æ—ï¼Œè¯¥å‚æ•°ä¸ºAF_INETï¼›type æ˜¯è¦åˆ›å»ºå¥—æ¥å­—çš„ç±»å‹ï¼Œsocket.SOCK_STREAMè¡¨ç¤ºæµå¼socketï¼Œä½¿ç”¨TCPåè®®çš„æ—¶å€™é€‰æ‹©æ­¤å‚æ•°ï¼ŒSOCK_DGRAMæ•°æ®æŠ¥å¼socketï¼Œä½¿ç”¨UDPåè®®çš„æ—¶å€™é€‰æ‹©æ­¤å‚æ•°ï¼›protocol æŒ‡æ˜æ‰€è¦æ¥æ”¶çš„åè®®ç±»å‹ï¼Œé€šå¸¸ä¸º0æˆ–è€…ä¸å¡«ã€‚<br>
<code>self.server_socket.setsockopt(socket.SOL_SOCKET,socket.SO_REUSEADDR,1) #è¿›è¡Œsocketé€‰é¡¹è®¾ç½®  level: è®¾ç½®é€‰é¡¹æ‰€åœ¨çš„åè®®å±‚ç¼–å·ï¼Œæœ‰å››ä¸ªå¯ç”¨é…ç½®é¡¹ï¼Œå…¶ä¸­socket.SOL_SOCKETè¡¨ç¤ºåŸºæœ¬åµŒå¥—å­—æ¥å£....å‰©ä¸‹çš„å¥½å¤æ‚ï¼Œçœ‹ä¸å¤ªæ‡‚ï¼Œæš‚ä¸”æ”¾ä¸‹ã€‚çœ‹åˆ°çš„[å‚è€ƒ](https://blog.csdn.net/c_base_jin/article/details/94353956) </code>client_socket.send(bytes(response,'UTF-8')) #æœåŠ¡å™¨å“åº”<br>
ä½¿ç”¨<code>bytes</code>çš„åŸå› æ˜¯socketåªèƒ½å‘é€å­—èŠ‚æ•°æ®æµï¼Œå› æ­¤éœ€è¦å°†responseè½¬æ¢ä¸ºbytesç±»å‹ï¼Œå†å‘é€ã€‚</p>
<h1 id="-2">=&gt;</h1>
<p>httpæœåŠ¡å™¨å»ºç«‹ç›¸åº”ç›®å½•<br>
ä¹‹å‰çš„httpæœåŠ¡åªèƒ½è¿›è¡Œä¸€æ¬¡å›ºå®šçš„å“åº”ï¼Œå¹¶ä¸”htmlä»£ç å‡ºç°åœ¨pythonä»£ç ä¸­ä¸æ–¹ä¾¿ä¿®æ”¹ï¼Œæ²¡æœ‰è¿›è¡Œå‰åç«¯åˆ†ç¦»ï¼Œè¾ƒä¸ºè½åã€‚å› æ­¤æˆ‘ä»¬å¯ä»¥å»ºç«‹ä¸€ä¸ªç›®å½•ï¼Œç›®å½•ä¸‹æœ‰ä¸åŒçš„HTMLé¡µé¢ï¼Œæ ¹æ®è¯·æ±‚çš„ä¸åŒï¼Œç›¸åº”å“åº”ç›®å½•ä¸‹å¯¹åº”çš„htmlæ–‡ä»¶ã€‚<br>
å…·ä½“å®ç°ï¼š</p>
<pre><code class="language-python"># æ·»åŠ ç›¸åº”ç›®å½• åŸå› åœ¨äºä»£ç ç»´æŠ¤ä»¥åŠæ›´åŠ é«˜æ•ˆçš„å“åº”
# éœ€è¦æ³¨æ„ è¯»å–htmlæˆ–è€…å…¶ä»–æ–‡ä»¶éƒ½æ˜¯ä»¥bytesçš„æ ¼å¼
# osçš„æ³¨æ„ç‚¹ os.getcwd() os.sep os.path.normpath()
# æ­£åˆ™çš„å†™æ³• æš‚ä¸åšè¯¦ç»†äº†è§£ 

import socket
import os #oså¤„ç†å“åº”æ–‡ä»¶ç›®å½•
import re #æ­£åˆ™åŒ¹é…è¯·æ±‚ä¸­çš„æ–‡ä»¶åœ°å€
import multiprocessing
HTML_ROOT_DIR = os.getcwd() + os.sep + &quot;template&quot;

class HttpServer:
    def __init__(self,port):  #è¿›è¡Œsocketåˆå§‹è®¾ç½® ç»‘å®šç«¯å£å¼€å¯ç›‘å¬
        self.port = port
        self.server_socket = socket.socket(socket.AF_INET,socket.SOCK_STREAM) #å®ä¾‹socketå¯¹è±¡
        self.server_socket.setsockopt(socket.SOL_SOCKET,socket.SO_REUSEADDR,1) #è¿›è¡Œsocketé€‰é¡¹è®¾ç½®
        self.server_socket.bind(('0.0.0.0',port)) #ç»‘å®šç›‘å¬ç«¯å£
        self.server_socket.listen() #å¼€å¯ç›‘å¬ åœ¨æ„é€ å‡½æ•°å†…å¼€å¯ç›‘å¬ä»£è¡¨æ¯ä¸€ä¸ªå®ä¾‹éƒ½æ˜¯ä¸€ä¸ªhttpæœåŠ¡å™¨ç¨‹åº

    def start(self): #æ¥æ”¶æœåŠ¡ç«¯ä¿¡æ¯ è¿›è¡Œå¤„ç†
        while True:
            client_scoket, client_addr = self.server_socket.accept()
            print(f'ã€æ–°çš„å®¢æˆ·ç«¯è¿æ¥ã€‘å®¢æˆ·ç«¯ip{client_addr[0]},è®¿é—®ç«¯å£{client_addr[1]}')
            handle_socket = multiprocessing.Process(target=self.handle_response,args=(client_scoket,))#å¯åŠ¨ä¸€ä¸ªè¿›ç¨‹å¤„ç†è¿™ä¸ªå®¢æˆ·ç«¯è¯·æ±‚
            handle_socket.start()
    
    #è¯»å–å¯¹åº”æ–‡ä»¶æ•°æ®
    def read_file(self,file_name):
        file_path = os.path.normpath(HTML_ROOT_DIR + file_name)
        print('ã€è¯·æ±‚æ–‡ä»¶è·¯å¾„ã€‘'+ file_path)
        f = open(file_path,'rb') #äºŒè¿›åˆ¶è¯»å–
        file_data = f.read()
        f.close()
        print('ã€è¯·æ±‚æ–‡ä»¶è·¯å¾„ã€‘è¯¥æ–‡ä»¶è¯·æ±‚ç»“æŸï¼')
        return file_data

    #è·å–äºŒè¿›åˆ¶æ–‡ä»¶
    def get_binary_data(self,file_name):
        response_body = self.read_file(file_name)
        return response_body

    #è¯»å–htmlæ–‡ä»¶ è¿”å›ç›¸åº”çš„ä¿¡æ¯
    def get_html_file(self,file_name):
        response_start_line = 'HTTP/1.1 200 OK\r\n' #æœ¬æ¬¡ç›¸åº”æˆåŠŸ
        #æ‰‹åŠ¨å†™httpå“åº”å¤´ ä¹‹åä¼šå‘é€ç»™å®¢æˆ·ç«¯ä¼šè¢«æµè§ˆå™¨è§£æ
        response_header = 'Server:Cyanine Hrrp Server\r\nContent-Type:text/html\r\n'
        response_body = self.read_file(file_name)
        return response_start_line + response_header + '\r\n' + response_body.decode('utf-8')
    def handle_response(self,client_socket): #å¤„ç†å®¢æˆ·ç«¯å‘é€çš„è¯·æ±‚ä¿¡æ¯
        request_headers = client_socket.recv(1024)
        print(f'ã€å®¢æˆ·ç«¯æ¸…è¯·æ±‚å¤´ä¿¡æ¯ã€‘{request_headers}') #å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚å¤´ä¿¡æ¯
        file_name = re.match(r&quot;\w+ +(/[^ ]*)&quot;, request_headers.decode('utf-8').split('\r\n')[0]).group(1)
        if file_name == &quot;/&quot;: #å¦‚æœè¯·æ±‚çš„æ˜¯æ ¹ç›®å½• é‚£ä¹ˆå®é™…è®¿é—®çš„æ˜¯index.htmlé¡µé¢
            file_name = '/index.html'
        if file_name.endswith(&quot;.html&quot;) or file_name.endswith(&quot;.htm&quot;):
            client_socket.send(bytes(self.get_html_file(file_name),'utf-8'))
        else:
            response_start_line = 'HTTP/1.1 200 OK\r\n' #æœ¬æ¬¡å“åº”æˆåŠŸ
            response_header ='Server:Cyanine Hrrp Server\r\nContent-Type:image/x-icon\r\n'
            client_socket.send((response_start_line + response_header + '\r\n').encode('utf-8'))
            client_socket.send(self.get_binary_data(file_name))
        client_socket.close() #httpsæ˜¯æ— çŠ¶æ€åè®® å› æ­¤ç›¸åº”å®Œæˆä¸€æ¬¡ä¹‹åå°±ä¼šå…³é—­è¿æ¥

def main():
    #80ç«¯å£å¤§éƒ¨åˆ†æœåŠ¡çš„é»˜è®¤ç«¯å£ å› æ­¤å¦‚æœä½¿ç”¨çš„è¯ å°±å¯ä»¥ç›´æ¥å±äºåŸŸå/ä¸»æœºåœ°å€è®¿é—®æœåŠ¡
    #å¦‚æœä¸æ˜¯çš„è¯ éœ€è¦æŒ‡å®šç«¯å£ :**
    http_server = HttpServer(70)
    http_server.start()
    
if __name__ == '__main__':
    main()
</code></pre>
<p>ä»£ç ç»†èŠ‚è§£æ<br>
ä¸€è¿™æ˜¯ä¸€ä¸ªç®€å•çš„httpæœåŠ¡å™¨ç›¸åº”ç›®å½•ï¼Œåªæ˜¯ç®€å•å¤„ç†index.htmlã€hello.htmlä»¥åŠfavicon.icoæ–‡ä»¶ï¼›äºŒä¸ºäº†ç»“æ„æ¸…æ™°ï¼Œå°½ç®¡è·å–<code>get_binary_data()</code>æ–¹æ³•åªæ˜¯ç»™<code>read_file</code>æ¢äº†ä¸ªåå­—ï¼Œä½†æ˜¯èƒ½å¤Ÿå°†åŠŸèƒ½æ›´åŠ æ¸…æ™°çš„åˆ†å‰²å¼€æ¥ï¼›ä¸‰ä¸ç®¡ä»€ä¹ˆå“åº”ï¼Œéƒ½è¦è®°å¾—æ·»åŠ å¯¹åº”çš„httpå“åº”å¤´ï¼›å››å“åº”å¤´å’Œå“åº”å†…å®¹å’Œåˆ†å¼€å‘é€ï¼›äº”è¦æ³¨æ„æ‰‹å†™å“åº”å¤´çš„æ—¶å€™å„ä¸ªéƒ¨åˆ†ä¹‹é—´çš„<code>\r\n</code>ï¼›<br>
åŒæ—¶è¿™é‡Œè¿˜é‡åˆ°äº†ä¸€ä¸ªéš¾ä»¥ç†è§£çš„é—®é¢˜ï¼Œå¦‚æœæ˜¯ä»¥80ç«¯å£å¯åŠ¨æœåŠ¡ï¼Œé‚£ä¹ˆå°±ç®—faviconçš„è¯·æ±‚æ²¡æœ‰å“åº”å¤´ï¼Œæµè§ˆå™¨ä¹Ÿä¼šæ­£ç¡®è§£æå‡ºæ¥å¹¶æ˜¾ç¤ºå›¾æ ‡ï¼Œä½†æ˜¯å¦‚æœæ¢æˆå…¶ä»–çš„ç«¯å£ï¼Œé‚£ä¹ˆå°±ä¸èƒ½æ­£å¸¸ç›¸åº”ï¼Œå¿…é¡»è¦æ·»åŠ å“åº”å¤´ã€‚çŒœæµ‹å¯èƒ½æ˜¯å› ä¸º80ç«¯å£æ˜¯é»˜è®¤ï¼Œè€Œè¯·æ±‚faviconä¹Ÿæ˜¯é»˜è®¤çš„ä¸€ä¸ªè¯·æ±‚ï¼Œå› æ­¤åœ¨è¿™ä¸ªæ´»åŠ¨ä¸­ï¼Œæµè§ˆå™¨ä¼šè‡ªåŠ¨è§£ææŠŠï¼Œä½†æ˜¯éé»˜è®¤ç«¯å£å°±ä¸å¯ä»¥ã€‚<a href="https://blog.csdn.net/laocooon/article/details/130762587#comments_27306408">å’Œä¸€ä½ç›¸åŒé—®é¢˜çš„å¤§ä½¬çš„è®¨è®ºä»¥åŠä»–çš„ä»£ç </a>ã€‚è¿™ä¸ªé—®é¢˜æ€ä¹ˆä¹Ÿæ‰¾ä¸åˆ°ç­”æ¡ˆï¼Œå› æ­¤æš‚ä¸”æç½®å§ğŸ˜­ã€‚æ€»æ˜¯è¿˜æ˜¯è¦è®°å¾—åœ¨æ¯ä¸€ä¸ªå“åº”å‰æ·»åŠ å“åº”å¤´ã€‚ä¸è¿‡å½“ç„¶é’ˆå¯¹ç®€å•çš„ï¼Œå¤æ‚çš„è¯æœ‰å¾ˆå¤šwebæ¡†æ¶ä¼šå¸®æˆ‘ä»¬æ»´~~~</p>
<h1 id="-3">=&gt;</h1>
<p>åŠ¨æ€è¯·æ±‚å¤„ç†<br>
webæœ‰ä¸¤ä¸ªå¤„ç†é˜¶æ®µï¼šé™æ€å¤„ç†é˜¶æ®µã€åŠ¨æ€å¤„ç†é˜¶æ®µã€‚<br>
ä¹‹å‰çš„å“åº”ç›®å½•å®é™…ä¸Šæ˜¯é™æ€å¤„ç†ï¼Œè€ŒåŠ¨æ€webæ˜¯å¯ä»¥æ ¹æ®åŠ¨æ€çš„åˆ¤æ–­å†³å®šæœ€ç»ˆè¿”å›çš„æ•°æ®å†…å®¹ã€‚<br>
pythonåŠ¨æ€å¤„ç†å®ç°ï¼š(åªæ˜¯ç®€å•çš„åŸç†äº†è§£ï¼Œä¸æ¶‰åŠå¤æ‚çš„åŠ¨æ€ç›¸åº”æ¡†æ¶)</p>
<pre><code class="language-python"># å¤„ç†åŠ¨æ€è¯·æ±‚ 
import socket
import os #oså¤„ç†å“åº”æ–‡ä»¶ç›®å½•
import re #æ­£åˆ™åŒ¹é…è¯·æ±‚ä¸­çš„æ–‡ä»¶åœ°å€
import multiprocessing
HTML_ROOT_DIR = os.getcwd() + os.sep + &quot;template&quot;
import sys 
sys.path.append('packages')

class HttpServer:
    def __init__(self,port):  #è¿›è¡Œsocketåˆå§‹è®¾ç½® ç»‘å®šç«¯å£å¼€å¯ç›‘å¬
        self.port = port
        self.server_socket = socket.socket(socket.AF_INET,socket.SOCK_STREAM) #å®ä¾‹socketå¯¹è±¡
        self.server_socket.setsockopt(socket.SOL_SOCKET,socket.SO_REUSEADDR,1) #è¿›è¡Œsocketé€‰é¡¹è®¾ç½®
        self.server_socket.bind(('0.0.0.0',port)) #ç»‘å®šç›‘å¬ç«¯å£
        self.server_socket.listen() #å¼€å¯ç›‘å¬ åœ¨æ„é€ å‡½æ•°å†…å¼€å¯ç›‘å¬ä»£è¡¨æ¯ä¸€ä¸ªå®ä¾‹éƒ½æ˜¯ä¸€ä¸ªhttpæœåŠ¡å™¨ç¨‹åº

    def start(self): #æ¥æ”¶æœåŠ¡ç«¯ä¿¡æ¯ è¿›è¡Œå¤„ç†
        while True:
            client_scoket, client_addr = self.server_socket.accept()
            print(f'ã€æ–°çš„å®¢æˆ·ç«¯è¿æ¥ã€‘å®¢æˆ·ç«¯ip{client_addr[0]},è®¿é—®ç«¯å£{client_addr[1]}')
            handle_socket = multiprocessing.Process(target=self.handle_response,args=(client_scoket,))#å¯åŠ¨ä¸€ä¸ªè¿›ç¨‹å¤„ç†è¿™ä¸ªå®¢æˆ·ç«¯è¯·æ±‚
            handle_socket.start()

    def handle_response(self,client_socket): #å¤„ç†å®¢æˆ·ç«¯å‘é€çš„è¯·æ±‚ä¿¡æ¯
        request_headers = client_socket.recv(1024)
        print(f'ã€å®¢æˆ·ç«¯æ¸…è¯·æ±‚å¤´ä¿¡æ¯ã€‘{request_headers}') #å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚å¤´ä¿¡æ¯
        file_name = re.match(r&quot;\w+ +(/[^ ]*)&quot;, request_headers.decode('utf-8').split('\r\n')[0]).group(1)
        if file_name.startswith('/packages'): #è®¿é—®åŠ¨æ€é¡µé¢
            #è·å–åŠ¨æ€å‚æ•° 
            request_name = file_name[file_name.index('/',1)+1:]#è®¿é—®è·¯å¾„
            # print(&quot;è®¿é—®è·¯å¾„ï¼š&quot;+request_name)
            param_value = '' #è¯·æ±‚å‚æ•°
            if request_name.__contains__('?') :#ï¼Ÿæ˜¯urlä¸­çš„å‚æ•°åˆ†éš”ç¬¦å·
                request_value = request_name[request_name.index('?') + 1 :]
                param_value = request_value.split('=')[1]
                request_name = request_name[0:request_name.index('?')]
                # print(request_name)
            model_name = request_name.split('/')[0]
            method_name = request_name.split('/')[1]
            model = __import__(model_name)
            method = getattr(model,method_name)
            response_body = method(param_value)
            print('ã€å“åº”æ•°æ®æ˜¯ã€‘ï¼š'+response_body)

            response_start_line = 'HTTP/1.1 200 OK\r\n' 
            #æ‰‹åŠ¨å†™httpå“åº”å¤´ ä¹‹åä¼šå‘é€ç»™å®¢æˆ·ç«¯ä¼šè¢«æµè§ˆå™¨è§£æ
            response_header = 'Server:Cyanine Hrrp Server\r\nContent-Type:text/html\r\n'
            response = response_start_line+response_header+'\r\n'+response_body
            print(response)
            client_socket.send(bytes(response,'UTF-8'))
        client_socket.close()


def main():
    #80ç«¯å£å¤§éƒ¨åˆ†æœåŠ¡çš„é»˜è®¤ç«¯å£ å› æ­¤å¦‚æœä½¿ç”¨çš„è¯ å°±å¯ä»¥ç›´æ¥å±äºåŸŸå/ä¸»æœºåœ°å€è®¿é—®æœåŠ¡
    #å¦‚æœä¸æ˜¯çš„è¯ éœ€è¦æŒ‡å®šç«¯å£ :**
    http_server = HttpServer(80)
    http_server.start()
    
if __name__ == '__main__':
    #http://localhost/packages/echo/service?param=canshu
    main()
</code></pre>
<p>åŒæ—¶è¿˜éœ€è¦ä¸€ä¸ªåœ¨åŒç›®å½•ä¸‹çš„packagesæ–‡ä»¶å¤¹ï¼Œæ–‡ä»¶è·¯å¾„å¦‚ä¸‹</p>
<pre><code>â”œâ”€packages
â”‚  â”‚  echo.py
â”‚  â”‚  __init__.py
â”‚  â”‚  
â”‚  â””â”€__pycache__
â”‚          echo.cpython-310.pyc
â”‚          echo.cpython-311.pyc
â”‚          
â”œâ”€template
â”‚      favicon.ico
â”‚      hello.html
â”‚      index.html
â”‚        
â”œâ”€ç½‘ç»œç¼–ç¨‹
â”‚      01-server.py
â”‚      02-client.py
â”‚      03-echo-server.py
â”‚      04-echo-client.py
â”‚      05-UDP-server.py
â”‚      06-UDP-client.py
â”‚      07-broadcast-client.py
â”‚      08-broadcast-server.py
â”‚      09-http-server.py
â”‚      10-http-lib-server.py
â”‚      11-dynamic-request.py #è¿™ä¸ªæ˜¯æœ¬æ–‡ä»¶
</code></pre>
<p>å…¶ä¸­çš„/packages/echo.pyæ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š</p>
<pre><code class="language-python">def service(text):
    if text:
        response = f'&lt;head&gt;&lt;title&gt;Cyanine\'s Http Server&lt;/title&gt;&lt;meta charset=&quot;utf-8&quot;&gt;&lt;/head&gt;&lt;body&gt;&lt;h1&gt;å‚æ•°ä¿¡æ¯ï¼š{text}&lt;/h1&gt;&lt;/body&gt;'
        return response
    else:
        return '&lt;h1&gt;æ²¡æœ‰å‚æ•°ä¿¡æ¯&lt;/h1&gt;'
</code></pre>
<p>éœ€è¦æ³¨æ„çš„ï¼š<br>
ä¸€åœ¨<code>packages</code>æ–‡ä»¶å¤¹ä¸‹ä¸€å®šè¦æœ‰<code>__init.py__</code>æ–‡ä»¶ï¼Œè¿™æ ·æ‰èƒ½åœ¨<code>__import__</code>çš„æ—¶å€™æ­£ç¡®è¯†åˆ«åˆ°æ¨¡å—ï¼ŒåŒæ—¶ä¹Ÿéœ€è¦æå‰è®¾å®šé»˜è®¤çš„æ¨¡å—è·¯å¾„ï¼ˆ<code>sys.path.append(path/to/module)</code>ï¼‰ï¼›äºŒå“åº”çš„æ—¶å€™é™¤äº†éœ€è¦ç¡®å®šå“åº”å¤´ï¼Œåœ¨å“åº”çš„htmlä»£ç ä¸­éœ€è¦è§„å®šç¼–ç æ–¹å¼ï¼Œå¦åˆ™ä¼šå‡ºç°ä¹±ç ï¼ˆ<code>&lt;meta charset=utf-8&gt;</code>)ï¼›ä¸‰åŠ¨æ€å¤„ç†æˆ‘åˆšå¬èµ·æ¥é«˜å¤§ä¸Šï¼Œä½†å®é™…ä¸Šæ“ä½œä¸€éï¼Œæ„Ÿå—å°±æ˜¯å¯¹urlçš„è§£æï¼ŒåŠ ä¸Šä¸€äº›ç¨‹åºå¤„ç†å‚æ•°ï¼Œå°±æ˜¯åŠ¨æ€å¤„ç†ï¼›å››åŠ¨æ€å¤„ç†urléœ€è¦ç”¨åˆ°å¾ˆå¤šå¯¹å­—ç¬¦ä¸²çš„æ“ä½œã€‚<br>
PS. å¦å¤–ä¸€ä¸ªæ–¹ä¾¿çš„å°tipsï¼Œåœ¨å†™é¡¹ç›®ç»“æ„çš„æ—¶å€™ï¼Œå‘½ä»¤è¡Œé‡Œä½¿ç”¨<code>tree</code>ä¼šç”Ÿæˆç›®å½•ç»“æ„ï¼Œ<code>tree &gt; txtname.txt</code>ä¼šå°†ç›®å½•è¾“å‡ºåˆ°è¿™ä¸ªtxtæ–‡ä»¶ä¸­ï¼Œå‚æ•°<code>/f</code>ä¼šæ˜¾ç¤ºæ‰€æœ‰çš„æ–‡ä»¶å±‚çº§ï¼Œä¸åŠ å‚æ•°åªä¼šæ˜¾ç¤ºåˆ°æ‰€æœ‰çš„ç›®å½•å±‚çº§ã€‚</p>
<h1 id="-4">=&gt;</h1>
<p>urllib3æ¨¡å—<br>
ç”¨è¿™ä¸ªæ¨¡å—å¯ä»¥å®ç°æµè§ˆå™¨çš„æ¨¡æ‹Ÿè®¿é—®ï¼Œæ˜¯urllibçš„å‡çº§ç‰ˆï¼Œä¸¤è€…åŠŸèƒ½ç±»ä¼¼ï¼Œåªæœ‰ç»†å¾®å·®åˆ«ã€‚</p>
<h1 id="-5">=&gt;</h1>
<p>Twistedæ¨¡å— (ç±»ä¼¼javaä¸­nio)<br>
æ˜¯pythonä¸­ä¸“é—¨å®ç°å¼‚æ­¥å¤„ç†çš„ioæ¦‚å¿µï¼Œä¸»è¦æ˜¯æå‡æœåŠ¡ç«¯çš„æ•°æ®å¤„ç†èƒ½åŠ›ã€‚ç†è§£twistedçš„è®¾è®¡æ€æƒ³ï¼Œé‚£ä¹ˆéœ€è¦å¯¹æ¯”ä¼ ç»Ÿçš„æœåŠ¡å™¨ç¨‹åºå¼€å‘ã€‚æ—©æœŸæ²¡æœ‰å¤šæ ¸CPUæ¦‚å¿µï¼Œå•çº¿ç¨‹å¤„ç†çš„æ•ˆç‡ä½ä¸‹ï¼Œå¤šçº¿ç¨‹å¹¶å‘ç¼–ç¨‹æœ‰å¯èƒ½äº§ç”Ÿæ­»é”é—®é¢˜ï¼ˆä¸åŒè¿›ç¨‹ä»¥åŠçº¿ç¨‹ä¹‹é—´çš„ç­‰å¾…å’Œå”¤é†’æœºåˆ¶ï¼‰ï¼ˆå› ä¸ºéƒ½æ˜¯ä¸€ä¸ªä¸€ä¸ªè¿›ç¨‹å»æ‰§è¡Œï¼‰ã€‚æ‰€ä»¥åæ¥ï¼Œå¦‚æœä¸ä½¿ç”¨å¹¶å‘ç¼–ç¨‹ï¼Œå°±ä¸ä¼šäº§ç”Ÿç§ç§é—®é¢˜ï¼ˆèµ„æºåˆ‡æ¢ã€ç³»ç»Ÿè°ƒåº¦ã€åŒæ­¥ä¸ç­‰å¾…ç­‰ï¼‰ï¼Œ</p>
<blockquote>
<p>é˜»å¡è®¾è®¡<br>
æœåŠ¡ç«¯ä¸å®¢æˆ·ç«¯çš„recv<br>
ä¼šæµªè´¹å¤§é‡æœåŠ¡å™¨èµ„æº -&gt; è¿™å°±æ˜¯é˜»å¡IO</p>
</blockquote>
<p>å¤šçº¿ç¨‹æ˜¯ä¸èƒ½è§£å†³é˜»å¡IOçš„ï¼Œå› æ­¤æœ€å¥½çš„æ–¹æ³•æ˜¯éé˜»å¡IOï¼ˆåˆ†ä¸ºåŒæ­¥éé˜»å¡IOå’Œå¼‚æ­¥éé˜»å¡IOï¼‰ï¼Œå› æ­¤å®ç°ä¸‹æ¥å°±æ˜¯åœ¨ä¸€ä¸ªè¿›ç¨‹ä¸­ä¸æ–­åœ°è¿›è¡Œå¾ªç¯å¤„ç†<br>
-&gt; twistedæ˜¯ä¸€ä¸ªäº‹ä»¶é©±åŠ¨å‹çš„ç½‘ç»œå¼•æ“ï¼Œæœ€å¤§çš„ç‰¹ç‚¹å°±æ˜¯æä¾›æœ‰ä¸€ä¸ªäº‹ä»¶å¾ªç¯å¤„ç†ï¼Œå½“å¤–éƒ¨äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œä½¿ç”¨å›è°ƒæœºåˆ¶æ¥è§¦å‘ç›¸åº”çš„æ“ä½œå¤„ç†ï¼Œå¤šä¸ªä»»åŠ¡åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­æ‰§è¡Œçš„æ—¶å€™ï¼Œè¿™ç§æ–¹å¼å¯ä»¥ä½¿ç¨‹åºå°½å¯èƒ½åœ°å‡å°‘å¯¹å…¶å®ƒçº¿ç¨‹çš„ä»¥æ¥ï¼Œä¹Ÿä½¿å¾—ç¨‹åºå¼€å‘äººå‘˜ä¸å†å…³æ³¨çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚<br>
-&gt; twistedä¸­çš„æ‰€æœ‰å¤„ç†äº‹ä»¶å…¨éƒ¨äº¤ç»™reactorè¿›è¡Œç»Ÿä¸€ç®¡ç†ã€‚<br>
-&gt; reactor è¿›è¡Œæ‰€æœ‰è¾“å‡ºè¾“å‡ºæœ‰å…³çš„äº‹ä»¶æ³¨å†Œã€‚åœ¨æ•´ä¸ªç¨‹åºçš„è¿è¡Œä¸­ï¼Œreactorå¾ªç¯ä¼šä»¥å•çº¿ç¨‹çš„å½¢å¼æŒç»­è¿è¡Œï¼Œå½“éœ€è¦æ‰§è¡Œå›è°ƒå¤„ç†çš„æ—¶å€™ä¼šåœæ­¢å¾ªç¯ï¼Œå½“å›è°ƒæ“ä½œæ‰§è¡Œå®Œæ¯•ä¹‹åå°†ç»§ç»­é‡‡ç”¨å¾ªç¯çš„å½¢å¼è¿›è¡Œå…¶ä»–ä»»åŠ¡å¤„ç†ã€‚</p>
<h1 id="-6">=&gt;</h1>
<p>ä½¿ç”¨twistedå¼€å‘TCPç¨‹åº<br>
ä¼šä½¿æœåŠ¡ç«¯çš„èµ„æºåˆ©ç”¨å¸¦æ¥æå¤§ä¾¿åˆ©ã€‚</p>
<ol>
<li>æœåŠ¡ç«¯ï¼š</li>
</ol>
<pre><code class="language-python">import twisted
import twisted.internet.protocol
import twisted.internet.reactor

SERVER_PORT = 8080

class Server(twisted.internet.protocol.Protocol): #ç»§æ‰¿çˆ¶ç±»
    def connectionMade(self): #å¤å†™æœåŠ¡ç«¯è¿æ¥æ–¹æ³•
        print(f'å®¢æˆ·ç«¯{self.transport.getPeer().host}è¿æ¥æˆåŠŸ...')
        return super().connectionMade() 
    def dataReceived(self, data: bytes): #å¤å†™æœåŠ¡ç«¯æ•°æ®æ¥æ”¶æ–¹æ³•
        print('ã€æœåŠ¡ç«¯æ”¶åˆ°æ•°æ®ã€‘' + data.decode('utf-8')) #å¤„ç†æ“ä½œ
        self.transport.write(('ã€ECHOã€‘' + data.decode('utf-8')).encode('UTF-8')) #è¿›è¡Œå›åº” ç±»æ¯”socketçš„send
        return super().dataReceived(data)

#æ³¨å†Œreactor
#reactoræ ¹æ®å·¥å‚è·å¾—ç›¸åº”äº‹ä»¶å›è°ƒå¤„ç†ç±»
class DefaultServerFactory(twisted.internet.protocol.Factory):
    protocol = Server

def main():
    #æœåŠ¡ç›‘å¬
    twisted.internet.reactor.listenTCP(SERVER_PORT,DefaultServerFactory())
    print('æœåŠ¡å™¨å¯åŠ¨å®Œæ¯•ï¼Œç­‰å¾…å®¢æˆ·ç«¯è¿æ¥...')
    twisted.internet.reactor.run()

if __name__ == '__main__':
    main()
</code></pre>
<ol start="2">
<li>å®¢æˆ·ç«¯</li>
</ol>
<pre><code class="language-python">import twisted
import twisted.internet.protocol
import twisted.internet.reactor

SERVER_PORT = 8080
SERVER_HOST = 'localhost'

class Client(twisted.internet.protocol.Protocol):
    def connectionMade(self):
        print('æœåŠ¡å™¨è¿æ¥æˆåŠŸ...')
        self.send() #å»ºç«‹è¿æ¥ä¹‹åå°±å‘é€æ•°æ®
        return super().connectionMade()
    
    def send(self): #è‡ªå®šä¹‰å‘é€çš„æ–¹å¼
        input_data = input('è¯·è¾“å…¥å‘é€çš„æ•°æ®:')
        if input_data:
            self.transport.write(input_data.encode('utf-8'))
        else:
            self.transport.loseConnection() #å¦‚æœæ²¡æœ‰æ•°æ®å‘é€å°±å…³é—­è¿æ¥
    def dataReceived(self, data: bytes): #æ¥æ”¶æœåŠ¡ç«¯çš„æ•°æ®
        print(data.decode('utf-8'))
        self.send() #è¿›è¡Œä¸‹ä¸€æ¬¡æ•°æ®å‘é€
        return super().dataReceived(data)
    
class DefaultClientfactory(twisted.internet.protocol.ClientFactory):
    protocol = Client
    #å¦‚æœè¿æ¥æ–­å¼€ å°±åœæ­¢reactorçš„å¾ªç¯
    clientConnectLost = clientCOnnectionFailed = lambda self, connector,reason : twisted.internet.reactor.stop()

def main():
    twisted.internet.reactor.connectTCP(SERVER_HOST,SERVER_PORT,DefaultClientfactory()) #æœåŠ¡ç›‘å¬
    twisted.internet.reactor.run() #å¯åŠ¨reactorå¾ªç¯

if __name__ == '__main__':
    main()
</code></pre>
<p>æ•´ä¸ªæ¡†æ¶è¿˜æ˜¯å¤„äºä¸€ä¸ªæ¨¡ç³ŠçŠ¶æ€ï¼Œä½†æ˜¯å¯¹twistedçš„äº‹ä»¶è½®è¯¢æœºåˆ¶è¿˜æ˜¯æœ‰äº†ä¸€ç‚¹æ¸…æ¥šçš„è®¤çŸ¥ã€‚<br>
æˆ‘çš„ç†è§£:</p>
<blockquote>
<p>å°†æ•°æ®çš„å¤„ç†å’Œæ•°æ®çš„æ¥æ”¶å‘é€ã€æœåŠ¡å™¨çš„è¿æ¥è¿™ä¸¤ä¸ªéƒ¨åˆ†å‰¥ç¦»å¼€ã€‚åœ¨reactorä¸­å¦‚æœæ¥æ”¶åˆ°ä¸€ä¸ªä¿¡æ¯ï¼Œé‚£ä¹ˆå°±ä¼šè°ƒç”¨åˆ°twistedå¾ªç¯ä¸­çš„æŸä¸ªå¤„ç†ç¨‹åºï¼Œç„¶åå¤„ç†å®Œæˆä¹‹åå°†æ•°æ®è¿”å›ç»™reactorè¿›è¡Œå‘é€ï¼Œç„¶åtwistedäº‹ä»¶å°±ä¼šç»§ç»­å¾ªç¯ã€‚ç›¸å½“äºå°†ä¸€ä¸ªsocketè¿›ç¨‹ä¸­çš„accept()é˜»å¡å’Œå®é™…çš„å¤„ç†å‰¥ç¦»å¼€ï¼Œè®©å¤„ç†ç¨‹åºä¸å—åˆ°é˜»å¡ç¨‹åºçš„å½±å“ï¼Œå› æ­¤å¯ä»¥åœ¨ä¸€ä¸ªè¿›ç¨‹ä¸­é«˜æ•ˆçš„å¤„ç†å¤šä¸ªå®¢æˆ·ç«¯çš„è¿æ¥ï¼ŒèŠ‚çœäº†æœåŠ¡å™¨çš„èµ„æºã€‚<br>
ï¼ˆæœ‰ç‚¹åƒä¸¤ä¸ªåœˆï¼Œreactorä¸€ä¸ªåœˆï¼Œtwistedä¸€ä¸ªåœˆï¼Œå½“é‡åˆ°æ•°æ®éœ€è¦å¤„ç†çš„æ—¶å€™ä¸¤ä¸ªåœˆå°±ä¼šè¿ä¸€æ¡çº¿ï¼Œå¤„ç†å®Œä¹‹åå°±æŠŠçº¿æ“¦å»ï¼‰</p>
</blockquote>
<h1 id="-7">=&gt;</h1>
<p>æš‚æ—¶å…ˆåˆ°è¿™é‡Œï¼Œåé¢è¿˜æœ‰twistedçš„UDPå®¢æˆ·ç«¯å¼€å‘ä»¥åŠdeferredçš„æ¦‚å¿µã€‚ -- 2023-06-26</p>
<p>deferred</p>

              </div>
              <div class="toc-container">
                <ul class="markdownIt-TOC">
<li><a href="#">=&gt;</a></li>
<li><a href="#-2">=&gt;</a></li>
<li><a href="#-3">=&gt;</a></li>
<li><a href="#-4">=&gt;</a></li>
<li><a href="#-5">=&gt;</a></li>
<li><a href="#-6">=&gt;</a></li>
<li><a href="#-7">=&gt;</a></li>
</ul>

              </div>
            </div>
          </article>
        </div>

        
          <div class="next-post">
            <div class="next">ä¸‹ä¸€ç¯‡</div>
            <a href="https://cyanineeee.github.io/post/python-wang-luo-bian-cheng/">
              <h3 class="post-title">
                pythonç½‘ç»œç¼–ç¨‹ -- å»ºç«‹ä¸€ä¸ªhttpæœåŠ¡å™¨+twistedæ¨¡å—--part.1
              </h3>
            </a>
          </div>
        

        

        <div class="site-footer">
  Powered by <a href="https://github.com/getgridea/gridea" target="_blank">Gridea</a>
  <a class="rss" href="https://cyanineeee.github.io/atom.xml" target="_blank">
    <i class="ri-rss-line"></i> RSS
  </a>
</div>

      </div>
    </div>

    <script>
      hljs.initHighlightingOnLoad()

      let mainNavLinks = document.querySelectorAll(".markdownIt-TOC a");

      // This should probably be throttled.
      // Especially because it triggers during smooth scrolling.
      // https://lodash.com/docs/4.17.10#throttle
      // You could do like...
      // window.addEventListener("scroll", () => {
      //    _.throttle(doThatStuff, 100);
      // });
      // Only not doing it here to keep this Pen dependency-free.

      window.addEventListener("scroll", event => {
        let fromTop = window.scrollY;

        mainNavLinks.forEach((link, index) => {
          let section = document.getElementById(decodeURI(link.hash).substring(1));
          let nextSection = null
          if (mainNavLinks[index + 1]) {
            nextSection = document.getElementById(decodeURI(mainNavLinks[index + 1].hash).substring(1));
          }
          if (section.offsetTop <= fromTop) {
            if (nextSection) {
              if (nextSection.offsetTop > fromTop) {
                link.classList.add("current");
              } else {
                link.classList.remove("current");    
              }
            } else {
              link.classList.add("current");
            }
          } else {
            link.classList.remove("current");
          }
        });
      });

    </script>
  </body>
</html>
