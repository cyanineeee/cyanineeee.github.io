<html>
  <head>
    <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>scrapy itemèµ‹å€¼/å¡«å…… ç»†èŠ‚æ³¨æ„ | cyanine</title>
<link rel="shortcut icon" href="https://cyanineeee.github.io/favicon.ico?v=1727687297417">
<link href="https://cdn.jsdelivr.net/npm/remixicon@2.3.0/fonts/remixicon.css" rel="stylesheet">
<link rel="stylesheet" href="https://cyanineeee.github.io/styles/main.css">
<link rel="alternate" type="application/atom+xml" title="scrapy itemèµ‹å€¼/å¡«å…… ç»†èŠ‚æ³¨æ„ | cyanine - Atom Feed" href="https://cyanineeee.github.io/atom.xml">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Droid+Serif:400,700">



    <meta name="description" content="1.  èµ·å› 
æˆ‘åœ¨çˆ¬å–åˆ°å¾®åšçƒ­æœçš„jsonæ•°æ®ä¹‹åï¼Œå‘æ— è®ºå¦‚ä½•éƒ½ä¼šæŠ¥é”™æ•°æ®åº“å­—æ®µæ–¹é¢çš„é—®é¢˜ï¼Œå…·ä½“æŠ¥é”™å¦‚ä¸‹ï¼š
Traceback (most recent call last):
  File &quot;D:\anaconda\envs\D..." />
    <meta name="keywords" content="" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">
    <script src="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.5.1/build/highlight.min.js"></script>
  </head>
  <body>
    <div class="main">
      <div class="main-content">
        <div class="site-header">
  <a href="https://cyanineeee.github.io">
  <img class="avatar" src="https://cyanineeee.github.io/images/avatar.png?v=1727687297417" alt="">
  </a>
  <h1 class="site-title">
    cyanine
  </h1>
  <p class="site-description">
    my personal blog
  </p>
  <div class="menu-container">
    
      
        <a href="/" class="menu">
          Home Page
        </a>
      
    
      
        <a href="/archives" class="menu">
          Archive
        </a>
      
    
      
        <a href="/tags" class="menu">
          Tags
        </a>
      
    
      
        <a href="/post/about" class="menu">
          About
        </a>
      
    
  </div>
  <div class="social-container">
    
      
    
      
    
      
    
      
    
      
    
  </div>
</div>

        <div class="post-detail">
          <article class="post">
            <h2 class="post-title">
              scrapy itemèµ‹å€¼/å¡«å…… ç»†èŠ‚æ³¨æ„
            </h2>
            <div class="post-info">
              <span>
                2023-06-16
              </span>
              <span>
                6 min read
              </span>
              
            </div>
            
            <div class="post-content-wrapper">
              <div class="post-content" v-pre>
                <h2 id="1-èµ·å› ">1.  èµ·å› </h2>
<p>æˆ‘åœ¨çˆ¬å–åˆ°å¾®åšçƒ­æœçš„jsonæ•°æ®ä¹‹åï¼Œå‘æ— è®ºå¦‚ä½•éƒ½ä¼šæŠ¥é”™æ•°æ®åº“å­—æ®µæ–¹é¢çš„é—®é¢˜ï¼Œå…·ä½“æŠ¥é”™å¦‚ä¸‹ï¼š</p>
<pre><code>Traceback (most recent call last):
  File &quot;D:\anaconda\envs\DjangoEnv\Lib\site-packages\twisted\internet\defer.py&quot;, line 892, in _runCallbacks
    current.result = callback(  # type: ignore[misc]
  File &quot;D:\anaconda\envs\DjangoEnv\Lib\site-packages\scrapy\utils\defer.py&quot;, line 307, in f
    return deferred_from_coro(coro_f(*coro_args, **coro_kwargs))
  File &quot;D:\Aproject\django-project\project5-scrapy-tutorial\project_2\tutorial\tutorial\pipelines.py&quot;, line 46, in process_item    
    self.db[collection_name].insert_one(dict(hot))
ValueError: dictionary update sequence element #0 has length 1; 2 is required
</code></pre>
<p>å…·ä½“çš„åŸå› ä¸€ç›´ä¸æ¸…æ¥šï¼Œåªèƒ½æ¨¡ç³Šçš„çŒœæµ‹å®åœ¨å‘æ•°æ®åº“å¯¼å…¥æ•°æ®çš„æ—¶å€™ï¼Œå› ä¸ºæ ¼å¼çš„åŸå› å‡ºé”™äº†ï¼Œä½†å…·ä½“æ˜¯ä»€ä¹ˆåŸå› ï¼Œæˆ‘æŠŠä»£ç çœ‹äº†ä¸€éåˆä¸€éæ€ä¹ˆä¹Ÿæ‰¾ä¸å‡ºæ¥å“ªé‡Œé”™äº†ã€‚çŒœæµ‹å¯èƒ½æ˜¯çˆ¬å–çš„jsonæ•°æ®è§£æé”™è¯¯ï¼Œæ‰€ä»¥å°†jsonæ•°æ®ä¸‹è½½åˆ°æ–‡ä»¶ä¸­ï¼Œç„¶ååœ¨jupyterä¸­ä¸æ–­è°ƒè¯•ä¸æ–­æ‰¾ï¼Œçœ‹çœ‹æˆ‘æ˜¯æŠŠé‚£ä¸ªæ‹¬å·ç»™æ¼äº†ğŸ˜¡ã€‚<br>
æœ€åå®åœ¨æ˜¯æ‰¾ä¸åˆ°äº†ï¼Œæƒ³ç€æ˜¯ä¸æ˜¯å¯ä»¥é€šè¿‡è°ƒè¯•ä¸€æ­¥ä¸€æ­¥çš„åˆ¤æ–­å“ªé‡Œå‡ºé”™äº†ï¼Œä½†æ˜¯æˆ‘æ²¡æœ‰åœ¨scrapyçš„æ–‡æ¡£ä¸­æ‰¾åˆ°å…³äºpipelineçš„è°ƒè¯•æ–¹æ³•ï¼ˆåªæœ‰å…³äºspiderçš„ï¼‰ï¼Œæœ€ååœ¨çŸ¥ä¹ä¸Šä¸€ç¯‡æ–‡ç« æ‰¾åˆ°äº†æ–¹æ³•ï¼Œ<a href="https://zhuanlan.zhihu.com/p/25200262">å‚è€ƒé“¾æ¥</a>ï¼Œä½†æ˜¯ä½œè€…çš„æ–¹æ³•åœ¨æˆ‘ï¼ˆwindows11+vscï¼‰è¿è¡Œä¹‹åä¼šæŠ¥é”™ï¼Œä¹‹åå‚è€ƒäº†è¯„è®ºåŒºçš„æ–¹æ³•ï¼Œåœ¨å’Œ<code>scrapy.cfg</code>åŒä¸€å±‚ï¼ˆé¡¹ç›®æ ¹ç›®å½•ä¸­ï¼‰ä¸­å»ºç«‹<code>run.py</code>æ–‡ä»¶ï¼Œè¾“å…¥ä»¥ä¸‹ä»£ç ï¼Œå†åœ¨é¡¹ç›®ä¸­è®¾ç½®æ–­ç‚¹ï¼Œç„¶ådebugæ–‡ä»¶<code>run.py</code>ï¼Œå°±å¯ä»¥å®ç°è°ƒè¯•çš„åŠŸèƒ½ã€‚</p>
<blockquote>
<p>å…·ä½“ä»£ç ï¼š</p>
</blockquote>
<pre><code class="language-python">import os
from scrapy.cmdline import execute
os.chdir(os.path.dirname(os.path.realpath(__file__)))
try:
    execute(
    [
    'scrapy',
    'crawl',
    'weibo', #è¿™é‡Œæ¢æˆå¯¹åº”çš„spideråå­—
    '-o',
    'out.json',
    ]
    )
except SystemExit:
    pass    
</code></pre>
<h2 id="2-è°ƒè¯•ä¹‹å">2.  è°ƒè¯•ä¹‹å</h2>
<p>åœ¨è°ƒè¯•ä¹‹åï¼Œæˆ‘å‘ç°<code>pipeline.py</code>æ–‡ä»¶ä¸­å¯¹åº”classç±»ä¸­çš„<code>process_item()</code>æ–¹æ³•ä¸­çš„<code>item</code>å˜é‡å¹¶ä¸æ˜¯æˆ‘æƒ³è±¡ä¸­çš„æ˜¯ä¸€ä¸ªç”±å­—å…¸å…ƒç´ ç»„æˆçš„åˆ—è¡¨ï¼Œè€Œæ˜¯ä¸€ä¸ªå­—å…¸ï¼Œå¹¶ä¸”keyæ˜¯åœ¨<code>item.py</code>æ–‡ä»¶ä¸­è®¾å®šçš„ï¼Œvalueæ˜¯åœ¨<code>parse()</code>æ–¹æ³•ä¸­èµ‹å€¼çš„ã€æˆ‘æƒ³è¦çš„å­—å…¸å…ƒç´ åˆ—è¡¨ã€‚ç»ˆäºç¡®å®šçš„åŸå› ï¼Œå› æ­¤ä¿®æ”¹ä¹Ÿå¾ˆç®€å•ã€‚</p>
<h2 id="3-ä¿®æ”¹">3. ä¿®æ”¹</h2>
<p>å°†åŸæœ¬çš„<code>process_item()</code>æ–¹æ³•ä¿®æ”¹å³å¯</p>
<pre><code class="language-python">def process_item(self,item,spider):
    now = datetime.datetime.now() #ä»¥å½“å‰äº‹ä»¶ä½œä¸ºcollectionçš„åå­—
    collection_name = datetime.datetime.strftime(now,'%Y-%m-%d:%H:%M:%S')

    #åŸæ¥é”™è¯¯çš„ï¼š 
    #for hot in item:  -&gt;ä¿®æ”¹ä¸ºä¸‹é¢çš„éƒ¨åˆ†
    for hot in item['realtime']: 
        self.db[collection_name].insert_one(dict(hot))
    return item
</code></pre>
<h2 id="4-æ¢ç©¶åŸå› ">4. æ¢ç©¶åŸå› </h2>
<p><a href="https://docs.scrapy.org/en/latest/topics/items.html#item-types">å®˜æ–¹æ–‡æ¡£</a><br>
é¦–å…ˆï¼Œå¼€å‘è€…ä¸ºäº†æ–¹ä¾¿åœ¨pythonä¸­å¤„ç†çˆ¬åˆ°çš„webæ•°æ®ï¼Œå› æ­¤å°†itemç±»è®¾è®¡ä¸ºç±»å­—å…¸ç»“æ„ï¼Œå¹¶ä¸”å®Œå…¨copyäº†pythonä¸­dictçš„apiï¼ˆcvå¤§æ³•å¥½ğŸ˜‹ï¼‰</p>
<blockquote>
<p><strong>Item objects replicate the standard dict API, including its __init__ method.</strong></p>
</blockquote>
<p>å› æ­¤å®é™…ä¸Šï¼Œitemç±»å°±æ˜¯ä¸€ä¸ªåœ¨scrapyä¸­çš„spider, pipelineä¹‹é—´è¿›è¡Œæ•°æ®äº¤æ¢çš„å­—å…¸ç±»ã€‚ä»–çš„æµç¨‹å°±æ˜¯ï¼š<br>
ç¬¬ä¸€æ­¥ï¼Œåœ¨<code>item.py</code>æ–‡ä»¶ä¸­è®¾å®šitemçš„keyå€¼ï¼›<br>
ç¬¬äºŒéƒ¨ï¼Œåœ¨spiderä¸­çš„<code>parse</code>æ–¹æ³•ä¸­è¢«è§£æå¥½çš„ç½‘é¡µæ•°æ®å¡«å……value;<br>
ç¬¬ä¸‰æ­¥ï¼Œé€šè¿‡pipelineä¿å­˜æˆä¸ºæ–‡ä»¶/ä¿å­˜åˆ°æ•°æ®åº“ç­‰</p>
<p>è¯¦ç»†çš„ä¾‹å­å¦‚ä¸‹ï¼š<br>
4.1 åœ¨items.pyä¸­è§„å®šä¸€ä¸ªç±»ï¼Œå¦‚ä¸‹ï¼š</p>
<pre><code class="language-python">class Example(scrapy.Item): #å¿…é¡»ç»§æ‰¿scrapy.Item æ‰èƒ½ä½¿ç”¨å¯¹åº”çš„api
    realtime = scrapy.Field() 
</code></pre>
<blockquote>
<p>è¿™é‡Œçš„Field()çš„ä½œç”¨<br>
PS.<a href="https://docs.scrapy.org/en/latest/topics/items.html#scrapy.item.scrapy.Field">å®˜æ–¹æ–‡æ¡£</a><br>
&quot; The Field class is just an alias to the built-in dict class and doesnâ€™t provide any extra functionality or attributes.&quot; è¡¨æ˜Fieldç±»ä¹‹é™…ä¸Šåªæ˜¯pythonå†…ç½®å­—å…¸çš„åˆ«åï¼Œæ²¡æœ‰å…¶ä»–ä»»ä½•åˆ«çš„ä½œç”¨ï¼ˆ<a href="https://www.cnblogs.com/fengf233/p/11298623.html#2.field()%E7%B1%BB">Field()æºç è§£æ</a>ï¼‰ï¼Œå½“ç„¶å¤æ‚çš„è€Œæ˜¯itemå¦‚ä½•ï¼ˆè¯´å®è¯æ²¡çœ‹æ‡‚ğŸ˜µ<a href="https://www.cnblogs.com/twelfthing/articles/4709287.html">itemæºç è§£æ</a>ï¼‰ã€‚<br>
å½“ç„¶ä¹Ÿå¯ä»¥é‡å†™<code>Overriding the serialize_field() method</code>æ–¹æ³•ï¼Œå»è§„å®šå…·ä½“çš„æ•°æ®ç±»å‹ï¼ˆ<a href="https://docs.scrapy.org/en/latest/topics/exporters.html#overriding-the-serialize-field-method">å…·ä½“å‚è€ƒå®˜æ–¹æ–‡æ¡£</a>ï¼‰<br>
æ•´ä¸ªitemç±»çš„ä½¿ç”¨éå¸¸ç±»ä¼¼ä¸Djangoçš„Formç±»ï¼Œä¸è¿‡Field()è§„å®šçš„å­—æ®µç±»å‹æ˜¯è¿œè¿œç®€å•ä¸Djangoçš„ã€‚</p>
</blockquote>
<p>4.2 ç„¶åå†spiderä¸­æˆ‘çˆ¬å–åˆ°çš„æ˜¯ä¸€ä¸ªjsonæ•°æ®ï¼Œä¾‹å¦‚</p>
<pre><code class="language-json">{
&quot;ok&quot;: 1,
    &quot;data&quot;: {
        &quot;realtime&quot;: [
                {
                &quot;star_name&quot;: {},
                &quot;word_scheme&quot;: &quot;#æ–°é—»æ ‡é¢˜#&quot;,
                &quot;emoticon&quot;: &quot;&quot;,
            }
        ]}
}
</code></pre>
<p>4.3 ç„¶åæˆ‘åœ¨å¯¹item.pyæ–‡ä»¶ä¸­çš„ç±»è¿›è¡Œå¡«å……ï¼Œå¦‚ä¸‹ï¼š</p>
<pre><code class="language-python">class ExampleSpider(scrapy.Spider):
    ...#ç•¥
    def parse(self, response):
            jsondata = json.loads(response.text)          #ä½¿ç”¨scrapyä¸­responseå±æ€§textå°†çˆ¬å–åˆ°çš„ç½‘é¡µè§£æä¸ºstrï¼Œç„¶åä½¿ç”¨json.loadsæ–¹æ³•è½¬åŒ–ä¸ºå­—å…¸æ ¼å¼
            realtime = jsondata['data']['realtime'] #æå–çƒ­æœæ•°æ®åˆ—è¡¨
            item = Example() #å®ä¾‹åŒ–item
            item['realtime'] = realtime
            return item
</code></pre>
<p>è¿™é‡Œéœ€è¦é‡ç‚¹æ³¨æ„<code> item['realtime'] = realtime</code>ï¼Œè™½ç„¶åœ¨ä¹‹å‰å·²ç»å°†realtimeåˆ—è¡¨æå–å‡ºæ¥ï¼Œä½†æ˜¯åœ¨å¡«å……çš„æ—¶å€™ï¼Œä¼ å…¥pipelineä¸­è¿›è¡Œå‚¨å­˜çš„å®é™…ä¸Šæ˜¯ä¸€ä¸ªitemå­—å…¸ï¼Œå­—å…¸keyæ˜¯åœ¨item.pyæ–‡ä»¶ä¸­å®šä¹‰çš„å±æ€§ï¼Œå­—å…¸valueæ˜¯åœ¨parseæ–¹æ³•ä¸­å¡«å……çš„å¯¹è±¡ã€‚æ‰€ä»¥å®é™…ä¸Šä¼ å…¥åˆ°pipelineæ¨¡å—ä¸­çš„itemç»“æ„æ˜¯å¦‚ä¸‹ï¼š</p>
<pre><code class="language-json">{ 
    'realtime': [{
        &quot;star_name&quot;: {},
        &quot;word_scheme&quot;: &quot;#æ–°é—»æ ‡é¢˜#&quot;,
        &quot;emoticon&quot;: &quot;&quot;,
    },
    ]
}
</code></pre>
<p>4.4 ä¹Ÿå°±æ˜¯æ„å‘³ç€ï¼Œå¦‚æœä½ åœ¨pipeline.pyæ–‡ä»¶çš„å¯¹åº”ç±»ä¸­çš„process_itemæ–¹æ³•ä¸­ï¼Œå¦‚æœéœ€è¦ç”¨åˆ°åŸæœ¬çš„åˆ—è¡¨ï¼Œé¦–å…ˆä»itemå­—å…¸ä¸­æå–å‡ºæ¥ï¼Œå…·ä½“å¦‚ä¸‹ï¼š</p>
<pre><code class="language-python">    def process_item(self,item,spider):
            #....
        for hot in item['realtime']:
            #....
        return item
</code></pre>

              </div>
              <div class="toc-container">
                <ul class="markdownIt-TOC">
<li>
<ul>
<li><a href="#1-%E8%B5%B7%E5%9B%A0">1.  èµ·å› </a></li>
<li><a href="#2-%E8%B0%83%E8%AF%95%E4%B9%8B%E5%90%8E">2.  è°ƒè¯•ä¹‹å</a></li>
<li><a href="#3-%E4%BF%AE%E6%94%B9">3. ä¿®æ”¹</a></li>
<li><a href="#4-%E6%8E%A2%E7%A9%B6%E5%8E%9F%E5%9B%A0">4. æ¢ç©¶åŸå› </a></li>
</ul>
</li>
</ul>

              </div>
            </div>
          </article>
        </div>

        
          <div class="next-post">
            <div class="next">ä¸‹ä¸€ç¯‡</div>
            <a href="https://cyanineeee.github.io/post/requestspost-he-requestssessionpost-fang-fa-de-qu-bie/">
              <h3 class="post-title">
                requests.postå’Œrequests.session.postæ–¹æ³•çš„åŒºåˆ«
              </h3>
            </a>
          </div>
        

        

        <div class="site-footer">
  Powered by <a href="https://github.com/getgridea/gridea" target="_blank">Gridea</a>
  <a class="rss" href="https://cyanineeee.github.io/atom.xml" target="_blank">
    <i class="ri-rss-line"></i> RSS
  </a>
</div>

      </div>
    </div>

    <script>
      hljs.initHighlightingOnLoad()

      let mainNavLinks = document.querySelectorAll(".markdownIt-TOC a");

      // This should probably be throttled.
      // Especially because it triggers during smooth scrolling.
      // https://lodash.com/docs/4.17.10#throttle
      // You could do like...
      // window.addEventListener("scroll", () => {
      //    _.throttle(doThatStuff, 100);
      // });
      // Only not doing it here to keep this Pen dependency-free.

      window.addEventListener("scroll", event => {
        let fromTop = window.scrollY;

        mainNavLinks.forEach((link, index) => {
          let section = document.getElementById(decodeURI(link.hash).substring(1));
          let nextSection = null
          if (mainNavLinks[index + 1]) {
            nextSection = document.getElementById(decodeURI(mainNavLinks[index + 1].hash).substring(1));
          }
          if (section.offsetTop <= fromTop) {
            if (nextSection) {
              if (nextSection.offsetTop > fromTop) {
                link.classList.add("current");
              } else {
                link.classList.remove("current");    
              }
            } else {
              link.classList.add("current");
            }
          } else {
            link.classList.remove("current");
          }
        });
      });

    </script>
  </body>
</html>
